<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FeatureExtractor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Stanford CoreNLP</a> &gt; <a href="index.source.html" class="el_package">edu.stanford.nlp.coref.statistical</a> &gt; <span class="el_source">FeatureExtractor.java</span></div><h1>FeatureExtractor.java</h1><pre class="source lang-java linenums">package edu.stanford.nlp.coref.statistical;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.Random;
import java.util.Set;

import edu.stanford.nlp.coref.CorefProperties;
import edu.stanford.nlp.coref.CorefRules;
import edu.stanford.nlp.coref.CorefUtils;
import edu.stanford.nlp.coref.data.CorefCluster;
import edu.stanford.nlp.coref.data.Dictionaries;
import edu.stanford.nlp.coref.data.Dictionaries.MentionType;
import edu.stanford.nlp.coref.data.Dictionaries.Number;
import edu.stanford.nlp.coref.data.Dictionaries.Person;
import edu.stanford.nlp.coref.data.Document;
import edu.stanford.nlp.coref.data.Document.DocType;
import edu.stanford.nlp.coref.data.Mention;
import edu.stanford.nlp.coref.md.RuleBasedCorefMentionFinder;
import edu.stanford.nlp.io.IOUtils;
import edu.stanford.nlp.ling.CoreAnnotations;
import edu.stanford.nlp.ling.CoreAnnotations.SpeakerAnnotation;
import edu.stanford.nlp.ling.CoreLabel;
import edu.stanford.nlp.ling.IndexedWord;
import edu.stanford.nlp.semgraph.SemanticGraphEdge;
import edu.stanford.nlp.stats.ClassicCounter;
import edu.stanford.nlp.stats.Counter;
import edu.stanford.nlp.trees.Tree;
import edu.stanford.nlp.util.Pair;
import edu.stanford.nlp.util.StringUtils;

/**
 * A class for featurizing mention pairs and individual mentions.
 *
 * @author Kevin Clark
 */
<span class="nc bnc" id="L42" title="All 2 branches missed.">public class FeatureExtractor {</span>

  private static final int MIN_WORD_COUNT = 20;
  private static final int BIN_EXACT = 10;
  private static final double BIN_EXPONENT = 1.5;
<span class="nc" id="L47">  private static final Map&lt;Integer, String&gt; SINGLETON_FEATURES = new HashMap&lt;&gt;();</span>
  static {
<span class="nc" id="L49">    SINGLETON_FEATURES.put(2, &quot;animacy&quot;);</span>
<span class="nc" id="L50">    SINGLETON_FEATURES.put(3, &quot;person-coarse&quot;);</span>
<span class="nc" id="L51">    SINGLETON_FEATURES.put(4, &quot;number&quot;);</span>
<span class="nc" id="L52">    SINGLETON_FEATURES.put(5, &quot;position&quot;);</span>
<span class="nc" id="L53">    SINGLETON_FEATURES.put(6, &quot;relation&quot;);</span>
<span class="nc" id="L54">    SINGLETON_FEATURES.put(7, &quot;quantification&quot;);</span>
<span class="nc" id="L55">    SINGLETON_FEATURES.put(8, &quot;modifiers&quot;);</span>
<span class="nc" id="L56">    SINGLETON_FEATURES.put(9, &quot;negation&quot;);</span>
<span class="nc" id="L57">    SINGLETON_FEATURES.put(10, &quot;modal&quot;);</span>
<span class="nc" id="L58">    SINGLETON_FEATURES.put(11, &quot;attitude&quot;);</span>
<span class="nc" id="L59">    SINGLETON_FEATURES.put(12, &quot;coordination&quot;);</span>
  }

  private final Dictionaries dictionaries;
  private final Set&lt;String&gt; vocabulary;
  private final Compressor&lt;String&gt; compressor;
  private final boolean useConstituencyParse;
  private final boolean useDocSource;

  public FeatureExtractor(Properties props, Dictionaries dictionaries,
      Compressor&lt;String&gt; compressor) {
<span class="nc" id="L70">    this(props, dictionaries, compressor, StatisticalCorefTrainer.wordCountsFile);</span>
<span class="nc" id="L71">  }</span>

  public FeatureExtractor(Properties props, Dictionaries dictionaries,
      Compressor&lt;String&gt; compressor, String wordCountsPath) {
<span class="nc" id="L75">    this(props, dictionaries, compressor, loadVocabulary(wordCountsPath));</span>
<span class="nc" id="L76">  }</span>

  public FeatureExtractor(Properties props, Dictionaries dictionaries,
<span class="nc" id="L79">      Compressor&lt;String&gt; compressor, Set&lt;String&gt; vocabulary) {</span>
<span class="nc" id="L80">    this.dictionaries = dictionaries;</span>
<span class="nc" id="L81">    this.compressor = compressor;</span>
<span class="nc" id="L82">    this.vocabulary = vocabulary;</span>
<span class="nc" id="L83">    this.useDocSource = CorefProperties.conll(props);</span>
<span class="nc" id="L84">    this.useConstituencyParse = CorefProperties.useConstituencyParse(props);</span>
<span class="nc" id="L85">  }</span>

  private static Set&lt;String&gt; loadVocabulary(String wordCountsPath) {
<span class="nc" id="L88">    Set&lt;String&gt; vocabulary = new HashSet&lt;&gt;();</span>
    try {
<span class="nc" id="L90">      Counter&lt;String&gt; counts = IOUtils.readObjectFromURLOrClasspathOrFileSystem(wordCountsPath);</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">      for (Map.Entry&lt;String, Double&gt; e : counts.entrySet()) {</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (e.getValue() &gt; MIN_WORD_COUNT) {</span>
<span class="nc" id="L93">          vocabulary.add(e.getKey());</span>
        }
<span class="nc" id="L95">      }</span>
<span class="nc" id="L96">    } catch (Exception e) {</span>
<span class="nc" id="L97">      throw new RuntimeException(&quot;Error loading word counts&quot;, e);</span>
<span class="nc" id="L98">    }</span>
<span class="nc" id="L99">    return vocabulary;</span>
  }

  public DocumentExamples extract(int id, Document document,
      Map&lt;Pair&lt;Integer, Integer&gt;, Boolean&gt; labeledPairs) {
<span class="nc" id="L104">    return extract(id, document, labeledPairs, compressor);</span>
  }

  public DocumentExamples extract(int id, Document document,
      Map&lt;Pair&lt;Integer, Integer&gt;, Boolean&gt; labeledPairs, Compressor&lt;String&gt; compressor) {
<span class="nc" id="L109">    List&lt;Mention&gt; mentionsList = CorefUtils.getSortedMentions(document);</span>
<span class="nc" id="L110">    Map&lt;Integer, List&lt;Mention&gt;&gt; mentionsByHeadIndex = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">    for (Mention m : mentionsList) {</span>
<span class="nc" id="L112">      List&lt;Mention&gt; withIndex = mentionsByHeadIndex.get(m.headIndex);</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">      if (withIndex == null) {</span>
<span class="nc" id="L114">        withIndex = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L115">        mentionsByHeadIndex.put(m.headIndex, withIndex);</span>
      }
<span class="nc" id="L117">      withIndex.add(m);</span>
<span class="nc" id="L118">    }</span>

<span class="nc" id="L120">    Map&lt;Integer, Mention&gt; mentions = document.predictedMentionsByID;</span>
<span class="nc" id="L121">    List&lt;Example&gt; examples = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L122">    Set&lt;Integer&gt; mentionsToExtract = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">    for (Map.Entry&lt;Pair&lt;Integer, Integer&gt;, Boolean&gt; pair : labeledPairs.entrySet()) {</span>
<span class="nc" id="L124">        Mention m1 = mentions.get(pair.getKey().first);</span>
<span class="nc" id="L125">        Mention m2 = mentions.get(pair.getKey().second);</span>
<span class="nc" id="L126">        mentionsToExtract.add(m1.mentionID);</span>
<span class="nc" id="L127">        mentionsToExtract.add(m2.mentionID);</span>
<span class="nc" id="L128">        CompressedFeatureVector features =</span>
<span class="nc" id="L129">            compressor.compress(getFeatures(document, m1, m2));</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        examples.add(new Example(id, m1, m2, pair.getValue() ? 1.0 : 0.0, features));</span>
<span class="nc" id="L131">    }</span>

<span class="nc" id="L133">    Map&lt;Integer, CompressedFeatureVector&gt; mentionFeatures = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">    for (int mentionID : mentionsToExtract) {</span>
<span class="nc" id="L135">        mentionFeatures.put(mentionID, compressor.compress(getFeatures(document,</span>
<span class="nc" id="L136">            document.predictedMentionsByID.get(mentionID), mentionsByHeadIndex)));</span>
<span class="nc" id="L137">    }</span>

<span class="nc" id="L139">    return new DocumentExamples(id, examples, mentionFeatures);</span>
  }

  private Counter&lt;String&gt; getFeatures(Document doc, Mention m,
      Map&lt;Integer, List&lt;Mention&gt;&gt; mentionsByHeadIndex) {
<span class="nc" id="L144">    Counter&lt;String&gt; features = new ClassicCounter&lt;&gt;();</span>

    // type features
<span class="nc" id="L147">    features.incrementCount(&quot;mention-type=&quot; + m.mentionType);</span>
<span class="nc" id="L148">    features.incrementCount(&quot;gender=&quot; + m.gender);</span>
<span class="nc" id="L149">    features.incrementCount(&quot;person-fine=&quot; + m.person);</span>
<span class="nc" id="L150">    features.incrementCount(&quot;head-ne-type=&quot; + m.nerString);</span>
<span class="nc" id="L151">    List&lt;String&gt; singletonFeatures = m.getSingletonFeatures(dictionaries);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">    for (Map.Entry&lt;Integer, String&gt; e : SINGLETON_FEATURES.entrySet()) {</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">      if (e.getKey() &lt; singletonFeatures.size()) {</span>
<span class="nc" id="L154">        features.incrementCount(e.getValue() + &quot;=&quot; + singletonFeatures.get(e.getKey()));</span>
      }
<span class="nc" id="L156">    }</span>

    // length and location features
<span class="nc" id="L159">    addNumeric(features, &quot;mention-length&quot;, m.spanToString().length());</span>
<span class="nc" id="L160">    addNumeric(features, &quot;mention-words&quot;, m.originalSpan.size());</span>
<span class="nc" id="L161">    addNumeric(features, &quot;sentence-words&quot;, m.sentenceWords.size());</span>
<span class="nc" id="L162">    features.incrementCount(&quot;sentence-words=&quot; + bin(m.sentenceWords.size()));</span>
<span class="nc" id="L163">    features.incrementCount(&quot;mention-position&quot;, m.mentionNum</span>
<span class="nc" id="L164">        / (double) doc.predictedMentions.size());</span>
<span class="nc" id="L165">    features.incrementCount(&quot;sentence-position&quot;, m.sentNum / (double) doc.numSentences);</span>

    // lexical features
<span class="nc" id="L168">    CoreLabel firstWord = firstWord(m);</span>
<span class="nc" id="L169">    CoreLabel lastWord = lastWord(m);</span>
<span class="nc" id="L170">    CoreLabel headWord = headWord(m);</span>
<span class="nc" id="L171">    CoreLabel prevWord = prevWord(m);</span>
<span class="nc" id="L172">    CoreLabel nextWord = nextWord(m);</span>
<span class="nc" id="L173">    CoreLabel prevprevWord = prevprevWord(m);</span>
<span class="nc" id="L174">    CoreLabel nextnextWord = nextnextWord(m);</span>
<span class="nc" id="L175">    String headPOS = getPOS(headWord);</span>
<span class="nc" id="L176">    String firstPOS = getPOS(firstWord);</span>
<span class="nc" id="L177">    String lastPOS = getPOS(lastWord);</span>
<span class="nc" id="L178">    String prevPOS = getPOS(prevWord);</span>
<span class="nc" id="L179">    String nextPOS = getPOS(nextWord);</span>
<span class="nc" id="L180">    String prevprevPOS = getPOS(prevprevWord);</span>
<span class="nc" id="L181">    String nextnextPOS = getPOS(nextnextWord);</span>
<span class="nc" id="L182">    features.incrementCount(&quot;first-word=&quot; + wordIndicator(firstWord, firstPOS));</span>
<span class="nc" id="L183">    features.incrementCount(&quot;last-word=&quot; + wordIndicator(lastWord, lastPOS));</span>
<span class="nc" id="L184">    features.incrementCount(&quot;head-word=&quot; + wordIndicator(headWord, headPOS));</span>
<span class="nc" id="L185">    features.incrementCount(&quot;next-word=&quot; + wordIndicator(nextWord, nextPOS));</span>
<span class="nc" id="L186">    features.incrementCount(&quot;prev-word=&quot; + wordIndicator(prevWord, prevPOS));</span>
<span class="nc" id="L187">    features.incrementCount(&quot;next-bigram=&quot;</span>
<span class="nc" id="L188">        + wordIndicator(nextWord, nextnextWord, nextPOS + &quot;_&quot; + nextnextPOS));</span>
<span class="nc" id="L189">    features.incrementCount(&quot;prev-bigram=&quot;</span>
<span class="nc" id="L190">        + wordIndicator(prevprevWord, prevWord, prevprevPOS + &quot;_&quot; + prevPOS));</span>
<span class="nc" id="L191">    features.incrementCount(&quot;next-pos=&quot; + nextPOS);</span>
<span class="nc" id="L192">    features.incrementCount(&quot;prev-pos=&quot; + prevPOS);</span>
<span class="nc" id="L193">    features.incrementCount(&quot;first-pos=&quot; + firstPOS);</span>
<span class="nc" id="L194">    features.incrementCount(&quot;last-pos=&quot; + lastPOS);</span>
<span class="nc" id="L195">    features.incrementCount(&quot;next-pos-bigram=&quot; + nextPOS + &quot;_&quot; + nextnextPOS);</span>
<span class="nc" id="L196">    features.incrementCount(&quot;prev-pos-bigram=&quot; + prevprevPOS + &quot;_&quot; + prevPOS);</span>
<span class="nc" id="L197">    addDependencyFeatures(features, &quot;parent&quot;, getDependencyParent(m), true);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">    addFeature(features, &quot;ends-with-head&quot;, m.headIndex == m.endIndex - 1);</span>
<span class="nc bnc" id="L199" title="All 4 branches missed.">    addFeature(features, &quot;is-generic&quot;, m.originalSpan.size() == 1 &amp;&amp; firstPOS.equals(&quot;NNS&quot;));</span>

    // syntax features
<span class="nc" id="L202">    IndexedWord w = m.headIndexedWord;</span>
<span class="nc" id="L203">    String depPath = &quot;&quot;;</span>
<span class="nc" id="L204">    int depth = 0;</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">    while (w != null) {</span>
<span class="nc" id="L206">      SemanticGraphEdge e = getDependencyParent(m, w);</span>
<span class="nc" id="L207">      depth++;</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">      if (depth &lt;= 3 &amp;&amp; e != null) {</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        depPath += (depPath.isEmpty() ? &quot;&quot; : &quot;_&quot;) + e.getRelation().toString();</span>
<span class="nc" id="L210">        features.incrementCount(&quot;dep-path=&quot; + depPath);</span>
<span class="nc" id="L211">        w = e.getSource();</span>
      } else {
<span class="nc" id="L213">         w = null;</span>
      }
<span class="nc" id="L215">    }</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">    if (useConstituencyParse) {</span>
<span class="nc" id="L217">      int fullEmbeddingLevel = headEmbeddingLevel(m.contextParseTree, m.headIndex);</span>
<span class="nc" id="L218">      int mentionEmbeddingLevel = headEmbeddingLevel(m.mentionSubTree, m.headIndex - m.startIndex);</span>
<span class="nc bnc" id="L219" title="All 4 branches missed.">      if (fullEmbeddingLevel != -1 &amp;&amp; mentionEmbeddingLevel != -1) {</span>
<span class="nc" id="L220">        features.incrementCount(&quot;mention-embedding-level=&quot;</span>
<span class="nc" id="L221">            + bin(fullEmbeddingLevel - mentionEmbeddingLevel));</span>
<span class="nc" id="L222">        features.incrementCount(&quot;head-embedding-level=&quot;</span>
<span class="nc" id="L223">            + bin(mentionEmbeddingLevel));</span>
      } else {
<span class="nc" id="L225">        features.incrementCount(&quot;undetermined-embedding-level&quot;);</span>
      }
<span class="nc" id="L227">      features.incrementCount(&quot;num-embedded-nps=&quot; + bin(numEmbeddedNps(m.mentionSubTree)));</span>
<span class="nc" id="L228">      String syntaxPath = &quot;&quot;;</span>
<span class="nc" id="L229">      Tree tree = m.contextParseTree;</span>
<span class="nc" id="L230">      Tree head = tree.getLeaves().get(m.headIndex).ancestor(1, tree);</span>
<span class="nc" id="L231">      depth = 0;</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">      for (Tree node : tree.pathNodeToNode(head, tree)) {</span>
<span class="nc" id="L233">        syntaxPath += node.value() + &quot;-&quot;;</span>
<span class="nc" id="L234">        features.incrementCount(&quot;syntax-path=&quot; + syntaxPath);</span>
<span class="nc" id="L235">        depth++;</span>
<span class="nc bnc" id="L236" title="All 4 branches missed.">        if (depth &gt;= 4 || node.value().equals(&quot;S&quot;)) {</span>
<span class="nc" id="L237">          break;</span>
        }
<span class="nc" id="L239">      }</span>
    }

    // mention containment features
<span class="nc" id="L243">    addFeature(features, &quot;contained-in-other-mention&quot;,</span>
<span class="nc bnc" id="L244" title="All 4 branches missed.">        mentionsByHeadIndex.get(m.headIndex).stream().anyMatch(m2 -&gt; m != m2 &amp;&amp; m.insideIn(m2)));</span>
<span class="nc" id="L245">    addFeature(features, &quot;contains-other-mention&quot;,</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">        mentionsByHeadIndex.get(m.headIndex).stream().anyMatch(m2 -&gt; m != m2 &amp;&amp; m2.insideIn(m)));</span>

    // features from dcoref rules
<span class="nc bnc" id="L249" title="All 4 branches missed.">    addFeature(features, &quot;bare-plural&quot;, m.originalSpan.size() == 1 &amp;&amp; headPOS.equals(&quot;NNS&quot;));</span>
<span class="nc" id="L250">    addFeature(features, &quot;quantifier-start&quot;, dictionaries.quantifiers.contains(firstWord.word().toLowerCase()));</span>
<span class="nc" id="L251">    addFeature(features, &quot;negative-start&quot;, firstWord.word().toLowerCase().matches(&quot;none|no|nothing|not&quot;));</span>
<span class="nc" id="L252">    addFeature(features, &quot;partitive&quot;, RuleBasedCorefMentionFinder.partitiveRule(m, m.sentenceWords, dictionaries));</span>
<span class="nc" id="L253">    addFeature(features, &quot;adjectival-demonym&quot;, dictionaries.isAdjectivalDemonym(m.spanToString()));</span>
<span class="nc bnc" id="L254" title="All 6 branches missed.">    if(doc.docType != DocType.ARTICLE &amp;&amp; m.person == Person.YOU</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        &amp;&amp; nextWord != null &amp;&amp; nextWord.word().equalsIgnoreCase(&quot;know&quot;)) {</span>
<span class="nc" id="L256">           features.incrementCount(&quot;generic-you&quot;);</span>
    }

<span class="nc" id="L259">    return features;</span>
  }

  private Counter&lt;String&gt; getFeatures(Document doc, Mention m1, Mention m2) {
<span class="nc bnc" id="L263" title="All 4 branches missed.">    assert(m1.appearEarlierThan(m2));</span>
<span class="nc" id="L264">    Counter&lt;String&gt; features = new ClassicCounter&lt;&gt;();</span>

    // global features
<span class="nc" id="L267">    features.incrementCount(&quot;bias&quot;);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">    if (useDocSource) {</span>
<span class="nc" id="L269">      features.incrementCount(&quot;doc-type=&quot; + doc.docType);</span>
<span class="nc bnc" id="L270" title="All 4 branches missed.">      if(doc.docInfo != null &amp;&amp; doc.docInfo.containsKey(&quot;DOC_ID&quot;)) {</span>
<span class="nc" id="L271">        features.incrementCount(&quot;doc-source=&quot; + doc.docInfo.get(&quot;DOC_ID&quot;).split(&quot;/&quot;)[1]);</span>
      }
    }

    // singleton feature conjunctions
<span class="nc" id="L276">    List&lt;String&gt; singletonFeatures1 = m1.getSingletonFeatures(dictionaries);</span>
<span class="nc" id="L277">    List&lt;String&gt; singletonFeatures2 = m2.getSingletonFeatures(dictionaries);</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">    for (Map.Entry&lt;Integer, String&gt; e : SINGLETON_FEATURES.entrySet()) {</span>
<span class="nc bnc" id="L279" title="All 4 branches missed.">      if (e.getKey() &lt; singletonFeatures1.size() &amp;&amp; e.getKey() &lt; singletonFeatures2.size()) {</span>
<span class="nc" id="L280">        features.incrementCount(e.getValue() + &quot;=&quot; + singletonFeatures1.get(e.getKey()) + &quot;_&quot; +</span>
<span class="nc" id="L281">                singletonFeatures2.get(e.getKey()));</span>
      }
<span class="nc" id="L283">    }</span>
<span class="nc" id="L284">    SemanticGraphEdge p1 = getDependencyParent(m1);</span>
<span class="nc" id="L285">    SemanticGraphEdge p2 = getDependencyParent(m2);</span>
<span class="nc bnc" id="L286" title="All 4 branches missed.">    features.incrementCount(&quot;dep-relations=&quot; + (p1 == null ? &quot;null&quot; : p1.getRelation()) + &quot;_&quot;</span>
<span class="nc" id="L287">        + (p2 == null ? &quot;null&quot; : p2.getRelation()));</span>
<span class="nc" id="L288">    features.incrementCount(&quot;roles=&quot; + getRole(m1) + &quot;_&quot; + getRole(m2));</span>
<span class="nc" id="L289">    CoreLabel headCL1 = headWord(m1);</span>
<span class="nc" id="L290">    CoreLabel headCL2 = headWord(m2);</span>
<span class="nc" id="L291">    String headPOS1 = getPOS(headCL1);</span>
<span class="nc" id="L292">    String headPOS2 = getPOS(headCL2);</span>
<span class="nc" id="L293">    features.incrementCount(&quot;head-pos-s=&quot; + headPOS1 + &quot;_&quot; + headPOS2);</span>
<span class="nc" id="L294">    features.incrementCount(&quot;head-words=&quot; + wordIndicator(&quot;h_&quot; + headCL1.word().toLowerCase()</span>
<span class="nc" id="L295">            + &quot;_&quot; + headCL2.word().toLowerCase(), headPOS1 + &quot;_&quot; + headPOS2));</span>

    // agreement features
<span class="nc" id="L298">    addFeature(features, &quot;animacies-agree&quot;, m2.animaciesAgree(m1));</span>
<span class="nc" id="L299">    addFeature(features, &quot;attributes-agree&quot;, m2.attributesAgree(m1, dictionaries));</span>
<span class="nc" id="L300">    addFeature(features, &quot;entity-types-agree&quot;, m2.entityTypesAgree(m1, dictionaries));</span>
<span class="nc" id="L301">    addFeature(features, &quot;numbers-agree&quot;, m2.numbersAgree(m1));</span>
<span class="nc" id="L302">    addFeature(features, &quot;genders-agree&quot;, m2.gendersAgree(m1));</span>
<span class="nc" id="L303">    addFeature(features, &quot;ner-strings-equal&quot;, m1.nerString.equals(m2.nerString));</span>

    // string matching features
<span class="nc" id="L306">    addFeature(features, &quot;antecedent-head-in-anaphor&quot;, headContainedIn(m1, m2));</span>
<span class="nc" id="L307">    addFeature(features, &quot;anaphor-head-in-antecedent&quot;, headContainedIn(m2, m1));</span>
<span class="nc bnc" id="L308" title="All 4 branches missed.">    if (m1.mentionType != MentionType.PRONOMINAL &amp;&amp; m2.mentionType != MentionType.PRONOMINAL) {</span>
<span class="nc" id="L309">      addFeature(features, &quot;antecedent-in-anaphor&quot;,</span>
<span class="nc" id="L310">          m2.spanToString().toLowerCase().contains(m1.spanToString().toLowerCase()));</span>
<span class="nc" id="L311">      addFeature(features, &quot;anaphor-in-antecedent&quot;,</span>
<span class="nc" id="L312">          m1.spanToString().toLowerCase().contains(m2.spanToString().toLowerCase()));</span>
<span class="nc" id="L313">      addFeature(features, &quot;heads-equal&quot;, m1.headString.equalsIgnoreCase(m2.headString));</span>
<span class="nc" id="L314">      addFeature(features, &quot;heads-agree&quot;, m2.headsAgree(m1));</span>
<span class="nc" id="L315">      addFeature(features, &quot;exact-match&quot;, m1.toString().trim().toLowerCase().equals(</span>
<span class="nc" id="L316">          m2.toString().trim().toLowerCase()));</span>
<span class="nc" id="L317">      addFeature(features, &quot;partial-match&quot;, relaxedStringMatch(m1, m2));</span>

<span class="nc" id="L319">      double editDistance = StringUtils.editDistance(m1.spanToString(), m2.spanToString()) /</span>
<span class="nc" id="L320">         (double) (m1.spanToString().length() + m2.spanToString().length());</span>
<span class="nc" id="L321">      features.incrementCount(&quot;edit-distance&quot;, editDistance);</span>
<span class="nc" id="L322">      features.incrementCount(&quot;edit-distance=&quot; + ((int)(editDistance * 10) / 10.0));</span>

<span class="nc" id="L324">      double headEditDistance = StringUtils.editDistance(m1.headString, m2.headString) /</span>
<span class="nc" id="L325">          (double) (m1.headString.length() + m2.headString.length());</span>
<span class="nc" id="L326">      features.incrementCount(&quot;head-edit-distance&quot;, headEditDistance);</span>
<span class="nc" id="L327">      features.incrementCount(&quot;head-edit-distance=&quot; + ((int)(headEditDistance * 10) / 10.0));</span>
    }

    // distance features
<span class="nc" id="L331">    addNumeric(features, &quot;mention-distance&quot;, m2.mentionNum -  m1.mentionNum);</span>
<span class="nc" id="L332">    addNumeric(features, &quot;sentence-distance&quot;, m2.sentNum -  m1.sentNum);</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">    if (m2.sentNum == m1.sentNum) {</span>
<span class="nc" id="L334">        addNumeric(features, &quot;word-distance&quot;, m2.startIndex -  m1.endIndex);</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (m1.endIndex &gt; m2.startIndex) {</span>
<span class="nc" id="L336">            features.incrementCount(&quot;spans-intersect&quot;);</span>
        }
    }

    // setup for dcoref features
<span class="nc" id="L341">    Set&lt;Mention&gt; ms1 = new HashSet&lt;&gt;();</span>
<span class="nc" id="L342">    ms1.add(m1);</span>
<span class="nc" id="L343">    Set&lt;Mention&gt; ms2 = new HashSet&lt;&gt;();</span>
<span class="nc" id="L344">    ms2.add(m2);</span>
<span class="nc" id="L345">    Random r = new Random();</span>
<span class="nc" id="L346">    CorefCluster c1 = new CorefCluster(20000 + r.nextInt(10000), ms1);</span>
<span class="nc" id="L347">    CorefCluster c2 = new CorefCluster(10000 + r.nextInt(10000), ms2);</span>
<span class="nc" id="L348">    String s2 = m2.lowercaseNormalizedSpanString();</span>
<span class="nc" id="L349">    String s1 = m1.lowercaseNormalizedSpanString();</span>

    // discourse dcoref features
<span class="nc" id="L352">    addFeature(features, &quot;mention-speaker-PER0&quot;,</span>
<span class="nc" id="L353">        m2.headWord.get(SpeakerAnnotation.class).equalsIgnoreCase(&quot;PER0&quot;));</span>
<span class="nc" id="L354">    addFeature(features, &quot;antecedent-is-anaphor-speaker&quot;, CorefRules.antecedentIsMentionSpeaker(doc, m2, m1, dictionaries));</span>
<span class="nc" id="L355">    addFeature(features, &quot;same-speaker&quot;, CorefRules.entitySameSpeaker(doc, m2, m1));</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">    addFeature(features, &quot;person-disagree-same-speaker&quot;, CorefRules.entityPersonDisagree(doc, m2, m1, dictionaries)</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">        &amp;&amp; CorefRules.entitySameSpeaker(doc, m2, m1));</span>
<span class="nc" id="L358">    addFeature(features, &quot;antecedent-matches-anaphor-speaker&quot;,</span>
<span class="nc" id="L359">        CorefRules.antecedentMatchesMentionSpeakerAnnotation(m2, m1, doc));</span>
<span class="nc bnc" id="L360" title="All 4 branches missed.">    addFeature(features, &quot;discourse-you-PER0&quot;, m2.person == Person.YOU</span>
        &amp;&amp; doc.docType == DocType.ARTICLE
<span class="nc bnc" id="L362" title="All 2 branches missed.">        &amp;&amp; m2.headWord.get(CoreAnnotations.SpeakerAnnotation.class).equals(&quot;PER0&quot;));</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">    addFeature(features, &quot;speaker-match-i-i&quot;, m2.number == Number.SINGULAR</span>
<span class="nc bnc" id="L364" title="All 4 branches missed.">        &amp;&amp; dictionaries.firstPersonPronouns.contains(s1)</span>
        &amp;&amp; m1.number == Number.SINGULAR
<span class="nc bnc" id="L366" title="All 2 branches missed.">        &amp;&amp; dictionaries.firstPersonPronouns.contains(s2)</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        &amp;&amp; CorefRules.entitySameSpeaker(doc, m2, m1));</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">    addFeature(features, &quot;speaker-match-speaker-i&quot;, m2.number == Number.SINGULAR</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">        &amp;&amp; dictionaries.firstPersonPronouns.contains(s2)</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">        &amp;&amp; CorefRules.antecedentIsMentionSpeaker(doc, m2, m1, dictionaries));</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">    addFeature(features, &quot;speaker-match-i-speaker&quot;, m1.number == Number.SINGULAR</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        &amp;&amp; dictionaries.firstPersonPronouns.contains(s1)</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">        &amp;&amp; CorefRules.antecedentIsMentionSpeaker(doc, m1, m2, dictionaries));</span>
<span class="nc" id="L374">    addFeature(features, &quot;speaker-match-you-you&quot;,</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        dictionaries.secondPersonPronouns.contains(s1)</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">        &amp;&amp; dictionaries.secondPersonPronouns.contains(s2)</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">        &amp;&amp; CorefRules.entitySameSpeaker(doc, m2, m1));</span>
<span class="nc bnc" id="L378" title="All 8 branches missed.">    addFeature(features, &quot;discourse-between-two-person&quot;, ((m2.person == Person.I</span>
        &amp;&amp; m1.person == Person.YOU
        || (m2.person == Person.YOU &amp;&amp; m1.person == Person.I))
<span class="nc" id="L381">        &amp;&amp; (m2.headWord.get(CoreAnnotations.UtteranceAnnotation.class)</span>
<span class="nc bnc" id="L382" title="All 4 branches missed.">                - m1.headWord.get(CoreAnnotations.UtteranceAnnotation.class) == 1)</span>
        &amp;&amp; doc.docType == DocType.CONVERSATION));
<span class="nc bnc" id="L384" title="All 4 branches missed.">    addFeature(features, &quot;incompatible-not-match&quot;, m1.person != Person.I</span>
        &amp;&amp; m2.person != Person.I
<span class="nc bnc" id="L386" title="All 2 branches missed.">        &amp;&amp; (CorefRules.antecedentIsMentionSpeaker(doc, m1, m2, dictionaries)</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">                || CorefRules.antecedentIsMentionSpeaker(doc, m2, m1, dictionaries)));</span>
<span class="nc" id="L388">    int utteranceDist = Math.abs(m1.headWord.get(CoreAnnotations.UtteranceAnnotation.class) -</span>
<span class="nc" id="L389">        m2.headWord.get(CoreAnnotations.UtteranceAnnotation.class));</span>
<span class="nc bnc" id="L390" title="All 4 branches missed.">    if(doc.docType != DocType.ARTICLE &amp;&amp; utteranceDist == 1</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">          &amp;&amp; !CorefRules.entitySameSpeaker(doc, m2, m1)) {</span>
<span class="nc bnc" id="L392" title="All 4 branches missed.">      addFeature(features, &quot;speaker-mismatch-i-i&quot;, m1.person == Person.I</span>
          &amp;&amp; m2.person == Person.I);
<span class="nc bnc" id="L394" title="All 4 branches missed.">      addFeature(features, &quot;speaker-mismatch-you-you&quot;, m1.person == Person.YOU</span>
          &amp;&amp; m2.person == Person.YOU);
<span class="nc bnc" id="L396" title="All 4 branches missed.">      addFeature(features, &quot;speaker-mismatch-we-we&quot;, m1.person == Person.WE</span>
          &amp;&amp; m2.person == Person.WE);
    }

    // other dcoref features
<span class="nc" id="L401">    String firstWord1 = firstWord(m1).word().toLowerCase();</span>
<span class="nc bnc" id="L402" title="All 4 branches missed.">    addFeature(features, &quot;indefinite-article-np&quot;, (m1.appositions == null &amp;&amp;</span>
        m1.predicateNominatives == null &amp;&amp;
<span class="nc bnc" id="L404" title="All 4 branches missed.">        (firstWord1.equals(&quot;a&quot;) || firstWord1.equals(&quot;an&quot;))));</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">    addFeature(features, &quot;far-this&quot;, m2.lowercaseNormalizedSpanString().equals(&quot;this&quot;) &amp;&amp;</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">        Math.abs(m2.sentNum - m1.sentNum) &gt; 3);</span>
<span class="nc bnc" id="L407" title="All 4 branches missed.">    addFeature(features, &quot;per0-you-in-article&quot;, m2.person == Person.YOU &amp;&amp;</span>
        doc.docType == DocType.ARTICLE &amp;&amp;
<span class="nc bnc" id="L409" title="All 2 branches missed.">        m2.headWord.get(CoreAnnotations.SpeakerAnnotation.class).equals(&quot;PER0&quot;));</span>
<span class="nc bnc" id="L410" title="All 4 branches missed.">    addFeature(features, &quot;inside-in&quot;, m2.insideIn(m1) || m1.insideIn(m2));</span>
<span class="nc" id="L411">    addFeature(features, &quot;indefinite-determiners&quot;,</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">        dictionaries.indefinitePronouns.contains(m1.originalSpan.get(0).lemma())</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">            || dictionaries.indefinitePronouns.contains(m2.originalSpan.get(0).lemma()));</span>

<span class="nc" id="L415">    addFeature(features, &quot;entity-attributes-agree&quot;, CorefRules.entityAttributesAgree(c2, c1));</span>
<span class="nc" id="L416">    addFeature(features, &quot;entity-token-distance&quot;, CorefRules.entityTokenDistance(m2, m1));</span>
<span class="nc" id="L417">    addFeature(features, &quot;i-within-i&quot;, CorefRules.entityIWithinI(m2, m1, dictionaries));</span>
<span class="nc" id="L418">    addFeature(features, &quot;exact-string-match&quot;, CorefRules.entityExactStringMatch(c2, c1,dictionaries, doc.roleSet));</span>
<span class="nc" id="L419">    addFeature(features, &quot;entity-relaxed-heads-agree&quot;,</span>
<span class="nc" id="L420">        CorefRules.entityRelaxedHeadsAgreeBetweenMentions(c2, c1, m2, m1));</span>
<span class="nc" id="L421">    addFeature(features, &quot;is-acronym&quot;, CorefRules.entityIsAcronym(doc, c2, c1));</span>
<span class="nc" id="L422">    addFeature(features, &quot;demonym&quot;, m2.isDemonym(m1, dictionaries));</span>
<span class="nc" id="L423">    addFeature(features, &quot;incompatible-modifier&quot;, CorefRules.entityHaveIncompatibleModifier(m2, m1));</span>
<span class="nc" id="L424">    addFeature(features, &quot;head-lemma-match&quot;, m1.headWord.lemma().equals(m2.headWord.lemma()));</span>
<span class="nc" id="L425">    addFeature(features, &quot;words-included&quot;, CorefRules.entityWordsIncluded(c2, c1, m2, m1));</span>
<span class="nc" id="L426">    addFeature(features, &quot;extra-proper-noun&quot;, CorefRules.entityHaveExtraProperNoun(m2, m1, new HashSet&lt;&gt;()));</span>
<span class="nc" id="L427">    addFeature(features, &quot;number-in-later-mentions&quot;, CorefRules.entityNumberInLaterMention(m2, m1));</span>
<span class="nc" id="L428">    addFeature(features, &quot;sentence-context-incompatible&quot;,</span>
<span class="nc" id="L429">        CorefRules.sentenceContextIncompatible(m2, m1, dictionaries));</span>

    // syntax features
<span class="nc bnc" id="L432" title="All 2 branches missed.">    if (useConstituencyParse) {</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">      if (m1.sentNum == m2.sentNum) {</span>
<span class="nc" id="L434">        int clauseCount = 0;</span>
<span class="nc" id="L435">        Tree tree = m2.contextParseTree;</span>
<span class="nc" id="L436">        Tree current = m2.mentionSubTree;</span>
        while (true) {
<span class="nc" id="L438">          current = current.ancestor(1, tree);</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">          if (current.label().value().startsWith(&quot;S&quot;)) {</span>
<span class="nc" id="L440">            clauseCount++;</span>
          }
<span class="nc bnc" id="L442" title="All 2 branches missed.">          if (current.dominates(m1.mentionSubTree)) {</span>
<span class="nc" id="L443">            break;</span>
          }
<span class="nc bnc" id="L445" title="All 4 branches missed.">          if (current.label().value().equals(&quot;ROOT&quot;) || current.ancestor(1, tree) == null) {</span>
<span class="nc" id="L446">            break;</span>
          }
        }
<span class="nc" id="L449">        features.incrementCount(&quot;clause-count&quot;, clauseCount);</span>
<span class="nc" id="L450">        features.incrementCount(&quot;clause-count=&quot; + bin(clauseCount));</span>
      }
<span class="nc bnc" id="L452" title="All 2 branches missed.">      if (RuleBasedCorefMentionFinder.isPleonastic(m2, m2.contextParseTree)</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">          || RuleBasedCorefMentionFinder.isPleonastic(m1, m1.contextParseTree)) {</span>
<span class="nc" id="L454">        features.incrementCount(&quot;pleonastic-it&quot;);</span>
      }
<span class="nc bnc" id="L456" title="All 2 branches missed.">      if (maximalNp(m1.mentionSubTree) == maximalNp(m2.mentionSubTree)) {</span>
<span class="nc" id="L457">        features.incrementCount(&quot;same-maximal-np&quot;);</span>
      }
<span class="nc bnc" id="L459" title="All 2 branches missed.">      boolean m1Embedded = headEmbeddingLevel(</span>
        m1.mentionSubTree, m1.headIndex - m1.startIndex) &gt; 1;
<span class="nc bnc" id="L461" title="All 2 branches missed.">      boolean m2Embedded = headEmbeddingLevel(</span>
        m2.mentionSubTree, m2.headIndex - m2.startIndex) &gt; 1;
<span class="nc" id="L463">      features.incrementCount(&quot;embedding=&quot; + m1Embedded + &quot;_&quot; + m2Embedded);</span>
    }

<span class="nc" id="L466">    return features;</span>
  }

  private static void addNumeric(Counter&lt;String&gt; features, String key, int value) {
<span class="nc" id="L470">    features.incrementCount(key + &quot;=&quot; + bin(value));</span>
<span class="nc" id="L471">    features.incrementCount(key, value);</span>
<span class="nc" id="L472">  }</span>

  public static boolean relaxedStringMatch(Mention m1, Mention m2) {
<span class="nc" id="L475">    Set&lt;String&gt; propers = getPropers(m1);</span>
<span class="nc" id="L476">    propers.retainAll(getPropers(m2));</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">    return !propers.isEmpty();</span>
  }

<span class="nc" id="L480">  private static final Set&lt;String&gt; PROPERS = new HashSet&lt;&gt;();</span>
  static {
<span class="nc" id="L482">    PROPERS.add(&quot;NN&quot;);</span>
<span class="nc" id="L483">    PROPERS.add(&quot;NNS&quot;);</span>
<span class="nc" id="L484">    PROPERS.add(&quot;NNP&quot;);</span>
<span class="nc" id="L485">    PROPERS.add(&quot;NNPS&quot;);</span>
<span class="nc" id="L486">  }</span>
  private static Set&lt;String&gt; getPropers(Mention m) {
<span class="nc" id="L488">    Set&lt;String&gt; propers = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">    for (int i = m.startIndex; i &lt; m.endIndex; i++) {</span>
<span class="nc" id="L490">      CoreLabel cl = m.sentenceWords.get(i);</span>
<span class="nc" id="L491">      String POS = cl.get(CoreAnnotations.PartOfSpeechAnnotation.class);</span>
<span class="nc" id="L492">      String word = cl.word().toLowerCase();</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">      if (PROPERS.contains(POS)) {</span>
<span class="nc" id="L494">        propers.add(word);</span>
      }
    }
<span class="nc" id="L497">    return propers;</span>
  }

  private static void addFeature(Counter&lt;String&gt; features, String name, boolean value) {
<span class="nc bnc" id="L501" title="All 2 branches missed.">    if (value) {</span>
<span class="nc" id="L502">      features.incrementCount(name);</span>
    }
<span class="nc" id="L504">  }</span>

  private static String bin(int value) {
<span class="nc" id="L507">    return bin(value, BIN_EXACT, BIN_EXPONENT, Integer.MAX_VALUE);</span>
  }

  private static String bin(int value, int binExact, double binExponent, int cap) {
<span class="nc bnc" id="L511" title="All 2 branches missed.">    if (value &lt; 0) {</span>
<span class="nc" id="L512">      return &quot;-&quot; + bin(-value);</span>
    }
<span class="nc bnc" id="L514" title="All 2 branches missed.">    if (value &gt; cap) {</span>
<span class="nc" id="L515">      return cap + &quot;+&quot;;</span>
    }

<span class="nc" id="L518">    String bin = String.valueOf(value);</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">    if (value &gt; binExact) {</span>
<span class="nc" id="L520">      double start = Math.pow(binExponent, (int) (Math.log(value) / Math.log(binExponent)));</span>
<span class="nc" id="L521">      bin = (int) start + &quot;-&quot; + (int) (start * binExponent);</span>
    }
<span class="nc" id="L523">    return bin;</span>
  }

  private static String getRole(Mention m) {
<span class="nc bnc" id="L527" title="All 2 branches missed.">    if (m.isSubject) {</span>
<span class="nc" id="L528">      return &quot;subject&quot;;</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">    } else if (m.isDirectObject) {</span>
<span class="nc" id="L530">      return &quot;direct-object&quot;;</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">    } else if (m.isIndirectObject) {</span>
<span class="nc" id="L532">      return &quot;indirect-object&quot;;</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">    } else if (m.isPrepositionObject) {</span>
<span class="nc" id="L534">      return &quot;preposition-object&quot;;</span>
    }
<span class="nc" id="L536">    return &quot;unknown&quot;;</span>
  }

  private static SemanticGraphEdge getDependencyParent(Mention m) {
<span class="nc" id="L540">    return getDependencyParent(m, m.headIndexedWord);</span>
  }

  private static SemanticGraphEdge getDependencyParent(Mention m, IndexedWord w) {
<span class="nc" id="L544">    Iterator&lt;SemanticGraphEdge&gt; iterator = m.enhancedDependency.incomingEdgeIterator(w);</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">    return iterator.hasNext() ? iterator.next() : null;</span>
  }

  private void addDependencyFeatures(Counter&lt;String&gt; features, String prefix,
      SemanticGraphEdge e, boolean addWord) {
<span class="nc bnc" id="L550" title="All 2 branches missed.">    if (e == null) {</span>
<span class="nc" id="L551">      features.incrementCount(&quot;no-&quot; + prefix);</span>
<span class="nc" id="L552">      return;</span>
    }
<span class="nc" id="L554">    IndexedWord parent = e.getSource();</span>
<span class="nc" id="L555">    String parentPOS = parent.tag();</span>
<span class="nc" id="L556">    String parentWord = parent.word();</span>
<span class="nc" id="L557">    String parentRelation = e.getRelation().toString();</span>
    //String parentDir = e.getSource().beginPosition() &lt; e.getTarget().beginPosition()
    //    ? &quot;right&quot; : &quot;left&quot;;
<span class="nc bnc" id="L560" title="All 2 branches missed.">    if (addWord) {</span>
<span class="nc" id="L561">      features.incrementCount(prefix + &quot;-word=&quot; + wordIndicator(parentWord, parentPOS));</span>
    }
<span class="nc" id="L563">    features.incrementCount(prefix + &quot;-POS=&quot; + parentPOS);</span>
<span class="nc" id="L564">    features.incrementCount(prefix + &quot;-relation=&quot; + parentRelation);</span>
    //features.incrementCount(prefix + &quot;-direction=&quot; + parentDir);
<span class="nc" id="L566">  }</span>

  public Tree maximalNp(Tree mentionSubTree) {
<span class="nc" id="L569">    Tree maximalSubtree = mentionSubTree;</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">    for (Tree subtree : mentionSubTree.postOrderNodeList()) {</span>
<span class="nc bnc" id="L571" title="All 4 branches missed.">      if (!subtree.isLeaf() &amp;&amp; !subtree.isPreTerminal()) {</span>
<span class="nc" id="L572">        String label = ((CoreLabel) subtree.label())</span>
<span class="nc" id="L573">            .get(CoreAnnotations.ValueAnnotation.class);</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">        if (label.equals(&quot;NP&quot;)) {</span>
<span class="nc" id="L575">          maximalSubtree = subtree;</span>
        }
      }
<span class="nc" id="L578">    }</span>
<span class="nc" id="L579">    return maximalSubtree;</span>
  }

  private int numEmbeddedNps(Tree mentionSubTree) {
<span class="nc" id="L583">    int embeddedNps = 0;</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">    for (Tree subtree : mentionSubTree.postOrderNodeList()) {</span>
<span class="nc bnc" id="L585" title="All 4 branches missed.">      if (!subtree.isLeaf() &amp;&amp; !subtree.isPreTerminal()) {</span>
<span class="nc" id="L586">        String label = ((CoreLabel) subtree.label())</span>
<span class="nc" id="L587">            .get(CoreAnnotations.ValueAnnotation.class);</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">        if (label.equals(&quot;NP&quot;)) {</span>
<span class="nc" id="L589">          embeddedNps++;</span>
        }
      }
<span class="nc" id="L592">    }</span>
<span class="nc" id="L593">    return embeddedNps;</span>
  }

  private int headEmbeddingLevel(Tree tree, int headIndex) {
<span class="nc" id="L597">    int embeddingLevel = 0;</span>
    try {
<span class="nc" id="L599">      Tree subtree = tree.getLeaves().get(headIndex);</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">      while (subtree != null) {</span>
<span class="nc" id="L601">        String label = ((CoreLabel) subtree.label()).get(CoreAnnotations.ValueAnnotation.class);</span>
<span class="nc" id="L602">        subtree = subtree.ancestor(1, tree);</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">        if (label.equals(&quot;NP&quot;)) {</span>
<span class="nc" id="L604">          embeddingLevel++;</span>
        }
<span class="nc" id="L606">      }</span>
<span class="nc" id="L607">    } catch (Exception e) {</span>
<span class="nc" id="L608">      return -1;</span>
<span class="nc" id="L609">    }</span>
<span class="nc" id="L610">    return embeddingLevel;</span>
  }

  private static boolean headContainedIn(Mention m1, Mention m2) {
<span class="nc" id="L614">    String head = m1.headString;</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">    for (CoreLabel cl : m2.originalSpan) {</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">      if (head.equals(cl.word().toLowerCase())) {</span>
<span class="nc" id="L617">        return true;</span>
      }
<span class="nc" id="L619">    }</span>
<span class="nc" id="L620">    return false;</span>
  }

  private String wordIndicator(CoreLabel cl1, CoreLabel cl2, String POS) {
<span class="nc bnc" id="L624" title="All 2 branches missed.">    String w1 = cl1 == null ? &quot;NONE&quot; : cl1.word().toLowerCase();</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">    String w2 = cl2 == null ? &quot;NONE&quot; : cl2.word().toLowerCase();</span>
<span class="nc" id="L626">    return wordIndicator(w1 + &quot;_&quot; + w2, POS);</span>
  }

  private String wordIndicator(CoreLabel cl, String POS) {
<span class="nc bnc" id="L630" title="All 2 branches missed.">    if (cl == null) {</span>
<span class="nc" id="L631">      return &quot;NONE&quot;;</span>
    }
<span class="nc" id="L633">    return wordIndicator(cl.word().toLowerCase(), POS);</span>
  }

  private String wordIndicator(String word, String POS) {
<span class="nc bnc" id="L637" title="All 2 branches missed.">    if (word == null) {</span>
<span class="nc" id="L638">      return &quot;NONE&quot;;</span>
    }
<span class="nc bnc" id="L640" title="All 2 branches missed.">    return vocabulary.contains(word) ? word : POS;</span>
  }

  private static String getPOS(CoreLabel cl) {
<span class="nc bnc" id="L644" title="All 2 branches missed.">    return cl == null ? &quot;NONE&quot; : cl.get(CoreAnnotations.PartOfSpeechAnnotation.class);</span>
  }

  private static CoreLabel firstWord(Mention m) {
<span class="nc" id="L648">    return m.originalSpan.get(0);</span>
  }

  private static CoreLabel headWord(Mention m) {
<span class="nc" id="L652">    return m.headWord;</span>
  }

  private static CoreLabel lastWord(Mention m) {
<span class="nc" id="L656">    return m.originalSpan.get(m.originalSpan.size() - 1);</span>
  }

  private static CoreLabel nextnextWord(Mention m) {
<span class="nc bnc" id="L660" title="All 2 branches missed.">    return m.endIndex + 1 &lt; m.sentenceWords.size() ? m.sentenceWords.get(m.endIndex + 1) : null;</span>
  }

  private static CoreLabel nextWord(Mention m) {
<span class="nc bnc" id="L664" title="All 2 branches missed.">    return m.endIndex &lt; m.sentenceWords.size() ? m.sentenceWords.get(m.endIndex) : null;</span>
  }

  private static CoreLabel prevWord(Mention m) {
<span class="nc bnc" id="L668" title="All 2 branches missed.">    return m.startIndex &gt; 0 ? m.sentenceWords.get(m.startIndex - 1) : null;</span>
  }

  private static CoreLabel prevprevWord(Mention m) {
<span class="nc bnc" id="L672" title="All 2 branches missed.">    return m.startIndex &gt; 1 ? m.sentenceWords.get(m.startIndex - 2) : null;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>