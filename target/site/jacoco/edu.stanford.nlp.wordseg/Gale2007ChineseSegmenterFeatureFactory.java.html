<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Gale2007ChineseSegmenterFeatureFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Stanford CoreNLP</a> &gt; <a href="index.source.html" class="el_package">edu.stanford.nlp.wordseg</a> &gt; <span class="el_source">Gale2007ChineseSegmenterFeatureFactory.java</span></div><h1>Gale2007ChineseSegmenterFeatureFactory.java</h1><pre class="source lang-java linenums">package edu.stanford.nlp.wordseg;

import java.util.ArrayList;
import java.util.Collection;
import java.util.regex.Matcher;
import java.util.regex.Pattern;


import edu.stanford.nlp.util.logging.Redwood;

import edu.stanford.nlp.io.EncodingPrintWriter;
import edu.stanford.nlp.ling.CoreAnnotation;
import edu.stanford.nlp.ling.CoreLabel;
import edu.stanford.nlp.ling.CoreAnnotations;
import edu.stanford.nlp.sequences.Clique;
import edu.stanford.nlp.sequences.FeatureFactory;
import edu.stanford.nlp.sequences.SeqClassifierFlags;
import edu.stanford.nlp.trees.international.pennchinese.RadicalMap;
import edu.stanford.nlp.util.Generics;
import edu.stanford.nlp.util.PaddedList;


/**
 * A Chinese segmenter Feature Factory for the GALE project.
 * (Modified from the feature factory for Sighan Bakeoff 2005.)
 * &lt;p&gt;
 * c is Chinese character (&quot;char&quot;).  c means current, n means next and p means previous.
 * &lt;/p&gt;
 *
 * &lt;table&gt;
 * &lt;tr&gt;
 * &lt;th&gt;Feature&lt;/th&gt;&lt;th&gt;Templates&lt;/th&gt;
 * &lt;/tr&gt;
 * &lt;tr&gt;
 * &lt;tr&gt;
 * &lt;th&gt;&lt;/th&gt;&lt;th&gt;Current position clique&lt;/th&gt;
 * &lt;/tr&gt;
 * &lt;tr&gt;
 * &lt;td&gt;useWord1&lt;/td&gt;&lt;td&gt;CONSTANT, cc, nc, pc, pc+cc, if (As|Msr|Pk|Hk) cc+nc, pc,nc &lt;/td&gt;
 * &lt;/tr&gt;
 * &lt;/table&gt;
 *
 * @author Huihsin Tseng
 * @author Pichuan Chang
 * @author Christopher Manning
 */
<span class="nc" id="L47">public class Gale2007ChineseSegmenterFeatureFactory&lt;IN extends CoreLabel&gt; extends FeatureFactory&lt;IN&gt; {</span>

  private static final int DEBUG = 0;

<span class="nc" id="L51">  private static Redwood.RedwoodChannels logger = Redwood.channels(Gale2007ChineseSegmenterFeatureFactory.class);</span>

  private transient TagAffixDetector taDetector; // = null;
  private transient CorpusDictionary outDict; // = null;

  @Override
  public void init(SeqClassifierFlags flags) {
<span class="nc" id="L58">    super.init(flags);</span>
<span class="nc" id="L59">  }</span>

  private synchronized void createTADetector() {
<span class="nc bnc" id="L62" title="All 2 branches missed.">    if (taDetector == null) {</span>
<span class="nc" id="L63">      taDetector = new TagAffixDetector(flags);</span>
    }
<span class="nc" id="L65">  }</span>

  private synchronized void createOutDict() {
<span class="nc bnc" id="L68" title="All 2 branches missed.">    if (outDict == null) {</span>
<span class="nc" id="L69">      logger.info(&quot;reading &quot;+flags.outDict2+&quot; as a seen lexicon&quot;);</span>
<span class="nc" id="L70">      outDict = new CorpusDictionary(flags.outDict2);</span>
    }
<span class="nc" id="L72">  }</span>


  /**
   * Extracts all the features from the input data at a certain index.
   *
   * @param cInfo The complete data set as a List of WordInfo
   * @param loc  The index at which to extract features.
   */
  @Override
  public Collection&lt;String&gt; getCliqueFeatures(PaddedList&lt;IN&gt; cInfo, int loc, Clique clique) {
<span class="nc" id="L83">    Collection&lt;String&gt; features = Generics.newHashSet();</span>

<span class="nc bnc" id="L85" title="All 2 branches missed.">    if (clique == cliqueC) {</span>
<span class="nc" id="L86">      addAllInterningAndSuffixing(features, featuresC(cInfo, loc), &quot;C&quot;);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">    } else if (clique == cliqueCpC) {</span>
<span class="nc" id="L88">      addAllInterningAndSuffixing(features, featuresCpC(cInfo, loc), &quot;CpC&quot;);</span>
<span class="nc" id="L89">      addAllInterningAndSuffixing(features, featuresCnC(cInfo, loc-1), &quot;CnC&quot;);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">    } else if (clique == cliqueCpCp2C) {</span>
<span class="nc" id="L91">      addAllInterningAndSuffixing(features, featuresCpCp2C(cInfo, loc), &quot;CpCp2C&quot;);</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">    } else if (clique == cliqueCpCp2Cp3C) {</span>
<span class="nc" id="L94">      addAllInterningAndSuffixing(features, featuresCpCp2Cp3C(cInfo, loc), &quot;CpCp2Cp3C&quot;);</span>
    }

    if (DEBUG &gt; 0) {
      EncodingPrintWriter.err.println(&quot;For &quot; + cInfo.get(loc) +
              &quot;, features: &quot; + features, &quot;UTF-8&quot;);
    }
<span class="nc" id="L101">    return features;</span>
  }



<span class="nc" id="L106">  private static final Pattern patE = Pattern.compile(&quot;[a-z]&quot;);</span>
<span class="nc" id="L107">  private static final Pattern patEC = Pattern.compile(&quot;[A-Z]&quot;);</span>

  private static String isEnglish(String chp, String chc) {
<span class="nc" id="L110">    Matcher mp = patE.matcher(chp);   // previous char is [a-z]</span>
<span class="nc" id="L111">    Matcher mc = patE.matcher(chc);   //  current char is [a-z]</span>
<span class="nc" id="L112">    Matcher mpC = patEC.matcher(chp); // previous char is [A-Z]</span>
<span class="nc" id="L113">    Matcher mcC = patEC.matcher(chc); //  current char is [A-Z]</span>
<span class="nc bnc" id="L114" title="All 4 branches missed.">    if (mp.matches() &amp;&amp; mcC.matches()){</span>
<span class="nc" id="L115">      return &quot;BND&quot;; // [a-z][A-Z]</span>
<span class="nc bnc" id="L116" title="All 4 branches missed.">    } else if (mp.matches() &amp;&amp; mc.matches()){</span>
<span class="nc" id="L117">      return &quot;ENG&quot;; // [a-z][a-z]</span>
<span class="nc bnc" id="L118" title="All 4 branches missed.">    } else if (mpC.matches() &amp;&amp; mcC.matches()){</span>
<span class="nc" id="L119">      return &quot;BCC&quot;; // [A-Z][A-Z]</span>
<span class="nc bnc" id="L120" title="All 6 branches missed.">    } else if (mp.matches() &amp;&amp; !mc.matches() &amp;&amp; !mcC.matches()){</span>
<span class="nc" id="L121">      return &quot;e1&quot;;  // [a-z][^A-Za-z]</span>
<span class="nc bnc" id="L122" title="All 6 branches missed.">    } else if (mc.matches() &amp;&amp; !mp.matches() &amp;&amp; !mpC.matches()) {</span>
<span class="nc" id="L123">      return &quot;e2&quot;;  // [^A-Za-z][a-z]</span>
<span class="nc bnc" id="L124" title="All 6 branches missed.">    } else if (mpC.matches() &amp;&amp; !mc.matches() &amp;&amp; !mcC.matches()){</span>
<span class="nc" id="L125">      return &quot;e3&quot;;  // [A-Z][^A-Za-z]</span>
<span class="nc bnc" id="L126" title="All 6 branches missed.">    } else if (mcC.matches() &amp;&amp; !mp.matches() &amp;&amp; !mpC.matches()) {</span>
<span class="nc" id="L127">      return &quot;e4&quot;;  // [^A-Za-z][A-Z]</span>
    } else {
<span class="nc" id="L129">      return &quot;&quot;;</span>
    }
  } // end isEnglish

  // the pattern used to be [\u00b7\\-\\.] which AFAICS matched only . because - wasn't escaped. CDM Nov 2007
<span class="nc" id="L134">  private static final Pattern patP = Pattern.compile(&quot;[-\u00b7.]&quot;);</span>

  private static String isEngPU(String Ep) {
<span class="nc" id="L137">    Matcher mp = patP.matcher(Ep);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">    if (mp.matches()) {</span>
<span class="nc" id="L139">      return &quot;1:EngPU&quot;;</span>
    } else {
<span class="nc" id="L141">      return &quot;&quot;;</span>
    }
  } //is EnglishPU


  private static void dictionaryFeaturesC(Class&lt;? extends CoreAnnotation&lt;String&gt;&gt; lbeginFieldName,
                                   Class&lt;? extends CoreAnnotation&lt;String&gt;&gt; lmiddleFieldName,
                                   Class&lt;? extends CoreAnnotation&lt;String&gt;&gt; lendFieldName,
                                   String dictSuffix, Collection&lt;String&gt; features, CoreLabel p, CoreLabel c, CoreLabel c2) {
<span class="nc" id="L150">      String lbegin = c.getString(lbeginFieldName);</span>
<span class="nc" id="L151">      String lmiddle = c.getString(lmiddleFieldName);</span>
<span class="nc" id="L152">      String lend = c.getString(lendFieldName);</span>
<span class="nc" id="L153">      features.add(lbegin+dictSuffix+&quot;-lb&quot;);</span>
<span class="nc" id="L154">      features.add(lmiddle+dictSuffix+&quot;-lm&quot;);</span>
<span class="nc" id="L155">      features.add(lend+dictSuffix+&quot;-le&quot;);</span>

<span class="nc" id="L157">      lbegin = p.getString(lbeginFieldName);</span>
<span class="nc" id="L158">      lmiddle = p.getString(lmiddleFieldName);</span>
<span class="nc" id="L159">      lend = p.getString(lendFieldName);</span>
<span class="nc" id="L160">      features.add(lbegin+dictSuffix+&quot;-plb&quot;);</span>
<span class="nc" id="L161">      features.add(lmiddle+dictSuffix+&quot;-plm&quot;);</span>
<span class="nc" id="L162">      features.add(lend+dictSuffix+&quot;-ple&quot;);</span>

<span class="nc" id="L164">      lbegin = c2.getString(lbeginFieldName);</span>
<span class="nc" id="L165">      lmiddle = c2.getString(lmiddleFieldName);</span>
<span class="nc" id="L166">      lend = c2.getString(lendFieldName);</span>
<span class="nc" id="L167">      features.add(lbegin+dictSuffix+&quot;-c2lb&quot;);</span>
<span class="nc" id="L168">      features.add(lmiddle+dictSuffix+&quot;-c2lm&quot;);</span>
<span class="nc" id="L169">      features.add(lend+dictSuffix+&quot;-c2le&quot;);</span>
<span class="nc" id="L170">  }</span>


  protected Collection&lt;String&gt; featuresC(PaddedList&lt;? extends CoreLabel&gt; cInfo, int loc) {
<span class="nc" id="L174">    Collection&lt;String&gt; features = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L175">    CoreLabel c = cInfo.get(loc);</span>
<span class="nc" id="L176">    CoreLabel c2 = cInfo.get(loc + 1);</span>
<span class="nc" id="L177">    CoreLabel c3 = cInfo.get(loc + 2);</span>
<span class="nc" id="L178">    CoreLabel p = cInfo.get(loc - 1);</span>
<span class="nc" id="L179">    CoreLabel p2 = cInfo.get(loc - 2);</span>
<span class="nc" id="L180">    CoreLabel p3 = cInfo.get(loc - 3);</span>
<span class="nc" id="L181">    String charc = c.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L182">    String charc2 = c2.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L183">    String charc3 = c3.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L184">    String charp = p.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L185">    String charp2 = p2.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L186">    String charp3 = p3.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L187">    Integer cI = c.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">    String uTypec = (cI != null ? cI.toString() : &quot;&quot;);</span>
<span class="nc" id="L189">    Integer c2I = c2.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">    String uTypec2 = (c2I != null ? c2I.toString() : &quot;&quot;);</span>
<span class="nc" id="L191">    Integer c3I = c3.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">    String uTypec3 = (c3I != null ? c3I.toString() : &quot;&quot;);</span>
<span class="nc" id="L193">    Integer pI = p.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">    String uTypep = (pI != null ? pI.toString() : &quot;&quot;);</span>
<span class="nc" id="L195">    Integer p2I = p2.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">    String uTypep2 = (p2I != null ? p2I.toString() : &quot;&quot;);</span>

    /* N-gram features. N is upto 2. */

<span class="nc bnc" id="L200" title="All 2 branches missed.">    if (flags.useWord1) {</span>
      // features.add(charc +&quot;c&quot;);
      // features.add(charc2+&quot;c2&quot;);
      // features.add(charp +&quot;p&quot;);
      // features.add(charp + charc  +&quot;pc&quot;);
      // features.add(charc + charc2  +&quot;cc2&quot;);
      // cdm: need hyphen so you can see which of charp or charc2 is null....
      // features.add(charp + &quot;-&quot; + charc2 + &quot;pc2&quot;);

<span class="nc" id="L209">      features.add(charc +&quot;::c&quot;);</span>
<span class="nc" id="L210">      features.add(charc2+&quot;::c2&quot;);</span>
<span class="nc" id="L211">      features.add(charp +&quot;::p&quot;);</span>
<span class="nc" id="L212">      features.add(charp2 +&quot;::p2&quot;);</span>
      // trying to restore the features that Huishin described in SIGHAN 2005 paper
<span class="nc" id="L214">      features.add(charc +charc2  +&quot;::cn&quot;);</span>
<span class="nc" id="L215">      features.add(charc +charc3  +&quot;::cn2&quot;);</span>
<span class="nc" id="L216">      features.add(charp +charc  +&quot;::pc&quot;);</span>
<span class="nc" id="L217">      features.add(charp +charc2  +&quot;::pn&quot;);</span>
<span class="nc" id="L218">      features.add(charp2 +charp  +&quot;::p2p&quot;);</span>
<span class="nc" id="L219">      features.add(charp2 +charc  +&quot;::p2c&quot;);</span>
<span class="nc" id="L220">      features.add(charc2 +charc  +&quot;::n2c&quot;);</span>
    }

<span class="nc bnc" id="L223" title="All 4 branches missed.">    if (flags.dictionary != null || flags.serializedDictionary != null) {</span>
<span class="nc" id="L224">      dictionaryFeaturesC(CoreAnnotations.LBeginAnnotation.class, CoreAnnotations.LMiddleAnnotation.class, CoreAnnotations.LEndAnnotation.class,&quot;&quot;,features, p, c, c2);</span>
    }

<span class="nc bnc" id="L227" title="All 2 branches missed.">    if (flags.dictionary2 != null) {</span>
<span class="nc" id="L228">      dictionaryFeaturesC(CoreAnnotations.D2_LBeginAnnotation.class, CoreAnnotations.D2_LMiddleAnnotation.class, CoreAnnotations.D2_LEndAnnotation.class,&quot;-D2-&quot;,features, p, c, c2);</span>
    }

<span class="nc bnc" id="L231" title="All 6 branches missed.">    if (flags.useFeaturesC4gram || flags.useFeaturesC5gram || flags.useFeaturesC6gram) {</span>
<span class="nc" id="L232">      features.add(charp2 + charp  +&quot;p2p&quot;);</span>
<span class="nc" id="L233">      features.add(charp2 + &quot;p2&quot;);</span>
    }
<span class="nc bnc" id="L235" title="All 4 branches missed.">    if (flags.useFeaturesC5gram || flags.useFeaturesC6gram) {</span>
<span class="nc" id="L236">      features.add(charc3+&quot;c3&quot;);</span>
<span class="nc" id="L237">      features.add(charc2 + charc3 + &quot;c2c3&quot;);</span>
    }
<span class="nc bnc" id="L239" title="All 2 branches missed.">    if (flags.useFeaturesC6gram) {</span>
<span class="nc" id="L240">      features.add(charp3 + &quot;p3&quot;);</span>
<span class="nc" id="L241">      features.add(charp3 + charp2 + &quot;p3p2&quot;);</span>
    }

<span class="nc bnc" id="L244" title="All 6 branches missed.">    if (flags.useUnicodeType || flags.useUnicodeType4gram || flags.useUnicodeType5gram) {</span>
<span class="nc" id="L245">      features.add(uTypep + &quot;-&quot; + uTypec + &quot;-&quot; + uTypec2 + &quot;-uType3&quot;);</span>
    }
<span class="nc bnc" id="L247" title="All 4 branches missed.">    if (flags.useUnicodeType4gram || flags.useUnicodeType5gram) {</span>
<span class="nc" id="L248">      features.add(uTypep2 + &quot;-&quot; + uTypep + &quot;-&quot; + uTypec + &quot;-&quot; + uTypec2 + &quot;-uType4&quot;);</span>
    }
<span class="nc bnc" id="L250" title="All 2 branches missed.">    if (flags.useUnicodeType5gram) {</span>
<span class="nc" id="L251">      features.add(uTypep2 + &quot;-&quot; + uTypep + &quot;-&quot; + uTypec + &quot;-&quot; + uTypec2 + &quot;-&quot; + uTypec3 + &quot;-uType5&quot;);</span>
    }
<span class="nc bnc" id="L253" title="All 2 branches missed.">    if (flags.useUnicodeBlock) {</span>
<span class="nc" id="L254">      features.add(p.getString(CoreAnnotations.UBlockAnnotation.class) + &quot;-&quot; + c.getString(CoreAnnotations.UBlockAnnotation.class) + &quot;-&quot; + c2.getString(CoreAnnotations.UBlockAnnotation.class) + &quot;-uBlock&quot;);</span>
    }
<span class="nc bnc" id="L256" title="All 2 branches missed.">    if (flags.useShapeStrings) {</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">      if (flags.useShapeStrings1) {</span>
<span class="nc" id="L258">        features.add(p.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;ps&quot;);</span>
<span class="nc" id="L259">        features.add(c.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;cs&quot;);</span>
<span class="nc" id="L260">        features.add(c2.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;c2s&quot;);</span>
      }
<span class="nc bnc" id="L262" title="All 2 branches missed.">      if (flags.useShapeStrings3) {</span>
<span class="nc" id="L263">        features.add(p.getString(CoreAnnotations.ShapeAnnotation.class) + c.getString(CoreAnnotations.ShapeAnnotation.class) + c2.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;pscsc2s&quot;);</span>
      }
<span class="nc bnc" id="L265" title="All 2 branches missed.">      if (flags.useShapeStrings4) {</span>
<span class="nc" id="L266">        features.add(p2.getString(CoreAnnotations.ShapeAnnotation.class) + p.getString(CoreAnnotations.ShapeAnnotation.class) + c.getString(CoreAnnotations.ShapeAnnotation.class) + c2.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;p2spscsc2s&quot;);</span>
      }
<span class="nc bnc" id="L268" title="All 2 branches missed.">      if (flags.useShapeStrings5) {</span>
<span class="nc" id="L269">        features.add(p2.getString(CoreAnnotations.ShapeAnnotation.class) + p.getString(CoreAnnotations.ShapeAnnotation.class) + c.getString(CoreAnnotations.ShapeAnnotation.class) + c2.getString(CoreAnnotations.ShapeAnnotation.class) + c3.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;p2spscsc2sc3s&quot;);</span>
      }
    }

<span class="nc" id="L273">    features.add(&quot;cliqueC&quot;);</span>

<span class="nc" id="L275">    return features;</span>
  }


  private void dictionaryFeaturesCpC(Class&lt;? extends CoreAnnotation&lt;String&gt;&gt; lbeginFieldName,
                                     Class&lt;? extends CoreAnnotation&lt;String&gt;&gt; lmiddleFieldName,
                                     Class&lt;? extends CoreAnnotation&lt;String&gt;&gt; lendFieldName,
                                     String dictSuffix, Collection&lt;String&gt; features, CoreLabel p2, CoreLabel p, CoreLabel c, CoreLabel c2) {
<span class="nc" id="L283">    String lbegin = c.getString(lbeginFieldName);</span>
<span class="nc" id="L284">    String lmiddle = c.getString(lmiddleFieldName);</span>
<span class="nc" id="L285">    String lend = c.getString(lendFieldName);</span>
<span class="nc" id="L286">    features.add(lbegin+dictSuffix+&quot;-lb&quot;);</span>
<span class="nc" id="L287">    features.add(lmiddle+dictSuffix+&quot;-lm&quot;);</span>
<span class="nc" id="L288">    features.add(lend+dictSuffix+&quot;-le&quot;);</span>

<span class="nc" id="L290">    lbegin = p.getString(lbeginFieldName);</span>
<span class="nc" id="L291">    lmiddle = p.getString(lmiddleFieldName);</span>
<span class="nc" id="L292">    lend = p.get(lendFieldName);</span>
<span class="nc" id="L293">    features.add(lbegin+dictSuffix+&quot;-plb&quot;);</span>
<span class="nc" id="L294">    features.add(lmiddle+dictSuffix+&quot;-plm&quot;);</span>
<span class="nc" id="L295">    features.add(lend+dictSuffix+&quot;-ple&quot;);</span>

<span class="nc" id="L297">    lbegin = c2.getString(lbeginFieldName);</span>
<span class="nc" id="L298">    lmiddle = c2.getString(lmiddleFieldName);</span>
<span class="nc" id="L299">    lend = c2.getString(lendFieldName);</span>
<span class="nc" id="L300">    features.add(lbegin+dictSuffix+&quot;-c2lb&quot;);</span>
<span class="nc" id="L301">    features.add(lmiddle+dictSuffix+&quot;-c2lm&quot;);</span>
<span class="nc" id="L302">    features.add(lend+dictSuffix+&quot;-c2le&quot;);</span>

<span class="nc bnc" id="L304" title="All 2 branches missed.">    if (flags.useDictionaryConjunctions) {</span>
<span class="nc" id="L305">      String p2Lend = p2.getString(lendFieldName);</span>
<span class="nc" id="L306">      String pLend = p.getString(lendFieldName);</span>
<span class="nc" id="L307">      String pLbegin = p.getString(lbeginFieldName);</span>
<span class="nc" id="L308">      String cLbegin = c.getString(lbeginFieldName);</span>
<span class="nc" id="L309">      String cLmiddle = c.getString(lmiddleFieldName);</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">      if (flags.useDictionaryConjunctions3) {</span>
<span class="nc" id="L311">        features.add(pLend + cLbegin + cLmiddle + dictSuffix + &quot;-pcLconj1&quot;);</span>
      }
<span class="nc" id="L313">      features.add(p2Lend + pLend + cLbegin + cLmiddle + dictSuffix + &quot;-p2pcLconj1&quot;);</span>
<span class="nc" id="L314">      features.add(p2Lend + pLend + pLbegin + cLbegin + cLmiddle + dictSuffix + &quot;-p2pcLconj2&quot;);</span>
    }
<span class="nc" id="L316">  }</span>


  protected Collection&lt;String&gt; featuresCpC(PaddedList&lt;? extends CoreLabel&gt; cInfo, int loc) {
<span class="nc" id="L320">    Collection&lt;String&gt; features = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L321">    CoreLabel c = cInfo.get(loc);</span>
<span class="nc" id="L322">    CoreLabel c2 = cInfo.get(loc + 1);</span>
<span class="nc" id="L323">    CoreLabel c3 = cInfo.get(loc + 2);</span>
<span class="nc" id="L324">    CoreLabel p = cInfo.get(loc - 1);</span>
<span class="nc" id="L325">    CoreLabel p2 = cInfo.get(loc - 2);</span>
<span class="nc" id="L326">    CoreLabel p3 = cInfo.get(loc - 3);</span>

<span class="nc" id="L328">    String charc = c.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L329">    String charc2 = c2.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L330">    String charc3 = c3.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L331">    String charp = p.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L332">    String charp2 = p2.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L333">    String charp3 = p3.getString(CoreAnnotations.CharAnnotation.class);</span>

<span class="nc" id="L335">    Integer cI = c.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">    String uTypec = (cI != null ? cI.toString() : &quot;&quot;);</span>
<span class="nc" id="L337">    Integer c2I = c2.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">    String uTypec2 = (c2I != null ? c2I.toString() : &quot;&quot;);</span>
<span class="nc" id="L339">    Integer c3I = c3.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">    String uTypec3 = (c3I != null ? c3I.toString() : &quot;&quot;);</span>
<span class="nc" id="L341">    Integer pI = p.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">    String uTypep = (pI != null ? pI.toString() : &quot;&quot;);</span>
<span class="nc" id="L343">    Integer p2I = p2.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">    String uTypep2 = (p2I != null ? p2I.toString() : &quot;&quot;);</span>

<span class="nc bnc" id="L346" title="All 4 branches missed.">    if (flags.dictionary != null || flags.serializedDictionary != null) {</span>
<span class="nc" id="L347">      dictionaryFeaturesCpC(CoreAnnotations.LBeginAnnotation.class, CoreAnnotations.LMiddleAnnotation.class, CoreAnnotations.LEndAnnotation.class,&quot;&quot;,features, p2, p, c, c2);</span>
    }
<span class="nc bnc" id="L349" title="All 2 branches missed.">    if (flags.dictionary2 != null) {</span>
<span class="nc" id="L350">      dictionaryFeaturesCpC(CoreAnnotations.D2_LBeginAnnotation.class, CoreAnnotations.D2_LMiddleAnnotation.class, CoreAnnotations.D2_LEndAnnotation.class,&quot;-D2-&quot;,features, p2, p, c, c2);</span>
    }

    /*
     * N-gram features. N is upto 2.
     */
<span class="nc bnc" id="L356" title="All 2 branches missed.">    if (flags.useWord2) {</span>
      // features.add(charc +&quot;c&quot;);
      // features.add(charc2+&quot;c2&quot;);
      // features.add(charp +&quot;p&quot;);
      // features.add(charp + charc  +&quot;pc&quot;);
      // features.add(charc + charc2  +&quot;cc2&quot;);
      // // cdm: need hyphen so you can see which of charp or charc2 is null....
      // features.add(charp + &quot;-&quot; + charc2 + &quot;pc2&quot;);


<span class="nc" id="L366">      features.add(charc +&quot;::c&quot;);</span>
<span class="nc" id="L367">      features.add(charc2+&quot;::c1&quot;);</span>
<span class="nc" id="L368">      features.add(charp +&quot;::p&quot;);</span>
<span class="nc" id="L369">      features.add(charp2 +&quot;::p2&quot;);</span>
      // trying to restore the features that Huihsin described in SIGHAN 2005 paper
<span class="nc" id="L371">      features.add(charc +charc2  +&quot;::cn&quot;); // (*)</span>
<span class="nc" id="L372">      features.add(charp +charc  +&quot;::pc&quot;);</span>
<span class="nc" id="L373">      features.add(charp +charc2  +&quot;::pn&quot;);</span>
<span class="nc" id="L374">      features.add(charp2 +charp  +&quot;::p2p&quot;);</span>
<span class="nc" id="L375">      features.add(charp2 +charc  +&quot;::p2c&quot;);</span>
<span class="nc" id="L376">      features.add(charc2 +charc  +&quot;::n2c&quot;); // todo: this is messed up: Same as one above at (*); should be cn2 = charc + charc3 + &quot;::cn2&quot;</span>

    }
<span class="nc bnc" id="L379" title="All 6 branches missed.">    if (flags.useFeaturesCpC4gram || flags.useFeaturesCpC5gram || flags.useFeaturesCpC6gram) {</span>
      // todo: Both these features duplicate ones already in useWord2
<span class="nc" id="L381">      features.add(charp2 + charp  +&quot;p2p&quot;);</span>
<span class="nc" id="L382">      features.add(charp2 + &quot;p2&quot;);</span>
    }
<span class="nc bnc" id="L384" title="All 4 branches missed.">    if (flags.useFeaturesCpC5gram || flags.useFeaturesCpC6gram) {</span>
<span class="nc" id="L385">      features.add(charc3+&quot;c3&quot;);</span>
<span class="nc" id="L386">      features.add(charc2 + charc3 + &quot;c2c3&quot;);</span>
    }
<span class="nc bnc" id="L388" title="All 2 branches missed.">    if (flags.useFeaturesCpC6gram) {</span>
<span class="nc" id="L389">      features.add(charp3 + &quot;p3&quot;);</span>
<span class="nc" id="L390">      features.add(charp3 + charp2 + &quot;p3p2&quot;);</span>
    }
<span class="nc bnc" id="L392" title="All 2 branches missed.">    if (flags.useGoodForNamesCpC) {</span>
      // these 2 features should be distinctively good at biasing from
      // picking up a Chinese family name in the p2 or p3 positions:
      // familyName X X startWord AND familyName X startWord
      // But actually they seem to have negative value.
<span class="nc" id="L397">      features.add(charp2 + &quot;p2&quot;);</span>
<span class="nc" id="L398">      features.add(charp3 + &quot;p3&quot;);</span>
    }

<span class="nc bnc" id="L401" title="All 6 branches missed.">    if (flags.useUnicodeType || flags.useUnicodeType4gram || flags.useUnicodeType5gram) {</span>
<span class="nc" id="L402">      features.add(uTypep + &quot;-&quot; + uTypec + &quot;-&quot; + uTypec2 + &quot;-uType3&quot;);</span>
    }
<span class="nc bnc" id="L404" title="All 4 branches missed.">    if (flags.useUnicodeType4gram || flags.useUnicodeType5gram) {</span>
<span class="nc" id="L405">      features.add(uTypep2 + &quot;-&quot; + uTypep + &quot;-&quot; + uTypec + &quot;-&quot; + uTypec2 + &quot;-uType4&quot;);</span>
    }
<span class="nc bnc" id="L407" title="All 2 branches missed.">    if (flags.useUnicodeType5gram) {</span>
<span class="nc" id="L408">      features.add(uTypep2 + &quot;-&quot; + uTypep + &quot;-&quot; + uTypec + &quot;-&quot; + uTypec2 + &quot;-&quot; + uTypec3 + &quot;-uType5&quot;);</span>
    }
<span class="nc bnc" id="L410" title="All 2 branches missed.">    if (flags.useWordUTypeConjunctions2) {</span>
<span class="nc" id="L411">      features.add(uTypep + charc + &quot;putcc&quot;);</span>
<span class="nc" id="L412">      features.add(charp + uTypec + &quot;pccut&quot;);</span>
    }
<span class="nc bnc" id="L414" title="All 2 branches missed.">    if (flags.useWordUTypeConjunctions3) {</span>
<span class="nc" id="L415">      features.add(uTypep2 + uTypep + charc + &quot;p2utputcc&quot;);</span>
<span class="nc" id="L416">      features.add(uTypep + charc + uTypec2 + &quot;putccc2ut&quot;);</span>
<span class="nc" id="L417">      features.add(charc + uTypec2 + uTypec3 + &quot;ccc2utc3ut&quot;);</span>
    }
<span class="nc bnc" id="L419" title="All 2 branches missed.">    if (flags.useUnicodeBlock) {</span>
<span class="nc" id="L420">      features.add(p.getString(CoreAnnotations.UBlockAnnotation.class) + &quot;-&quot; + c.getString(CoreAnnotations.UBlockAnnotation.class) + &quot;-&quot; + c2.getString(CoreAnnotations.UBlockAnnotation.class) + &quot;-uBlock&quot;);</span>
    }

<span class="nc bnc" id="L423" title="All 2 branches missed.">    if (flags.useShapeStrings) {</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">      if (flags.useShapeStrings1) {</span>
<span class="nc" id="L425">        features.add(p.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;ps&quot;);</span>
<span class="nc" id="L426">        features.add(c.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;cs&quot;);</span>
<span class="nc" id="L427">        features.add(c2.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;c2s&quot;);</span>
      }
<span class="nc bnc" id="L429" title="All 2 branches missed.">      if (flags.useShapeStrings3) {</span>
<span class="nc" id="L430">        features.add(p.getString(CoreAnnotations.ShapeAnnotation.class) + c.getString(CoreAnnotations.ShapeAnnotation.class) + c2.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;pscsc2s&quot;);</span>
      }
<span class="nc bnc" id="L432" title="All 2 branches missed.">      if (flags.useShapeStrings4) {</span>
<span class="nc" id="L433">        features.add(p2.getString(CoreAnnotations.ShapeAnnotation.class) + p.getString(CoreAnnotations.ShapeAnnotation.class) + c.getString(CoreAnnotations.ShapeAnnotation.class) + c2.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;p2spscsc2s&quot;);</span>
      }
<span class="nc bnc" id="L435" title="All 2 branches missed.">      if (flags.useShapeStrings5) {</span>
<span class="nc" id="L436">        features.add(p2.getString(CoreAnnotations.ShapeAnnotation.class) + p.getString(CoreAnnotations.ShapeAnnotation.class) + c.getString(CoreAnnotations.ShapeAnnotation.class) + c2.getString(CoreAnnotations.ShapeAnnotation.class) + c3.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;p2spscsc2sc3s&quot;);</span>
      }
<span class="nc bnc" id="L438" title="All 2 branches missed.">      if (flags.useWordShapeConjunctions2) {</span>
<span class="nc" id="L439">        features.add(p.getString(CoreAnnotations.ShapeAnnotation.class) + charc + &quot;pscc&quot;);</span>
<span class="nc" id="L440">        features.add(charp + c.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;pccs&quot;);</span>
      }
<span class="nc bnc" id="L442" title="All 2 branches missed.">      if (flags.useWordShapeConjunctions3) {</span>
<span class="nc" id="L443">        features.add(p2.getString(CoreAnnotations.ShapeAnnotation.class) + p.getString(CoreAnnotations.ShapeAnnotation.class) + charc + &quot;p2spscc&quot;);</span>
<span class="nc" id="L444">        features.add(p.getString(CoreAnnotations.ShapeAnnotation.class) + charc + c2.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;psccc2s&quot;);</span>
<span class="nc" id="L445">        features.add(charc + c2.getString(CoreAnnotations.ShapeAnnotation.class) + c3.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;ccc2sc3s&quot;);</span>
      }
    }

    /*
      Radical N-gram features. N is upto 4.
      Smoothing method of N-gram, because there are too many characters in Chinese.
      (It works better than N-gram when they are used individually. less sparse)
    */

    char rcharc, rcharc2, rcharp, rcharp2;
<span class="nc bnc" id="L456" title="All 2 branches missed.">    if (charc.length()==0) { rcharc='n'; } else { rcharc= RadicalMap.getRadical(charc.charAt(0));}</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">    if (charc2.length()==0) { rcharc2='n'; } else { rcharc2=RadicalMap.getRadical(charc2.charAt(0));}</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">    if (charp.length()==0)  { rcharp='n';  } else { rcharp=RadicalMap.getRadical(charp.charAt(0));  }</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">    if (charp2.length()==0) { rcharp2='n'; } else { rcharp2=RadicalMap.getRadical(charp2.charAt(0));}</span>

<span class="nc bnc" id="L461" title="All 2 branches missed.">    if (flags.useRad2) {</span>
<span class="nc" id="L462">      features.add(rcharc+&quot;rc&quot;);</span>
<span class="nc" id="L463">      features.add(rcharc2+&quot;rc2&quot;);</span>
<span class="nc" id="L464">      features.add(rcharp+&quot;rp&quot;);</span>
<span class="nc" id="L465">      features.add(rcharp  +  rcharc+&quot;rprc&quot;);</span>
<span class="nc" id="L466">      features.add(rcharc +rcharc2 +&quot;rcrc2&quot;);</span>
<span class="nc" id="L467">      features.add(rcharp +  rcharc  +rcharc2 +&quot;rprcrc2&quot;);</span>
    }
<span class="nc bnc" id="L469" title="All 2 branches missed.">    if (flags.useRad2b) {</span>
<span class="nc" id="L470">      features.add(rcharc+&quot;rc&quot;);</span>
<span class="nc" id="L471">      features.add(rcharc2+&quot;rc2&quot;);</span>
<span class="nc" id="L472">      features.add(rcharp+&quot;rp&quot;);</span>
<span class="nc" id="L473">      features.add(rcharp  +  rcharc+&quot;rprc&quot;);</span>
<span class="nc" id="L474">      features.add(rcharc +rcharc2 +&quot;rcrc2&quot;);</span>
<span class="nc" id="L475">      features.add(rcharp2 +rcharp +&quot;rp2rp&quot;);</span>
    }

    /* Non-word dictionary: SEEN bi-gram marked as non-word.
     * This is frickin' useful.  I hadn't realized.  CDM Oct 2007.
     */
<span class="nc bnc" id="L481" title="All 2 branches missed.">    if (flags.useDict2) {</span>
<span class="nc" id="L482">      NonDict2 nd = new NonDict2(flags);</span>
<span class="nc" id="L483">      features.add(nd.checkDic(charp+charc, flags)+&quot;nondict&quot;);</span>
    }

<span class="nc bnc" id="L486" title="All 2 branches missed.">    if (flags.useOutDict2) {</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">      if (outDict == null) {</span>
<span class="nc" id="L488">        createOutDict();</span>
      }
<span class="nc" id="L490">      features.add(outDict.getW(charp+charc)+&quot;outdict&quot;);       // -1 0</span>
<span class="nc" id="L491">      features.add(outDict.getW(charc+charc2)+&quot;outdict&quot;);      // 0 1</span>
<span class="nc" id="L492">      features.add(outDict.getW(charp2+charp)+&quot;outdict&quot;);      // -2 -1</span>
<span class="nc" id="L493">      features.add(outDict.getW(charp2+charp+charc)+&quot;outdict&quot;);      // -2 -1 0</span>
<span class="nc" id="L494">      features.add(outDict.getW(charp3+charp2+charp)+&quot;outdict&quot;);      // -3 -2 -1</span>
<span class="nc" id="L495">      features.add(outDict.getW(charp+charc+charc2)+&quot;outdict&quot;);      // -1 0 1</span>
<span class="nc" id="L496">      features.add(outDict.getW(charc+charc2+charc3)+&quot;outdict&quot;);      // 0 1 2</span>
<span class="nc" id="L497">      features.add(outDict.getW(charp+charc+charc2+charc3)+&quot;outdict&quot;);      // -1 0 1 2</span>
    }

    /*
      (CTB/ASBC/HK/PK/MSR) POS information of each characters.
      If a character falls into some function categories,
      it is very likely there is a boundary.
      A lot of Chinese function words belong to single characters.
      This feature is also good for numbers and punctuations.
      DE* are grouped into DE.
    */
<span class="nc bnc" id="L508" title="All 10 branches missed.">    if (flags.useCTBChar2 || flags.useASBCChar2 || flags.useHKChar2</span>
        || flags.usePKChar2 || flags.useMSRChar2) {
      String[] tagsets;
      // the &quot;useChPos&quot; now only works for CTB and PK
<span class="nc bnc" id="L512" title="All 2 branches missed.">      if (flags.useChPos) {</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">        if(flags.useCTBChar2) {</span>
<span class="nc" id="L514">          tagsets = new String[]{&quot;AD&quot;, &quot;AS&quot;, &quot;BA&quot;, &quot;CC&quot;, &quot;CD&quot;, &quot;CS&quot;, &quot;DE&quot;, &quot;DT&quot;, &quot;ETC&quot;, &quot;IJ&quot;, &quot;JJ&quot;, &quot;LB&quot;, &quot;LC&quot;, &quot;M&quot;,  &quot;NN&quot;,  &quot;NR&quot;, &quot;NT&quot;, &quot;OD&quot;, &quot;P&quot;, &quot;PN&quot;, &quot;PU&quot;, &quot;SB&quot;, &quot;SP&quot;, &quot;VA&quot;, &quot;VC&quot;, &quot;VE&quot;, &quot;VV&quot; };</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">        } else if (flags.usePKChar2) {</span>
          //tagsets = new String[]{&quot;r&quot;, &quot;j&quot;, &quot;t&quot;, &quot;a&quot;, &quot;nz&quot;, &quot;l&quot;, &quot;vn&quot;, &quot;i&quot;, &quot;m&quot;, &quot;ns&quot;, &quot;nr&quot;, &quot;v&quot;, &quot;n&quot;, &quot;q&quot;, &quot;Ng&quot;, &quot;b&quot;, &quot;d&quot;, &quot;nt&quot;};
<span class="nc" id="L517">          tagsets = new String[]{&quot;2&quot;,&quot;3&quot;,&quot;4&quot;};</span>
        } else {
<span class="nc" id="L519">          throw new RuntimeException(&quot;only support settings for CTB and PK now.&quot;);</span>
        }
      } else {
        //logger.info(&quot;Using Derived features&quot;);
<span class="nc" id="L523">        tagsets = new String[]{&quot;2&quot;,&quot;3&quot;,&quot;4&quot;};</span>
      }

<span class="nc bnc" id="L526" title="All 2 branches missed.">      if (taDetector == null) {</span>
<span class="nc" id="L527">        createTADetector();</span>
      }
<span class="nc bnc" id="L529" title="All 2 branches missed.">      for (String tag : tagsets) {</span>
<span class="nc" id="L530">	features.add(taDetector.checkDic(tag+&quot;p&quot;, charp) + taDetector.checkDic(tag+&quot;i&quot;, charp) + taDetector.checkDic(tag+&quot;s&quot;, charc)+ taDetector.checkInDic(charp)+taDetector.checkInDic(charc)+ tag+ &quot;prep-sufc&quot; );</span>
        //features.add(&quot;|ctbchar2&quot;);
      }
    }

    /*
      In error analysis, we found English words and numbers are often separated.
      Rule 1: isNumber feature: check if the current and previous char is a number.
      Rule 2: Disambiguation of time point and time duration.
      Rule 3: isEnglish feature: check if the current and previous character is an english letter.
      Rule 4: English name feature: check if the current char is a conjunct pu for English first and last name, since there is no space between two names.
      Most of PUs are a good indicator for word boundary, but - and .  is a strong indicator that there is no boundry within a previous , a follow char and it.
    */

<span class="nc bnc" id="L544" title="All 2 branches missed.">    if (flags.useRule2) {</span>
      /* Reduplication features */
      // previous character == current character
<span class="nc bnc" id="L547" title="All 2 branches missed.">      if(charp.equals(charc)){ features.add(&quot;11-R2&quot;);}</span>
      // previous character == next character
<span class="nc bnc" id="L549" title="All 2 branches missed.">      if(charp.equals(charc2)){ features.add(&quot;22-R2&quot;);}</span>

      // current character == next next character
      // fire only when usePk and useHk are both false.
      // Notice: this should be (almost) the same as the &quot;22&quot; feature, but we keep it for now.
<span class="nc bnc" id="L554" title="All 4 branches missed.">      if( !flags.usePk &amp;&amp; !flags.useHk) {</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">        if(charc.equals(charc2)){features.add(&quot;33-R2&quot;);}</span>
      }

<span class="nc" id="L558">      char cur1 = ' ';</span>
<span class="nc" id="L559">      char cur2 = ' ';</span>
<span class="nc" id="L560">      char cur =  ' ';</span>
<span class="nc" id="L561">      char pre =  ' ';</span>
      // actually their length must be either 0 or 1
<span class="nc bnc" id="L563" title="All 2 branches missed.">      if (charc2.length() &gt; 0) { cur1 = charc2.charAt(0); }</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">      if (charc3.length() &gt; 0) { cur2 = charc3.charAt(0); }</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">      if (charc.length() &gt; 0) { cur = charc.charAt(0); }</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">      if (charp.length() &gt; 0) { pre = charp.charAt(0); }</span>

<span class="nc" id="L568">      String prer= String.valueOf(rcharp); // the radical of previous character</span>

<span class="nc" id="L570">      Pattern E = Pattern.compile(&quot;[a-zA-Z]&quot;);</span>
<span class="nc" id="L571">      Pattern N = Pattern.compile(&quot;[0-9]&quot;);</span>
<span class="nc" id="L572">      Matcher m = E.matcher(charp);</span>
<span class="nc" id="L573">      Matcher ce = E.matcher(charc);</span>
<span class="nc" id="L574">      Matcher pe = E.matcher(charp2);</span>
<span class="nc" id="L575">      Matcher cn = N.matcher(charc);</span>
<span class="nc" id="L576">      Matcher pn = N.matcher(charp2);</span>


      // if current and previous characters are numbers...
<span class="nc bnc" id="L580" title="All 8 branches missed.">      if (cur &gt;= '0' &amp;&amp; cur &lt;= '9'&amp;&amp; pre &gt;= '0' &amp;&amp; pre &lt;= '9'){</span>
<span class="nc bnc" id="L581" title="All 10 branches missed.">        if (cur == '9' &amp;&amp; pre == '1' &amp;&amp; cur1 == '9'&amp;&amp; cur2 &gt;= '0' &amp;&amp; cur2 &lt;= '9'){ //199x</span>
<span class="nc" id="L582">          features.add(&quot;YR-R2&quot;);</span>
        }else{
<span class="nc" id="L584">          features.add(&quot;2N-R2&quot;);</span>
        }

        // if current and previous characters are not both numbers
        // but previous char is a number
        // i.e. patterns like &quot;1N&quot; , &quot;2A&quot;, etc
<span class="nc bnc" id="L590" title="All 4 branches missed.">      } else if (pre &gt;= '0' &amp;&amp; pre &lt;= '9'){</span>
<span class="nc" id="L591">        features.add(&quot;1N-R2&quot;);</span>

        // if previous character is an English character
<span class="nc bnc" id="L594" title="All 2 branches missed.">      } else if(m.matches()){</span>
<span class="nc" id="L595">        features.add(&quot;E-R2&quot;);</span>

        // if the previous character contains no radical (and it exist)
<span class="nc bnc" id="L598" title="All 4 branches missed.">      } else if(prer.equals(&quot;.&quot;) &amp;&amp; charp.length() == 1){</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">        if(ce.matches()){</span>
<span class="nc" id="L600">          features.add(&quot;PU+E-R2&quot;);</span>
        }
<span class="nc bnc" id="L602" title="All 2 branches missed.">        if(pe.matches()){</span>
<span class="nc" id="L603">          features.add(&quot;E+PU-R2&quot;);</span>
        }
<span class="nc bnc" id="L605" title="All 2 branches missed.">        if(cn.matches()){</span>
<span class="nc" id="L606">          features.add(&quot;PU+N-R2&quot;);</span>
        }
<span class="nc bnc" id="L608" title="All 2 branches missed.">        if(pn.matches()){</span>
<span class="nc" id="L609">          features.add(&quot;N+PU-R2&quot;);</span>
        }
<span class="nc" id="L611">        features.add(&quot;PU-R2&quot;);</span>
      }

<span class="nc" id="L614">      String engType = isEnglish(charp, charc);</span>
<span class="nc" id="L615">      String engPU = isEngPU(charp);</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">      if ( ! engType.equals(&quot;&quot;))</span>
<span class="nc" id="L617">        features.add(engType);</span>
<span class="nc bnc" id="L618" title="All 4 branches missed.">      if ( ! engPU.equals(&quot;&quot;) &amp;&amp; ! engType.equals(&quot;&quot;)) {</span>
<span class="nc" id="L619">        StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L620">        sb.append(engPU).append(engType).append(&quot;R2&quot;);</span>
<span class="nc" id="L621">        features.add(sb.toString());</span>
      }
    }//end of use rule


    // features using &quot;Character.getType&quot; information!
<span class="nc" id="L627">    String origS = c.getString(CoreAnnotations.OriginalCharAnnotation.class);</span>
<span class="nc" id="L628">    char origC = ' ';</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">    if (origS.length() &gt; 0) { origC = origS.charAt(0); }</span>
<span class="nc" id="L630">    int type = Character.getType(origC);</span>
<span class="nc bnc" id="L631" title="All 4 branches missed.">    switch (type) {</span>
    case Character.UPPERCASE_LETTER: // A-Z and full-width A-Z
    case Character.LOWERCASE_LETTER: // a-z and full-width a-z
<span class="nc" id="L634">      features.add(&quot;CHARTYPE-LETTER&quot;);</span>
<span class="nc" id="L635">      break;</span>
    case Character.DECIMAL_DIGIT_NUMBER:
<span class="nc" id="L637">      features.add(&quot;CHARTYPE-DECIMAL_DIGIT_NUMBER&quot;);</span>
<span class="nc" id="L638">      break;</span>
    case Character.OTHER_LETTER: // mostly chinese chars
<span class="nc" id="L640">      features.add(&quot;CHARTYPE-OTHER_LETTER&quot;);</span>
<span class="nc" id="L641">      break;</span>
    default: // other types
<span class="nc" id="L643">      features.add(&quot;CHARTYPE-MISC&quot;);</span>
    }

<span class="nc" id="L646">    features.add(&quot;cliqueCpC&quot;);</span>

<span class="nc" id="L648">    return features;</span>
  } // end featuresCpC


  /** For a CRF, this shouldn't be necessary, since the features duplicate
   *  those from CpC, but Huihsin found some valuable, presumably becuase
   *  it modified the regularization a bit.
   *
   *  @param cInfo The list of characters
   *  @param loc Position of c in list
   *  @return Collection of String features (sparse set of boolean features
   */
  protected Collection&lt;String&gt; featuresCnC(PaddedList&lt;? extends CoreLabel&gt; cInfo, int loc) {
<span class="nc" id="L661">    Collection&lt;String&gt; features = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">    if (flags.useWordn) {</span>
<span class="nc" id="L663">      CoreLabel c = cInfo.get(loc);</span>
<span class="nc" id="L664">      CoreLabel c2 = cInfo.get(loc + 1);</span>
<span class="nc" id="L665">      CoreLabel p = cInfo.get(loc - 1);</span>
<span class="nc" id="L666">      CoreLabel p2 = cInfo.get(loc - 2);</span>
<span class="nc" id="L667">      String charc = c.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L668">      String charc2 = c2.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L669">      String charp = p.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L670">      String charp2 = p2.getString(CoreAnnotations.CharAnnotation.class);</span>

<span class="nc" id="L672">      features.add(charc +&quot;c&quot;);</span>
<span class="nc" id="L673">      features.add(charc2+&quot;c2&quot;);</span>
<span class="nc" id="L674">      features.add(charp +&quot;p&quot;);</span>
<span class="nc" id="L675">      features.add(charp2 + &quot;p2&quot;);</span>
<span class="nc" id="L676">      features.add(charp2 + charp  +&quot;p2p&quot;);</span>
<span class="nc" id="L677">      features.add(charp + charc  +&quot;pc&quot;);</span>
<span class="nc" id="L678">      features.add(charc + charc2  +&quot;cc2&quot;);</span>
<span class="nc" id="L679">      features.add(charp + &quot;-&quot; + charc2 + &quot;pc2&quot;);</span>
<span class="nc" id="L680">      features.add(&quot;cliqueCnC&quot;);</span>
    }
<span class="nc" id="L682">    return features;</span>
  } //end of CnC


  /** Second order clique features
   *
   *  @param cInfo The list of characters
   *  @param loc Position of c in list
   *  @return Collection of String features (sparse set of boolean features
   */
  protected Collection&lt;String&gt; featuresCpCp2C(PaddedList&lt;? extends CoreLabel&gt; cInfo, int loc) {
<span class="nc" id="L693">    Collection&lt;String&gt; features = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L694">    CoreLabel c = cInfo.get(loc);</span>
<span class="nc" id="L695">    CoreLabel c2 = cInfo.get(loc + 1);</span>
<span class="nc" id="L696">    CoreLabel c3 = cInfo.get(loc + 2);</span>
<span class="nc" id="L697">    CoreLabel p = cInfo.get(loc - 1);</span>
<span class="nc" id="L698">    CoreLabel p2 = cInfo.get(loc - 2);</span>
<span class="nc" id="L699">    CoreLabel p3 = cInfo.get(loc - 3);</span>

<span class="nc" id="L701">    String charc = c.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L702">    String charc2 = c2.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L703">    String charc3 = c3.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L704">    String charp = p.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L705">    String charp2 = p2.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L706">    String charp3 = p3.getString(CoreAnnotations.CharAnnotation.class);</span>

    // N-gram features. N is up to 3
<span class="nc bnc" id="L709" title="All 2 branches missed.">    if (flags.useWord3) {</span>
<span class="nc" id="L710">      features.add(charc +&quot;::c&quot;);</span>
<span class="nc" id="L711">      features.add(charc2+&quot;::n&quot;);</span>
<span class="nc" id="L712">      features.add(charp +&quot;::p&quot;);</span>
<span class="nc" id="L713">      features.add(charp2 +&quot;::p2&quot;);</span>
      // trying to restore the features that Huihsin described in SIGHAN 2005 paper
<span class="nc" id="L715">      features.add(charc + charc2  +&quot;::cn&quot;);</span>
<span class="nc" id="L716">      features.add(charc + charc2 + charc3 + &quot;::cnn2&quot;);</span>
<span class="nc" id="L717">      features.add(charp + charc  +&quot;::pc&quot;);</span>
<span class="nc" id="L718">      features.add(charp + charc2  +&quot;::pn&quot;);</span>
<span class="nc" id="L719">      features.add(charp2 + charp  +&quot;::p2p&quot;);</span>
<span class="nc" id="L720">      features.add(charp3 + charp2 + charp + &quot;::p3p2p&quot;);</span>
<span class="nc" id="L721">      features.add(charp2 + charc  +&quot;::p2c&quot;);</span>
<span class="nc" id="L722">      features.add(charc + charc3  +&quot;::cn2&quot;);</span>

    }

<span class="nc bnc" id="L726" title="All 2 branches missed.">    if (flags.useShapeStrings) {</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">      if (flags.useShapeStrings1) {</span>
<span class="nc" id="L728">        features.add(p.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;ps&quot;);</span>
<span class="nc" id="L729">        features.add(c.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;cs&quot;);</span>
<span class="nc" id="L730">        features.add(c2.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;c2s&quot;);</span>
      }
<span class="nc bnc" id="L732" title="All 2 branches missed.">      if (flags.useShapeStrings3) {</span>
<span class="nc" id="L733">        features.add(p.getString(CoreAnnotations.ShapeAnnotation.class) + c.getString(CoreAnnotations.ShapeAnnotation.class) + c2.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;pscsc2s&quot;);</span>
      }
<span class="nc bnc" id="L735" title="All 2 branches missed.">      if (flags.useShapeStrings4) {</span>
<span class="nc" id="L736">        features.add(p2.getString(CoreAnnotations.ShapeAnnotation.class) + p.getString(CoreAnnotations.ShapeAnnotation.class) + c.getString(CoreAnnotations.ShapeAnnotation.class) + c2.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;p2spscsc2s&quot;);</span>
      }
<span class="nc bnc" id="L738" title="All 2 branches missed.">      if (flags.useShapeStrings5) {</span>
<span class="nc" id="L739">        features.add(p2.getString(CoreAnnotations.ShapeAnnotation.class) + p.getString(CoreAnnotations.ShapeAnnotation.class) + c.getString(CoreAnnotations.ShapeAnnotation.class) + c2.getString(CoreAnnotations.ShapeAnnotation.class) + c3.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;p2spscsc2sc3s&quot;);</span>
      }
<span class="nc bnc" id="L741" title="All 2 branches missed.">      if (flags.useWordShapeConjunctions2) {</span>
<span class="nc" id="L742">        features.add(p.getString(CoreAnnotations.ShapeAnnotation.class) + charc + &quot;pscc&quot;);</span>
<span class="nc" id="L743">        features.add(charp + c.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;pccs&quot;);</span>
      }
<span class="nc bnc" id="L745" title="All 2 branches missed.">      if (flags.useWordShapeConjunctions3) {</span>
<span class="nc" id="L746">        features.add(p2.getString(CoreAnnotations.ShapeAnnotation.class) + p.getString(CoreAnnotations.ShapeAnnotation.class) + charc + &quot;p2spscc&quot;);</span>
<span class="nc" id="L747">        features.add(p.getString(CoreAnnotations.ShapeAnnotation.class) + charc + c2.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;psccc2s&quot;);</span>
<span class="nc" id="L748">        features.add(charc + c2.getString(CoreAnnotations.ShapeAnnotation.class) + c3.getString(CoreAnnotations.ShapeAnnotation.class) + &quot;ccc2sc3s&quot;);</span>
      }
    }

    /*
      Radical N-gram features. N is upto 4.
      Smoothing method of N-gram, because there are too many characters in Chinese.
      (It works better than N-gram when they are used individually. less sparse)
    */

    char rcharc, rcharc2, rcharp, rcharp2;
<span class="nc bnc" id="L759" title="All 2 branches missed.">    if (charc.length()==0) { rcharc='n'; } else { rcharc= RadicalMap.getRadical(charc.charAt(0));}</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">    if (charc2.length()==0) { rcharc2='n'; } else { rcharc2=RadicalMap.getRadical(charc2.charAt(0));}</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">    if (charp.length()==0)  { rcharp='n';  } else { rcharp=RadicalMap.getRadical(charp.charAt(0));  }</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">    if (charp2.length()==0) { rcharp2='n'; } else { rcharp2=RadicalMap.getRadical(charp2.charAt(0));}</span>

<span class="nc bnc" id="L764" title="All 2 branches missed.">    if (flags.useRad2) {</span>
<span class="nc" id="L765">      features.add(rcharc+&quot;rc&quot;);</span>
<span class="nc" id="L766">      features.add(rcharc2+&quot;rc2&quot;);</span>
<span class="nc" id="L767">      features.add(rcharp+&quot;rp&quot;);</span>
<span class="nc" id="L768">      features.add(rcharp  +  rcharc+&quot;rprc&quot;);</span>
<span class="nc" id="L769">      features.add(rcharc +rcharc2 +&quot;rcrc2&quot;);</span>
<span class="nc" id="L770">      features.add(rcharp +  rcharc  +rcharc2 +&quot;rprcrc2&quot;);</span>
    }
<span class="nc bnc" id="L772" title="All 2 branches missed.">    if (flags.useRad2b) {</span>
<span class="nc" id="L773">      features.add(rcharc+&quot;rc&quot;);</span>
<span class="nc" id="L774">      features.add(rcharc2+&quot;rc2&quot;);</span>
<span class="nc" id="L775">      features.add(rcharp+&quot;rp&quot;);</span>
<span class="nc" id="L776">      features.add(rcharp  +  rcharc+&quot;rprc&quot;);</span>
<span class="nc" id="L777">      features.add(rcharc +rcharc2 +&quot;rcrc2&quot;);</span>
<span class="nc" id="L778">      features.add(rcharp2 +rcharp +&quot;rp2rp&quot;);</span>
    }

<span class="nc" id="L781">    features.add(&quot;cliqueCpCp2C&quot;);</span>

<span class="nc" id="L783">    return features;</span>
  } // end featuresCpCp2C


  protected Collection&lt;String&gt; featuresCpCp2Cp3C(PaddedList&lt;? extends CoreLabel&gt; cInfo, int loc) {
<span class="nc" id="L788">    Collection&lt;String&gt; features = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L789" title="All 4 branches missed.">    if (flags.use4Clique &amp;&amp; flags.maxLeft &gt;= 3) {</span>
<span class="nc" id="L790">      CoreLabel c = cInfo.get(loc);</span>
<span class="nc" id="L791">      CoreLabel c2 = cInfo.get(loc + 1);</span>
<span class="nc" id="L792">      CoreLabel p = cInfo.get(loc - 1);</span>
<span class="nc" id="L793">      CoreLabel p2 = cInfo.get(loc - 2);</span>
<span class="nc" id="L794">      CoreLabel p3 = cInfo.get(loc - 3);</span>
<span class="nc" id="L795">      String charc = c.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L796">      String charp = p.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L797">      String charp2 = p2.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L798">      String charp3 = p3.getString(CoreAnnotations.CharAnnotation.class);</span>
<span class="nc" id="L799">      Integer cI = c.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">      String uTypec = (cI != null ? cI.toString() : &quot;&quot;);</span>
<span class="nc" id="L801">      Integer c2I = c2.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">      String uTypec2 = (c2I != null ? c2I.toString() : &quot;&quot;);</span>
<span class="nc" id="L803">      Integer pI = p.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">      String uTypep = (pI != null ? pI.toString() : &quot;&quot;);</span>
<span class="nc" id="L805">      Integer p2I = p2.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">      String uTypep2 = (p2I != null ? p2I.toString() : &quot;&quot;);</span>
<span class="nc" id="L807">      Integer p3I = p3.get(CoreAnnotations.UTypeAnnotation.class);</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">      String uTypep3 = (p3I != null ? p3I.toString() : &quot;&quot;);</span>


<span class="nc bnc" id="L811" title="All 2 branches missed.">      if (flags.useLongSequences) {</span>
<span class="nc" id="L812">        features.add(charp3 + charp2 + charp + charc + &quot;p3p2pc&quot;);</span>
      }
<span class="nc bnc" id="L814" title="All 4 branches missed.">      if (flags.useUnicodeType4gram || flags.useUnicodeType5gram) {</span>
<span class="nc" id="L815">        features.add(uTypep3 + &quot;-&quot; + uTypep2 + &quot;-&quot; + uTypep + &quot;-&quot; + uTypec + &quot;-uType4&quot;);</span>
      }
<span class="nc bnc" id="L817" title="All 2 branches missed.">      if (flags.useUnicodeType5gram) {</span>
<span class="nc" id="L818">        features.add(uTypep3 + &quot;-&quot; + uTypep2 + &quot;-&quot; + uTypep + &quot;-&quot; + uTypec + &quot;-&quot; + uTypec2 + &quot;-uType5&quot;);</span>
      }
<span class="nc" id="L820">      features.add(&quot;cliqueCpCp2Cp3C&quot;);</span>
    }
<span class="nc" id="L822">    return features;</span>
  }

  private static final long serialVersionUID = 8197648719208850960L;

} // end class Gale2007ChineseSegmenterFeatureFactory

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>