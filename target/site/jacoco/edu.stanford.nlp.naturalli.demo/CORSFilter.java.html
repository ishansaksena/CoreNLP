<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CORSFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Stanford CoreNLP</a> &gt; <a href="index.source.html" class="el_package">edu.stanford.nlp.naturalli.demo</a> &gt; <span class="el_source">CORSFilter.java</span></div><h1>CORSFilter.java</h1><pre class="source lang-java linenums">/**
 * Copyright 2012-2013 eBay Software Foundation, All Rights Reserved.
 * 
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 * 
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
package edu.stanford.nlp.naturalli.demo;

import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Set;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * &lt;p&gt;
 * A {@link Filter} that enable client-side cross-origin requests by
 * implementing W3C's CORS (&lt;b&gt;C&lt;/b&gt;ross-&lt;b&gt;O&lt;/b&gt;rigin &lt;b&gt;R&lt;/b&gt;esource
 * &lt;b&gt;S&lt;/b&gt;haring) specification for resources. Each {@link HttpServletRequest}
 * request is inspected as per specification, and appropriate response headers
 * are added to {@link HttpServletResponse}.
 * &lt;/p&gt;
 * 
 * &lt;p&gt;
 * By default, it also sets following request attributes, that helps to
 * determine nature of request downstream.
 * &lt;ul&gt;
 * &lt;li&gt;&lt;b&gt;cors.isCorsRequest:&lt;/b&gt; Flag to determine if request is a CORS
 * request. Set to &lt;code&gt;true&lt;/code&gt; if CORS request; &lt;code&gt;false&lt;/code&gt;
 * otherwise.&lt;/li&gt;
 * &lt;li&gt;&lt;b&gt;cors.request.origin:&lt;/b&gt; The Origin URL.&lt;/li&gt;
 * &lt;li&gt;&lt;b&gt;cors.request.type:&lt;/b&gt; Type of request. Values: &lt;code&gt;simple&lt;/code&gt; or
 * &lt;code&gt;preflight&lt;/code&gt; or &lt;code&gt;not_cors&lt;/code&gt; or &lt;code&gt;invalid_cors&lt;/code&gt;&lt;/li&gt;
 * &lt;li&gt;&lt;b&gt;cors.request.headers:&lt;/b&gt; Request headers sent as
 * 'Access-Control-Request-Headers' header, for pre-flight request.&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;/p&gt;
 * 
 * @author Mohit Soni
 * @see &lt;a href=&quot;http://www.w3.org/TR/cors/&quot;&gt;CORS specification&lt;/a&gt;
 *
 * note[Gabor]: STOLEN SHAMELESSLY FROM https://github.com/eBay/cors-filter/blob/master/LICENSE
 * DO NOT DISTRIBUTE WITH CORENLP!!!!
 * 
 */
public final class CORSFilter implements Filter {
    // ----------------------------------------------------- Instance variables
    /**
     * Holds filter configuration.
     */
    private FilterConfig filterConfig;

    /**
     * A {@link Collection} of origins consisting of zero or more origins that
     * are allowed access to the resource.
     */
    private final Collection&lt;String&gt; allowedOrigins;

    /**
     * Determines if any origin is allowed to make request.
     */
    private boolean anyOriginAllowed;

    /**
     * A {@link Collection} of methods consisting of zero or more methods that
     * are supported by the resource.
     */
    private final Collection&lt;String&gt; allowedHttpMethods;

    /**
     * A {@link Collection} of headers consisting of zero or more header field
     * names that are supported by the resource.
     */
    private final Collection&lt;String&gt; allowedHttpHeaders;

    /**
     * A {@link Collection} of exposed headers consisting of zero or more header
     * field names of headers other than the simple response headers that the
     * resource might use and can be exposed.
     */
    private final Collection&lt;String&gt; exposedHeaders;

    /**
     * A supports credentials flag that indicates whether the resource supports
     * user credentials in the request. It is true when the resource does and
     * false otherwise.
     */
    private boolean supportsCredentials;

    /**
     * Indicates (in seconds) how long the results of a pre-flight request can
     * be cached in a pre-flight result cache.
     */
    private long preflightMaxAge;

    /**
     * Controls access log logging.
     */
    private boolean loggingEnabled;

    /**
     * Determines if the request should be decorated or not.
     */
    private boolean decorateRequest;

    // --------------------------------------------------------- Constructor(s)
<span class="nc" id="L129">    public CORSFilter() {</span>
<span class="nc" id="L130">        this.allowedOrigins = new HashSet&lt;&gt;();</span>
<span class="nc" id="L131">        this.allowedHttpMethods = new HashSet&lt;&gt;();</span>
<span class="nc" id="L132">        this.allowedHttpHeaders = new HashSet&lt;&gt;();</span>
<span class="nc" id="L133">        this.exposedHeaders = new HashSet&lt;&gt;();</span>
<span class="nc" id="L134">    }</span>

    // --------------------------------------------------------- Public methods
    @Override
    public void doFilter(final ServletRequest servletRequest,
            final ServletResponse servletResponse,
            final FilterChain filterChain) throws IOException,
            ServletException {
<span class="nc bnc" id="L142" title="All 4 branches missed.">        if (!(servletRequest instanceof HttpServletRequest)</span>
                || !(servletResponse instanceof HttpServletResponse)) {
<span class="nc" id="L144">            String message =</span>
                    &quot;CORS doesn't support non-HTTP request or response.&quot;;
<span class="nc" id="L146">            throw new ServletException(message);</span>
        }

        // Safe to downcast at this point.
<span class="nc" id="L150">        HttpServletRequest request = (HttpServletRequest) servletRequest;</span>
<span class="nc" id="L151">        HttpServletResponse response = (HttpServletResponse) servletResponse;</span>

        // Determines the CORS request type.
<span class="nc" id="L154">        CORSFilter.CORSRequestType requestType = checkRequestType(request);</span>

        // Adds CORS specific attributes to request.
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (decorateRequest) {</span>
<span class="nc" id="L158">            CORSFilter.decorateCORSProperties(request, requestType);</span>
        }
<span class="nc bnc" id="L160" title="All 5 branches missed.">        switch (requestType) {</span>
        case SIMPLE:
            // Handles a Simple CORS request.
<span class="nc" id="L163">            this.handleSimpleCORS(request, response, filterChain);</span>
<span class="nc" id="L164">            break;</span>
        case ACTUAL:
            // Handles an Actual CORS request.
<span class="nc" id="L167">            this.handleSimpleCORS(request, response, filterChain);</span>
<span class="nc" id="L168">            break;</span>
        case PRE_FLIGHT:
            // Handles a Pre-flight CORS request.
<span class="nc" id="L171">            this.handlePreflightCORS(request, response, filterChain);</span>
<span class="nc" id="L172">            break;</span>
        case NOT_CORS:
            // Handles a Normal request that is not a cross-origin request.
<span class="nc" id="L175">            this.handleNonCORS(request, response, filterChain);</span>
<span class="nc" id="L176">            break;</span>
        default:
            // Handles a CORS request that violates specification.
<span class="nc" id="L179">            this.handleInvalidCORS(request, response, filterChain);</span>
            break;
        }
<span class="nc" id="L182">    }</span>

    @Override
    public void init(final FilterConfig filterConfig) throws ServletException {
        // Initialize defaults
<span class="nc" id="L187">        parseAndStore(DEFAULT_ALLOWED_ORIGINS, DEFAULT_ALLOWED_HTTP_METHODS,</span>
                DEFAULT_ALLOWED_HTTP_HEADERS, DEFAULT_EXPOSED_HEADERS,
                DEFAULT_SUPPORTS_CREDENTIALS, DEFAULT_PREFLIGHT_MAXAGE,
                DEFAULT_LOGGING_ENABLED, DEFAULT_DECORATE_REQUEST);

<span class="nc" id="L192">        this.filterConfig = filterConfig;</span>
<span class="nc" id="L193">        this.loggingEnabled = false;</span>

<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (filterConfig != null) {</span>
<span class="nc" id="L196">            String configAllowedOrigins =</span>
<span class="nc" id="L197">                    filterConfig.getInitParameter(PARAM_CORS_ALLOWED_ORIGINS);</span>
<span class="nc" id="L198">            String configAllowedHttpMethods =</span>
<span class="nc" id="L199">                    filterConfig.getInitParameter(PARAM_CORS_ALLOWED_METHODS);</span>
<span class="nc" id="L200">            String configAllowedHttpHeaders =</span>
<span class="nc" id="L201">                    filterConfig.getInitParameter(PARAM_CORS_ALLOWED_HEADERS);</span>
<span class="nc" id="L202">            String configExposedHeaders =</span>
<span class="nc" id="L203">                    filterConfig.getInitParameter(PARAM_CORS_EXPOSED_HEADERS);</span>
<span class="nc" id="L204">            String configSupportsCredentials =</span>
                    filterConfig
<span class="nc" id="L206">                            .getInitParameter(PARAM_CORS_SUPPORT_CREDENTIALS);</span>
<span class="nc" id="L207">            String configPreflightMaxAge =</span>
<span class="nc" id="L208">                    filterConfig.getInitParameter(PARAM_CORS_PREFLIGHT_MAXAGE);</span>
<span class="nc" id="L209">            String configLoggingEnabled =</span>
<span class="nc" id="L210">                    filterConfig.getInitParameter(PARAM_CORS_LOGGING_ENABLED);</span>
<span class="nc" id="L211">            String configDecorateRequest =</span>
<span class="nc" id="L212">                    filterConfig.getInitParameter(PARAM_CORS_REQUEST_DECORATE);</span>

<span class="nc" id="L214">            parseAndStore(configAllowedOrigins, configAllowedHttpMethods,</span>
                    configAllowedHttpHeaders,
                    configExposedHeaders, configSupportsCredentials,
                    configPreflightMaxAge,
                    configLoggingEnabled, configDecorateRequest);
        }
<span class="nc" id="L220">    }</span>

    // --------------------------------------------------------------- Handlers
    /**
     * Handles a CORS request of type {@link CORSRequestType}.SIMPLE.
     * 
     * @param request
     *            The {@link HttpServletRequest} object.
     * @param response
     *            The {@link HttpServletResponse} object.
     * @param filterChain
     *            The {@link FilterChain} object.
     * @throws IOException
     * @throws ServletException
     * @see &lt;a href=&quot;http://www.w3.org/TR/cors/#resource-requests&quot;&gt;Simple
     *      Cross-Origin Request, Actual Request, and Redirects&lt;/a&gt;
     */
    public void handleSimpleCORS(final HttpServletRequest request,
            final HttpServletResponse response, final FilterChain filterChain)
            throws IOException, ServletException {
<span class="nc" id="L240">        CORSFilter.CORSRequestType requestType =</span>
<span class="nc" id="L241">                checkRequestType(request);</span>
<span class="nc bnc" id="L242" title="All 4 branches missed.">        if (!(requestType == CORSFilter.CORSRequestType.SIMPLE</span>
        || requestType == CORSFilter.CORSRequestType.ACTUAL)) {
<span class="nc" id="L244">            String message =</span>
                    &quot;Expects a HttpServletRequest object of type &quot;
                            + CORSFilter.CORSRequestType.SIMPLE
                            + &quot; or &quot;
                            + CORSFilter.CORSRequestType.ACTUAL;
<span class="nc" id="L249">            throw new IllegalArgumentException(message);</span>
        }

<span class="nc" id="L252">        final String origin =</span>
<span class="nc" id="L253">                request.getHeader(CORSFilter.REQUEST_HEADER_ORIGIN);</span>
<span class="nc" id="L254">        final String method = request.getMethod();</span>

        // Section 6.1.2
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (!isOriginAllowed(origin)) {</span>
<span class="nc" id="L258">            handleInvalidCORS(request, response, filterChain);</span>
<span class="nc" id="L259">            return;</span>
        }

<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (!allowedHttpMethods.contains(method)) {</span>
<span class="nc" id="L263">            handleInvalidCORS(request, response, filterChain);</span>
<span class="nc" id="L264">            return;</span>
        }

        // Section 6.1.3
        // Add a single Access-Control-Allow-Origin header.
<span class="nc bnc" id="L269" title="All 4 branches missed.">        if (anyOriginAllowed &amp;&amp; !supportsCredentials) {</span>
            // If resource doesn't support credentials and if any origin is
            // allowed
            // to make CORS request, return header with '*'.
<span class="nc" id="L273">            response.addHeader(</span>
                    CORSFilter.RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN, &quot;*&quot;);
        } else {
            // If the resource supports credentials add a single
            // Access-Control-Allow-Origin header, with the value of the Origin
            // header as value.
<span class="nc" id="L279">            response.addHeader(</span>
                    CORSFilter.RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN,
                    origin);
        }
        // Section 6.1.3
        // If the resource supports credentials, add a single
        // Access-Control-Allow-Credentials header with the case-sensitive
        // string &quot;true&quot; as value.
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (supportsCredentials) {</span>
<span class="nc" id="L288">            response.addHeader(</span>
                    CORSFilter.RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_CREDENTIALS,
                    &quot;true&quot;);
        }

        // Section 6.1.4
        // If the list of exposed headers is not empty add one or more
        // Access-Control-Expose-Headers headers, with as values the header
        // field names given in the list of exposed headers.
<span class="nc bnc" id="L297" title="All 4 branches missed.">        if ((exposedHeaders != null) &amp;&amp; (exposedHeaders.size() &gt; 0)) {</span>
<span class="nc" id="L298">            String exposedHeadersString = join(exposedHeaders, &quot;,&quot;);</span>
<span class="nc" id="L299">            response.addHeader(</span>
                    CORSFilter.RESPONSE_HEADER_ACCESS_CONTROL_EXPOSE_HEADERS,
                    exposedHeadersString);
        }

        // Forward the request down the filter chain.
<span class="nc" id="L305">        filterChain.doFilter(request, response);</span>
<span class="nc" id="L306">    }</span>

    /**
     * Handles CORS pre-flight request.
     * 
     * @param request
     *            The {@link HttpServletRequest} object.
     * @param response
     *            The {@link HttpServletResponse} object.
     * @param filterChain
     *            The {@link FilterChain} object.
     * @throws IOException
     * @throws ServletException
     */
    public void handlePreflightCORS(final HttpServletRequest request,
            final HttpServletResponse response, final FilterChain filterChain)
            throws IOException, ServletException {
<span class="nc" id="L323">        CORSRequestType requestType = checkRequestType(request);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">        if (requestType != CORSRequestType.PRE_FLIGHT) {</span>
<span class="nc" id="L325">            throw new IllegalArgumentException(</span>
                    &quot;Expects a HttpServletRequest object of type &quot;
<span class="nc" id="L327">                            + CORSRequestType.PRE_FLIGHT.name().toLowerCase());</span>
        }

<span class="nc" id="L330">        final String origin =</span>
<span class="nc" id="L331">                request.getHeader(CORSFilter.REQUEST_HEADER_ORIGIN);</span>

        // Section 6.2.2
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (!isOriginAllowed(origin)) {</span>
<span class="nc" id="L335">            handleInvalidCORS(request, response, filterChain);</span>
<span class="nc" id="L336">            return;</span>
        }

        // Section 6.2.3
<span class="nc" id="L340">        String accessControlRequestMethod =</span>
<span class="nc" id="L341">                request.getHeader(CORSFilter.REQUEST_HEADER_ACCESS_CONTROL_REQUEST_METHOD);</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">        if (accessControlRequestMethod == null</span>
                || (!HTTP_METHODS
<span class="nc bnc" id="L344" title="All 2 branches missed.">                        .contains(accessControlRequestMethod.trim()))) {</span>
<span class="nc" id="L345">            handleInvalidCORS(request, response, filterChain);</span>
<span class="nc" id="L346">            return;</span>
        } else {
<span class="nc" id="L348">            accessControlRequestMethod = accessControlRequestMethod.trim();</span>
        }

        // Section 6.2.4
<span class="nc" id="L352">        String accessControlRequestHeadersHeader =</span>
<span class="nc" id="L353">                request.getHeader(CORSFilter.REQUEST_HEADER_ACCESS_CONTROL_REQUEST_HEADERS);</span>
<span class="nc" id="L354">        List&lt;String&gt; accessControlRequestHeaders = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">        if (accessControlRequestHeadersHeader != null</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">                &amp;&amp; !accessControlRequestHeadersHeader.trim().isEmpty()) {</span>
<span class="nc" id="L357">            String[] headers =</span>
<span class="nc" id="L358">                    accessControlRequestHeadersHeader.trim().split(&quot;,&quot;);</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">            for (String header : headers) {</span>
<span class="nc" id="L360">                accessControlRequestHeaders.add(header.trim().toLowerCase());</span>
            }
        }

        // Section 6.2.5
<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (!allowedHttpMethods.contains(accessControlRequestMethod)) {</span>
<span class="nc" id="L366">            handleInvalidCORS(request, response, filterChain);</span>
<span class="nc" id="L367">            return;</span>
        }

        // Section 6.2.6
<span class="nc bnc" id="L371" title="All 2 branches missed.">        if (!accessControlRequestHeaders.isEmpty()) {</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">            for (String header : accessControlRequestHeaders) {</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">                if (!allowedHttpHeaders.contains(header)) {</span>
<span class="nc" id="L374">                    handleInvalidCORS(request, response, filterChain);</span>
<span class="nc" id="L375">                    return;</span>
                }
<span class="nc" id="L377">            }</span>
        }

        // Section 6.2.7
<span class="nc bnc" id="L381" title="All 2 branches missed.">        if (supportsCredentials) {</span>
<span class="nc" id="L382">            response.addHeader(</span>
                    CORSFilter.RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN,
                    origin);
<span class="nc" id="L385">            response.addHeader(</span>
                    CORSFilter.RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_CREDENTIALS,
                    &quot;true&quot;);
        } else {
<span class="nc bnc" id="L389" title="All 2 branches missed.">            if (anyOriginAllowed) {</span>
<span class="nc" id="L390">                response.addHeader(</span>
                        CORSFilter.RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN,
                        &quot;*&quot;);
            } else {
<span class="nc" id="L394">                response.addHeader(</span>
                        CORSFilter.RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN,
                        origin);
            }
        }

        // Section 6.2.8
<span class="nc bnc" id="L401" title="All 2 branches missed.">        if (preflightMaxAge &gt; 0) {</span>
<span class="nc" id="L402">            response.addHeader(</span>
                    CORSFilter.RESPONSE_HEADER_ACCESS_CONTROL_MAX_AGE,
<span class="nc" id="L404">                    String.valueOf(preflightMaxAge));</span>
        }

        // Section 6.2.9
<span class="nc" id="L408">        response.addHeader(</span>
                CORSFilter.RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_METHODS,
                accessControlRequestMethod);

        // Section 6.2.10
<span class="nc bnc" id="L413" title="All 4 branches missed.">        if ((allowedHttpHeaders != null) &amp;&amp; (!allowedHttpHeaders.isEmpty())) {</span>
<span class="nc" id="L414">            response.addHeader(</span>
                    CORSFilter.RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_HEADERS,
<span class="nc" id="L416">                    join(allowedHttpHeaders, &quot;,&quot;));</span>
        }

        // Do not forward the request down the filter chain.
<span class="nc" id="L420">    }</span>

    /**
     * Handles a request, that's not a CORS request, but is a valid request i.e.
     * it is not a cross-origin request. This implementation, just forwards the
     * request down the filter chain.
     * 
     * @param request
     *            The {@link HttpServletRequest} object.
     * @param response
     *            The {@link HttpServletResponse} object.
     * @param filterChain
     *            The {@link FilterChain} object.
     * @throws IOException
     * @throws ServletException
     */
    public void handleNonCORS(final HttpServletRequest request,
            final HttpServletResponse response, final FilterChain filterChain)
            throws IOException, ServletException {
        // Let request pass.
<span class="nc" id="L440">        filterChain.doFilter(request, response);</span>
<span class="nc" id="L441">    }</span>

    /**
     * Handles a CORS request that violates specification.
     * 
     * @param request
     *            The {@link HttpServletRequest} object.
     * @param response
     *            The {@link HttpServletResponse} object.
     * @param filterChain
     *            The {@link FilterChain} object.
     * @throws IOException
     * @throws ServletException
     */
    public void handleInvalidCORS(final HttpServletRequest request,
            final HttpServletResponse response, final FilterChain filterChain) {
<span class="nc" id="L457">        String origin = request.getHeader(CORSFilter.REQUEST_HEADER_ORIGIN);</span>
<span class="nc" id="L458">        String method = request.getMethod();</span>
<span class="nc" id="L459">        String accessControlRequestHeaders =</span>
<span class="nc" id="L460">                request.getHeader(REQUEST_HEADER_ACCESS_CONTROL_REQUEST_HEADERS);</span>

<span class="nc" id="L462">        String message =</span>
                &quot;Invalid CORS request; Origin=&quot; + origin + &quot;;Method=&quot; + method;
<span class="nc bnc" id="L464" title="All 2 branches missed.">        if (accessControlRequestHeaders != null) {</span>
<span class="nc" id="L465">            message =</span>
                    message + &quot;;Access-Control-Request-Headers=&quot;
                            + accessControlRequestHeaders;
        }
<span class="nc" id="L469">        response.setContentType(&quot;text/plain&quot;);</span>
<span class="nc" id="L470">        response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L471">        response.resetBuffer();</span>

<span class="nc" id="L473">        log(message);</span>
<span class="nc" id="L474">    }</span>

    @Override
    public void destroy() {
        // NOOP
<span class="nc" id="L479">    }</span>

    // -------------------------------------------------------- Utility methods
    /**
     * Decorates the {@link HttpServletRequest}, with CORS attributes.
     * &lt;ul&gt;
     * &lt;li&gt;&lt;b&gt;cors.isCorsRequest:&lt;/b&gt; Flag to determine if request is a CORS
     * request. Set to &lt;code&gt;true&lt;/code&gt; if CORS request; &lt;code&gt;false&lt;/code&gt;
     * otherwise.&lt;/li&gt;
     * &lt;li&gt;&lt;b&gt;cors.request.origin:&lt;/b&gt; The Origin URL.&lt;/li&gt;
     * &lt;li&gt;&lt;b&gt;cors.request.type:&lt;/b&gt; Type of request. Values:
     * &lt;code&gt;simple&lt;/code&gt; or &lt;code&gt;preflight&lt;/code&gt; or &lt;code&gt;not_cors&lt;/code&gt; or
     * &lt;code&gt;invalid_cors&lt;/code&gt;&lt;/li&gt;
     * &lt;li&gt;&lt;b&gt;cors.request.headers:&lt;/b&gt; Request headers sent as
     * 'Access-Control-Request-Headers' header, for pre-flight request.&lt;/li&gt;
     * &lt;/ul&gt;
     * 
     * @param request
     *            The {@link HttpServletRequest} object.
     * @param corsRequestType
     *            The {@link CORSRequestType} object.
     */
    public static void decorateCORSProperties(final HttpServletRequest request,
            final CORSRequestType corsRequestType) {
<span class="nc bnc" id="L503" title="All 2 branches missed.">        if (request == null) {</span>
<span class="nc" id="L504">            throw new IllegalArgumentException(</span>
                    &quot;HttpServletRequest object is null&quot;);
        }

<span class="nc bnc" id="L508" title="All 2 branches missed.">        if (corsRequestType == null) {</span>
<span class="nc" id="L509">            throw new IllegalArgumentException(&quot;CORSRequestType object is null&quot;);</span>
        }

<span class="nc bnc" id="L512" title="All 5 branches missed.">        switch (corsRequestType) {</span>
        case SIMPLE:
<span class="nc" id="L514">            request.setAttribute(</span>
<span class="nc" id="L515">                    CORSFilter.HTTP_REQUEST_ATTRIBUTE_IS_CORS_REQUEST, true);</span>
<span class="nc" id="L516">            request.setAttribute(CORSFilter.HTTP_REQUEST_ATTRIBUTE_ORIGIN,</span>
<span class="nc" id="L517">                    request.getHeader(CORSFilter.REQUEST_HEADER_ORIGIN));</span>
<span class="nc" id="L518">            request.setAttribute(</span>
                    CORSFilter.HTTP_REQUEST_ATTRIBUTE_REQUEST_TYPE,
<span class="nc" id="L520">                    corsRequestType.name().toLowerCase());</span>
<span class="nc" id="L521">            break;</span>
        case ACTUAL:
<span class="nc" id="L523">            request.setAttribute(</span>
<span class="nc" id="L524">                    CORSFilter.HTTP_REQUEST_ATTRIBUTE_IS_CORS_REQUEST, true);</span>
<span class="nc" id="L525">            request.setAttribute(CORSFilter.HTTP_REQUEST_ATTRIBUTE_ORIGIN,</span>
<span class="nc" id="L526">                    request.getHeader(CORSFilter.REQUEST_HEADER_ORIGIN));</span>
<span class="nc" id="L527">            request.setAttribute(</span>
                    CORSFilter.HTTP_REQUEST_ATTRIBUTE_REQUEST_TYPE,
<span class="nc" id="L529">                    corsRequestType.name().toLowerCase());</span>
<span class="nc" id="L530">            break;</span>
        case PRE_FLIGHT:
<span class="nc" id="L532">            request.setAttribute(</span>
<span class="nc" id="L533">                    CORSFilter.HTTP_REQUEST_ATTRIBUTE_IS_CORS_REQUEST, true);</span>
<span class="nc" id="L534">            request.setAttribute(CORSFilter.HTTP_REQUEST_ATTRIBUTE_ORIGIN,</span>
<span class="nc" id="L535">                    request.getHeader(CORSFilter.REQUEST_HEADER_ORIGIN));</span>
<span class="nc" id="L536">            request.setAttribute(</span>
                    CORSFilter.HTTP_REQUEST_ATTRIBUTE_REQUEST_TYPE,
<span class="nc" id="L538">                    corsRequestType.name().toLowerCase());</span>
<span class="nc" id="L539">            String headers =</span>
<span class="nc" id="L540">                    request.getHeader(REQUEST_HEADER_ACCESS_CONTROL_REQUEST_HEADERS);</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">            if (headers == null) {</span>
<span class="nc" id="L542">                headers = &quot;&quot;;</span>
            }
<span class="nc" id="L544">            request.setAttribute(</span>
                    CORSFilter.HTTP_REQUEST_ATTRIBUTE_REQUEST_HEADERS,
                    headers
                    );
<span class="nc" id="L548">            break;</span>
        case NOT_CORS:
<span class="nc" id="L550">            request.setAttribute(</span>
<span class="nc" id="L551">                    CORSFilter.HTTP_REQUEST_ATTRIBUTE_IS_CORS_REQUEST, false);</span>
<span class="nc" id="L552">            break;</span>
        default:
            // Don't set any attributes
            break;
        }
<span class="nc" id="L557">    }</span>

    /**
     * Joins elements of {@link Set} into a string, where each element is
     * separated by the provided separator.
     * 
     * @param elements
     *            The {@link Set} containing elements to join together.
     * @param joinSeparator
     *            The character to be used for separating elements.
     * @return The joined {@link String}; &lt;code&gt;null&lt;/code&gt; if elements
     *         {@link Set} is null.
     */
    public static String join(final Collection&lt;String&gt; elements,
            final String joinSeparator) {
<span class="nc" id="L572">        String separator = &quot;,&quot;;</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">        if (elements == null) {</span>
<span class="nc" id="L574">            return null;</span>
        }
<span class="nc bnc" id="L576" title="All 2 branches missed.">        if (joinSeparator != null) {</span>
<span class="nc" id="L577">            separator = joinSeparator;</span>
        }
<span class="nc" id="L579">        StringBuilder buffer = new StringBuilder();</span>
<span class="nc" id="L580">        boolean isFirst = true;</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">        for (String element : elements) {</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">            if (!isFirst) {</span>
<span class="nc" id="L583">                buffer.append(separator);</span>
            } else {
<span class="nc" id="L585">                isFirst = false;</span>
            }

<span class="nc bnc" id="L588" title="All 2 branches missed.">            if (element != null) {</span>
<span class="nc" id="L589">                buffer.append(element);</span>
            }
<span class="nc" id="L591">        }</span>

<span class="nc" id="L593">        return buffer.toString();</span>
    }

    /**
     * Determines the request type.
     * 
     * @param request
     * @return
     */
    public CORSRequestType checkRequestType(final HttpServletRequest request) {
<span class="nc" id="L603">        CORSRequestType requestType = CORSRequestType.INVALID_CORS;</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">        if (request == null) {</span>
<span class="nc" id="L605">            throw new IllegalArgumentException(</span>
                    &quot;HttpServletRequest object is null&quot;);
        }
<span class="nc" id="L608">        String originHeader = request.getHeader(REQUEST_HEADER_ORIGIN);</span>
        // Section 6.1.1 and Section 6.2.1
<span class="nc bnc" id="L610" title="All 2 branches missed.">        if (originHeader != null) {</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">            if (originHeader.isEmpty()) {</span>
<span class="nc" id="L612">                requestType = CORSRequestType.INVALID_CORS;</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">            } else if (!isValidOrigin(originHeader)) {</span>
<span class="nc" id="L614">                requestType = CORSRequestType.INVALID_CORS;</span>
            } else {
<span class="nc" id="L616">                String method = request.getMethod();</span>
<span class="nc bnc" id="L617" title="All 4 branches missed.">                if (method != null &amp;&amp; HTTP_METHODS.contains(method)) {</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">                    if (&quot;OPTIONS&quot;.equals(method)) {</span>
<span class="nc" id="L619">                        String accessControlRequestMethodHeader =</span>
<span class="nc" id="L620">                                request.getHeader(REQUEST_HEADER_ACCESS_CONTROL_REQUEST_METHOD);</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">                        if (accessControlRequestMethodHeader != null</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">                                &amp;&amp; !accessControlRequestMethodHeader.isEmpty()) {</span>
<span class="nc" id="L623">                            requestType = CORSRequestType.PRE_FLIGHT;</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">                        } else if (accessControlRequestMethodHeader != null</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">                                &amp;&amp; accessControlRequestMethodHeader.isEmpty()) {</span>
<span class="nc" id="L626">                            requestType = CORSRequestType.INVALID_CORS;</span>
                        } else {
<span class="nc" id="L628">                            requestType = CORSRequestType.ACTUAL;</span>
                        }
<span class="nc bnc" id="L630" title="All 4 branches missed.">                    } else if (&quot;GET&quot;.equals(method) || &quot;HEAD&quot;.equals(method)) {</span>
<span class="nc" id="L631">                        requestType = CORSRequestType.SIMPLE;</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">                    } else if (&quot;POST&quot;.equals(method)) {</span>
<span class="nc" id="L633">                        String contentType = request.getContentType();</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">                        if (contentType != null) {</span>
<span class="nc" id="L635">                            contentType = contentType.toLowerCase().trim();</span>
<span class="nc" id="L636">                            if (SIMPLE_HTTP_REQUEST_CONTENT_TYPE_VALUES</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">                                    .contains(contentType)) {</span>
<span class="nc" id="L638">                                requestType = CORSRequestType.SIMPLE;</span>
                            } else {
<span class="nc" id="L640">                                requestType = CORSRequestType.ACTUAL;</span>
                            }
                        }
<span class="nc bnc" id="L643" title="All 2 branches missed.">                    } else if (COMPLEX_HTTP_METHODS.contains(method)) {</span>
<span class="nc" id="L644">                        requestType = CORSRequestType.ACTUAL;</span>
                    }
                }
<span class="nc" id="L647">            }</span>
        } else {
<span class="nc" id="L649">            requestType = CORSRequestType.NOT_CORS;</span>
        }

<span class="nc" id="L652">        return requestType;</span>
    }

    /**
     * Checks if the Origin is allowed to make a CORS request.
     * 
     * @param origin
     *            The Origin.
     * @return &lt;code&gt;true&lt;/code&gt; if origin is allowed; &lt;code&gt;false&lt;/code&gt;
     *         otherwise.
     */
    private boolean isOriginAllowed(final String origin) {
<span class="nc bnc" id="L664" title="All 2 branches missed.">        if (anyOriginAllowed) {</span>
<span class="nc" id="L665">            return true;</span>
        }

        // If 'Origin' header is a case-sensitive match of any of allowed
        // origins, then return true, else return false.
<span class="nc" id="L670">        return allowedOrigins.contains(origin);</span>
    }

    private void log(String message) {
<span class="nc bnc" id="L674" title="All 2 branches missed.">        if (loggingEnabled) {</span>
<span class="nc" id="L675">            filterConfig.getServletContext().log(message);</span>
        }
<span class="nc" id="L677">    }</span>

    /**
     * Parses each param-value and populates configuration variables. If a param
     * is provided, it overrides the default.
     * 
     * @param allowedOrigins
     *            A {@link String} of comma separated origins.
     * @param allowedHttpMethods
     *            A {@link String} of comma separated HTTP methods.
     * @param allowedHttpHeaders
     *            A {@link String} of comma separated HTTP headers.
     * @param exposedHeaders
     *            A {@link String} of comma separated headers that needs to be
     *            exposed.
     * @param supportsCredentials
     *            &quot;true&quot; if support credentials needs to be enabled.
     * @param preflightMaxAge
     *            The amount of seconds the user agent is allowed to cache the
     *            result of the pre-flight request.
     * @param loggingEnabled
     *            Flag to control logging to access log.
     * @throws ServletException
     */
    private void parseAndStore(final String allowedOrigins,
            final String allowedHttpMethods, final String allowedHttpHeaders,
            final String exposedHeaders, final String supportsCredentials,
            final String preflightMaxAge, final String loggingEnabled,
            final String decorateRequest)
            throws ServletException {
<span class="nc bnc" id="L707" title="All 2 branches missed.">        if (allowedOrigins != null) {</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">            if (allowedOrigins.trim().equals(&quot;*&quot;)) {</span>
<span class="nc" id="L709">                this.anyOriginAllowed = true;</span>
            } else {
<span class="nc" id="L711">                this.anyOriginAllowed = false;</span>
<span class="nc" id="L712">                Set&lt;String&gt; setAllowedOrigins =</span>
<span class="nc" id="L713">                        parseStringToSet(allowedOrigins);</span>
<span class="nc" id="L714">                this.allowedOrigins.clear();</span>
<span class="nc" id="L715">                this.allowedOrigins.addAll(setAllowedOrigins);</span>
            }
        }

<span class="nc bnc" id="L719" title="All 2 branches missed.">        if (allowedHttpMethods != null) {</span>
<span class="nc" id="L720">            Set&lt;String&gt; setAllowedHttpMethods =</span>
<span class="nc" id="L721">                    parseStringToSet(allowedHttpMethods);</span>
<span class="nc" id="L722">            this.allowedHttpMethods.clear();</span>
<span class="nc" id="L723">            this.allowedHttpMethods.addAll(setAllowedHttpMethods);</span>
        }

<span class="nc bnc" id="L726" title="All 2 branches missed.">        if (allowedHttpHeaders != null) {</span>
<span class="nc" id="L727">            Set&lt;String&gt; setAllowedHttpHeaders =</span>
<span class="nc" id="L728">                    parseStringToSet(allowedHttpHeaders);</span>
<span class="nc" id="L729">            Set&lt;String&gt; lowerCaseHeaders = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">            for (String header : setAllowedHttpHeaders) {</span>
<span class="nc" id="L731">                String lowerCase = header.toLowerCase();</span>
<span class="nc" id="L732">                lowerCaseHeaders.add(lowerCase);</span>
<span class="nc" id="L733">            }</span>
<span class="nc" id="L734">            this.allowedHttpHeaders.clear();</span>
<span class="nc" id="L735">            this.allowedHttpHeaders.addAll(lowerCaseHeaders);</span>
        }

<span class="nc bnc" id="L738" title="All 2 branches missed.">        if (exposedHeaders != null) {</span>
<span class="nc" id="L739">            Set&lt;String&gt; setExposedHeaders = parseStringToSet(exposedHeaders);</span>
<span class="nc" id="L740">            this.exposedHeaders.clear();</span>
<span class="nc" id="L741">            this.exposedHeaders.addAll(setExposedHeaders);</span>
        }

<span class="nc bnc" id="L744" title="All 2 branches missed.">        if (supportsCredentials != null) {</span>
            // For any value other then 'true' this will be false.
<span class="nc" id="L746">            this.supportsCredentials =</span>
<span class="nc" id="L747">                    Boolean.parseBoolean(supportsCredentials);</span>
        }

<span class="nc bnc" id="L750" title="All 2 branches missed.">        if (preflightMaxAge != null) {</span>
            try {
<span class="nc bnc" id="L752" title="All 2 branches missed.">                if (!preflightMaxAge.isEmpty()) {</span>
<span class="nc" id="L753">                    this.preflightMaxAge = Long.parseLong(preflightMaxAge);</span>
                } else {
<span class="nc" id="L755">                    this.preflightMaxAge = 0L;</span>
                }
<span class="nc" id="L757">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L758">                throw new ServletException(&quot;Unable to parse preflightMaxAge&quot;, e);</span>
<span class="nc" id="L759">            }</span>
        }

<span class="nc bnc" id="L762" title="All 2 branches missed.">        if (loggingEnabled != null) {</span>
            // For any value other then 'true' this will be false.
<span class="nc" id="L764">            this.loggingEnabled = Boolean.parseBoolean(loggingEnabled);</span>
        }

<span class="nc bnc" id="L767" title="All 2 branches missed.">        if (decorateRequest != null) {</span>
            // For any value other then 'true' this will be false.
<span class="nc" id="L769">            this.decorateRequest = Boolean.parseBoolean(decorateRequest);</span>
        }
<span class="nc" id="L771">    }</span>

    /**
     * Takes a comma separated list and returns a Set&lt;String&gt;.
     * 
     * @param data
     *            A comma separated list of strings.
     * @return Set&lt;String&gt;
     */
    private Set&lt;String&gt; parseStringToSet(final String data) {
        String[] splits;

<span class="nc bnc" id="L783" title="All 4 branches missed.">        if (data != null &amp;&amp; data.length() &gt; 0) {</span>
<span class="nc" id="L784">            splits = data.split(&quot;,&quot;);</span>
        } else {
<span class="nc" id="L786">            splits = new String[] {};</span>
        }

<span class="nc" id="L789">        Set&lt;String&gt; set = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">        if (splits.length &gt; 0) {</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">            for (String split : splits) {</span>
<span class="nc" id="L792">                set.add(split.trim());</span>
            }
        }

<span class="nc" id="L796">        return set;</span>
    }

    /**
     * Checks if a given origin is valid or not. Criteria:
     * &lt;ul&gt;
     * &lt;li&gt;If an encoded character is present in origin, it's not valid.&lt;/li&gt;
     * &lt;li&gt;Origin should be a valid {@link URI}&lt;/li&gt;
     * &lt;/ul&gt;
     * 
     * @param origin
     * @see &lt;a href=&quot;http://tools.ietf.org/html/rfc952&quot;&gt;RFC952&lt;/a&gt;
     * @return
     */
    public static boolean isValidOrigin(String origin) {
        // Checks for encoded characters. Helps prevent CRLF injection.
<span class="nc bnc" id="L812" title="All 2 branches missed.">        if (origin.contains(&quot;%&quot;)) {</span>
<span class="nc" id="L813">            return false;</span>
        }

        URI originURI;

        try {
<span class="nc" id="L819">            originURI = new URI(origin);</span>
<span class="nc" id="L820">        } catch (URISyntaxException e) {</span>
<span class="nc" id="L821">            return false;</span>
<span class="nc" id="L822">        }</span>
        // If scheme for URI is null, return false. Return true otherwise.
<span class="nc bnc" id="L824" title="All 2 branches missed.">        return originURI.getScheme() != null;</span>

    }

    // -------------------------------------------------------------- Accessors
    /**
     * Determines if logging is enabled or not.
     * 
     * @return &lt;code&gt;true&lt;/code&gt; if it's enabled; false otherwise.
     */
    public boolean isLoggingEnabled() {
<span class="nc" id="L835">        return loggingEnabled;</span>
    }

    /**
     * Determines if any origin is allowed to make CORS request.
     * 
     * @return &lt;code&gt;true&lt;/code&gt; if it's enabled; false otherwise.
     */
    public boolean isAnyOriginAllowed() {
<span class="nc" id="L844">        return anyOriginAllowed;</span>
    }

    /**
     * Returns a {@link Set} of headers that should be exposed by browser.
     * 
     * @return
     */
    public Collection&lt;String&gt; getExposedHeaders() {
<span class="nc" id="L853">        return exposedHeaders;</span>
    }

    /**
     * Determines is supports credentials is enabled
     * 
     * @return
     */
    public boolean isSupportsCredentials() {
<span class="nc" id="L862">        return supportsCredentials;</span>
    }

    /**
     * Returns the preflight response cache time in seconds.
     * 
     * @return Time to cache in seconds.
     */
    public long getPreflightMaxAge() {
<span class="nc" id="L871">        return preflightMaxAge;</span>
    }

    /**
     * Returns the {@link Set} of allowed origins that are allowed to make
     * requests.
     * 
     * @return {@link Set}
     */
    public Collection&lt;String&gt; getAllowedOrigins() {
<span class="nc" id="L881">        return allowedOrigins;</span>
    }

    /**
     * Returns a {@link Set} of HTTP methods that are allowed to make requests.
     * 
     * @return {@link Set}
     */
    public Collection&lt;String&gt; getAllowedHttpMethods() {
<span class="nc" id="L890">        return allowedHttpMethods;</span>
    }

    /**
     * Returns a {@link Set} of headers support by resource.
     * 
     * @return {@link Set}
     */
    public Collection&lt;String&gt; getAllowedHttpHeaders() {
<span class="nc" id="L899">        return allowedHttpHeaders;</span>
    }

    // -------------------------------------------------- CORS Response Headers
    /**
     * The Access-Control-Allow-Origin header indicates whether a resource can
     * be shared based by returning the value of the Origin request header in
     * the response.
     */
    public static final String RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN =
            &quot;Access-Control-Allow-Origin&quot;;

    /**
     * The Access-Control-Allow-Credentials header indicates whether the
     * response to request can be exposed when the omit credentials flag is
     * unset. When part of the response to a preflight request it indicates that
     * the actual request can include user credentials.
     */
    public static final String RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_CREDENTIALS =
            &quot;Access-Control-Allow-Credentials&quot;;

    /**
     * The Access-Control-Expose-Headers header indicates which headers are safe
     * to expose to the API of a CORS API specification
     */
    public static final String RESPONSE_HEADER_ACCESS_CONTROL_EXPOSE_HEADERS =
            &quot;Access-Control-Expose-Headers&quot;;

    /**
     * The Access-Control-Max-Age header indicates how long the results of a
     * preflight request can be cached in a preflight result cache.
     */
    public static final String RESPONSE_HEADER_ACCESS_CONTROL_MAX_AGE =
            &quot;Access-Control-Max-Age&quot;;

    /**
     * The Access-Control-Allow-Methods header indicates, as part of the
     * response to a preflight request, which methods can be used during the
     * actual request.
     */
    public static final String RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_METHODS =
            &quot;Access-Control-Allow-Methods&quot;;

    /**
     * The Access-Control-Allow-Headers header indicates, as part of the
     * response to a preflight request, which header field names can be used
     * during the actual request.
     */
    public static final String RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_HEADERS =
            &quot;Access-Control-Allow-Headers&quot;;

    // -------------------------------------------------- CORS Request Headers
    /**
     * The Origin header indicates where the cross-origin request or preflight
     * request originates from.
     */
    public static final String REQUEST_HEADER_ORIGIN = &quot;Origin&quot;;

    /**
     * The Access-Control-Request-Method header indicates which method will be
     * used in the actual request as part of the preflight request.
     */
    public static final String REQUEST_HEADER_ACCESS_CONTROL_REQUEST_METHOD =
            &quot;Access-Control-Request-Method&quot;;

    /**
     * The Access-Control-Request-Headers header indicates which headers will be
     * used in the actual request as part of the preflight request.
     */
    public static final String REQUEST_HEADER_ACCESS_CONTROL_REQUEST_HEADERS =
            &quot;Access-Control-Request-Headers&quot;;

    // ----------------------------------------------------- Request attributes
    /**
     * The prefix to a CORS request attribute.
     */
    public static final String HTTP_REQUEST_ATTRIBUTE_PREFIX = &quot;cors.&quot;;

    /**
     * Attribute that contains the origin of the request.
     */
    public static final String HTTP_REQUEST_ATTRIBUTE_ORIGIN =
            HTTP_REQUEST_ATTRIBUTE_PREFIX + &quot;request.origin&quot;;

    /**
     * Boolean value, suggesting if the request is a CORS request or not.
     */
    public static final String HTTP_REQUEST_ATTRIBUTE_IS_CORS_REQUEST =
            HTTP_REQUEST_ATTRIBUTE_PREFIX + &quot;isCorsRequest&quot;;

    /**
     * Type of CORS request, of type {@link CORSRequestType}.
     */
    public static final String HTTP_REQUEST_ATTRIBUTE_REQUEST_TYPE =
            HTTP_REQUEST_ATTRIBUTE_PREFIX + &quot;request.type&quot;;

    /**
     * Request headers sent as 'Access-Control-Request-Headers' header, for
     * pre-flight request.
     */
    public static final String HTTP_REQUEST_ATTRIBUTE_REQUEST_HEADERS =
            HTTP_REQUEST_ATTRIBUTE_PREFIX + &quot;request.headers&quot;;

    // -------------------------------------------------------------- Constants
    /**
     * Enumerates varies types of CORS requests. Also, provides utility methods
     * to determine the request type.
     */
<span class="nc" id="L1007">    public static enum CORSRequestType {</span>
        /**
         * A simple HTTP request, i.e. it shouldn't be pre-flighted.
         */
<span class="nc" id="L1011">        SIMPLE,</span>
        /**
         * A HTTP request that needs to be pre-flighted.
         */
<span class="nc" id="L1015">        ACTUAL,</span>
        /**
         * A pre-flight CORS request, to get meta information, before a
         * non-simple HTTP request is sent.
         */
<span class="nc" id="L1020">        PRE_FLIGHT,</span>
        /**
         * Not a CORS request, but a normal request.
         */
<span class="nc" id="L1024">        NOT_CORS,</span>
        /**
         * An invalid CORS request, i.e. it qualifies to be a CORS request, but
         * fails to be a valid one.
         */
<span class="nc" id="L1029">        INVALID_CORS</span>
    }

    /**
     * {@link Collection} of HTTP methods. Case sensitive.
     * 
     * @see http://tools.ietf.org/html/rfc2616#section-5.1.1
     */
<span class="nc" id="L1037">    public static final Collection&lt;String&gt; HTTP_METHODS = new HashSet&lt;&gt;(</span>
<span class="nc" id="L1038">            Arrays.asList(&quot;OPTIONS&quot;, &quot;GET&quot;, &quot;HEAD&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;,</span>
                    &quot;TRACE&quot;, &quot;CONNECT&quot;));
    /**
     * {@link Collection} of non-simple HTTP methods. Case sensitive.
     */
<span class="nc" id="L1043">    public static final Collection&lt;String&gt; COMPLEX_HTTP_METHODS =</span>
            new HashSet&lt;&gt;(
<span class="nc" id="L1045">                    Arrays.asList(&quot;PUT&quot;, &quot;DELETE&quot;, &quot;TRACE&quot;, &quot;CONNECT&quot;));</span>
    /**
     * {@link Collection} of Simple HTTP methods. Case sensitive.
     * 
     * @see http://www.w3.org/TR/cors/#terminology
     */
<span class="nc" id="L1051">    public static final Collection&lt;String&gt; SIMPLE_HTTP_METHODS =</span>
            new HashSet&lt;&gt;(
<span class="nc" id="L1053">                    Arrays.asList(&quot;GET&quot;, &quot;POST&quot;, &quot;HEAD&quot;));</span>

    /**
     * {@link Collection} of Simple HTTP request headers. Case in-sensitive.
     * 
     * @see http://www.w3.org/TR/cors/#terminology
     */
<span class="nc" id="L1060">    public static final Collection&lt;String&gt; SIMPLE_HTTP_REQUEST_HEADERS =</span>
<span class="nc" id="L1061">            new HashSet&lt;&gt;(Arrays.asList(&quot;Accept&quot;, &quot;Accept-Language&quot;,</span>
                    &quot;Content-Language&quot;));

    /**
     * {@link Collection} of Simple HTTP request headers. Case in-sensitive.
     * 
     * @see http://www.w3.org/TR/cors/#terminology
     */
<span class="nc" id="L1069">    public static final Collection&lt;String&gt; SIMPLE_HTTP_RESPONSE_HEADERS =</span>
<span class="nc" id="L1070">            new HashSet&lt;&gt;(Arrays.asList(&quot;Cache-Control&quot;,</span>
                    &quot;Content-Language&quot;, &quot;Content-Type&quot;, &quot;Expires&quot;,
                    &quot;Last-Modified&quot;, &quot;Pragma&quot;));

    /**
     * {@link Collection} of Simple HTTP request headers. Case in-sensitive.
     * 
     * @see http://www.w3.org/TR/cors/#terminology
     */
<span class="nc" id="L1079">    public static final Collection&lt;String&gt; SIMPLE_HTTP_REQUEST_CONTENT_TYPE_VALUES =</span>
<span class="nc" id="L1080">            new HashSet&lt;&gt;(Arrays.asList(</span>
                    &quot;application/x-www-form-urlencoded&quot;, &quot;multipart/form-data&quot;,
                    &quot;text/plain&quot;));

    // ------------------------------------------------ Configuration Defaults
    /**
     * By default, all origins are allowed to make requests.
     */
    public static final String DEFAULT_ALLOWED_ORIGINS = &quot;*&quot;;

    /**
     * By default, following methods are supported: GET, POST, HEAD and OPTIONS.
     */
    public static final String DEFAULT_ALLOWED_HTTP_METHODS =
            &quot;GET,POST,HEAD,OPTIONS&quot;;

    /**
     * By default, time duration to cache pre-flight response is 30 mins.
     */
    public static final String DEFAULT_PREFLIGHT_MAXAGE = &quot;1800&quot;;

    /**
     * By default, support credentials is turned on.
     */
    public static final String DEFAULT_SUPPORTS_CREDENTIALS = &quot;true&quot;;

    /**
     * By default, following headers are supported:
     * Origin,Accept,X-Requested-With, Content-Type,
     * Access-Control-Request-Method, and Access-Control-Request-Headers.
     */
    public static final String DEFAULT_ALLOWED_HTTP_HEADERS =
            &quot;Origin,Accept,X-Requested-With,Content-Type,&quot;
                    +
                    &quot;Access-Control-Request-Method,Access-Control-Request-Headers&quot;;

    /**
     * By default, none of the headers are exposed in response.
     */
    public static final String DEFAULT_EXPOSED_HEADERS = &quot;&quot;;

    /**
     * By default, access log logging is turned off
     */
    public static final String DEFAULT_LOGGING_ENABLED = &quot;false&quot;;

    /**
     * By default, request is decorated with CORS attributes.
     */
    public static final String DEFAULT_DECORATE_REQUEST = &quot;true&quot;;

    // ----------------------------------------Filter Config Init param-name(s)
    /**
     * Key to retrieve allowed origins from {@link FilterConfig}.
     */
    public static final String PARAM_CORS_ALLOWED_ORIGINS =
            &quot;cors.allowed.origins&quot;;

    /**
     * Key to retrieve support credentials from {@link FilterConfig}.
     */
    public static final String PARAM_CORS_SUPPORT_CREDENTIALS =
            &quot;cors.support.credentials&quot;;

    /**
     * Key to retrieve exposed headers from {@link FilterConfig}.
     */
    public static final String PARAM_CORS_EXPOSED_HEADERS =
            &quot;cors.exposed.headers&quot;;

    /**
     * Key to retrieve allowed headers from {@link FilterConfig}.
     */
    public static final String PARAM_CORS_ALLOWED_HEADERS =
            &quot;cors.allowed.headers&quot;;

    /**
     * Key to retrieve allowed methods from {@link FilterConfig}.
     */
    public static final String PARAM_CORS_ALLOWED_METHODS =
            &quot;cors.allowed.methods&quot;;

    /**
     * Key to retrieve preflight max age from {@link FilterConfig}.
     */
    public static final String PARAM_CORS_PREFLIGHT_MAXAGE =
            &quot;cors.preflight.maxage&quot;;

    /**
     * Key to retrieve access log logging flag.
     */
    public static final String PARAM_CORS_LOGGING_ENABLED =
            &quot;cors.logging.enabled&quot;;

    /**
     * Key to determine if request should be decorated.
     */
    public static final String PARAM_CORS_REQUEST_DECORATE =
            &quot;cors.request.decorate&quot;;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>