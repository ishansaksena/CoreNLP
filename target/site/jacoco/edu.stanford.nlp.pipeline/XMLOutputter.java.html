<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XMLOutputter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Stanford CoreNLP</a> &gt; <a href="index.source.html" class="el_package">edu.stanford.nlp.pipeline</a> &gt; <span class="el_source">XMLOutputter.java</span></div><h1>XMLOutputter.java</h1><pre class="source lang-java linenums">package edu.stanford.nlp.pipeline; 

import java.io.IOException;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.Collection;
import java.util.List;
import java.util.Map;

import edu.stanford.nlp.coref.CorefCoreAnnotations;

import edu.stanford.nlp.coref.data.CorefChain;
import edu.stanford.nlp.ie.machinereading.structure.EntityMention;
import edu.stanford.nlp.ie.machinereading.structure.ExtractionObject;
import edu.stanford.nlp.ie.machinereading.structure.MachineReadingAnnotations;
import edu.stanford.nlp.ie.machinereading.structure.RelationMention;
import edu.stanford.nlp.ie.util.RelationTriple;
import edu.stanford.nlp.ling.CoreAnnotations;
import edu.stanford.nlp.ling.CoreLabel;
import edu.stanford.nlp.ling.IndexedWord;
import edu.stanford.nlp.naturalli.NaturalLogicAnnotations;
import edu.stanford.nlp.neural.rnn.RNNCoreAnnotations;
import edu.stanford.nlp.sentiment.SentimentCoreAnnotations;
import edu.stanford.nlp.stats.Counters;
import edu.stanford.nlp.time.TimeAnnotations;
import edu.stanford.nlp.time.Timex;
import edu.stanford.nlp.trees.GrammaticalRelation;
import edu.stanford.nlp.trees.Tree;
import edu.stanford.nlp.trees.TreePrint;
import edu.stanford.nlp.trees.TreeCoreAnnotations;
import edu.stanford.nlp.semgraph.SemanticGraph;
import edu.stanford.nlp.semgraph.SemanticGraphCoreAnnotations;
import edu.stanford.nlp.semgraph.SemanticGraphEdge;
import edu.stanford.nlp.util.CoreMap;
import edu.stanford.nlp.util.Pair;
import edu.stanford.nlp.util.StringUtils;
import nu.xom.*;


/**
 * An outputter to XML format.
 * This is not intended to be de-serialized back into annotations; for that,
 * see {@link edu.stanford.nlp.pipeline.AnnotationSerializer}; e.g.,
 * {@link edu.stanford.nlp.pipeline.ProtobufAnnotationSerializer}.
 */
public class XMLOutputter extends AnnotationOutputter  {

  // the namespace is set in the XSLT file
<span class="fc" id="L50">  private static final String NAMESPACE_URI = null;</span>
  private static final String STYLESHEET_NAME = &quot;CoreNLP-to-HTML.xsl&quot;;

<span class="nc" id="L53">  public XMLOutputter() {}</span>

  /** {@inheritDoc} */
  @Override
  public void print(Annotation annotation, OutputStream os, Options options) throws IOException {
<span class="nc" id="L58">    Document xmlDoc = annotationToDoc(annotation, options);</span>
<span class="nc" id="L59">    Serializer ser = new Serializer(os, options.encoding);</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">    if (options.pretty) {</span>
<span class="nc" id="L61">      ser.setIndent(2);</span>
    } else {
<span class="nc" id="L63">      ser.setIndent(0);</span>
    }
<span class="nc" id="L65">    ser.setMaxLength(0);</span>
<span class="nc" id="L66">    ser.write(xmlDoc);</span>
<span class="nc" id="L67">    ser.flush();</span>
<span class="nc" id="L68">  }</span>

  public static void xmlPrint(Annotation annotation, OutputStream os) throws IOException {
<span class="nc" id="L71">    new XMLOutputter().print(annotation, os);</span>
<span class="nc" id="L72">  }</span>

  public static void xmlPrint(Annotation annotation, OutputStream os, StanfordCoreNLP pipeline) throws IOException {
<span class="nc" id="L75">    new XMLOutputter().print(annotation, os, pipeline);</span>
<span class="nc" id="L76">  }</span>

  public static void xmlPrint(Annotation annotation, OutputStream os, Options options) throws IOException {
<span class="nc" id="L79">    new XMLOutputter().print(annotation, os, options);</span>
<span class="nc" id="L80">  }</span>

  /**
   * Converts the given annotation to an XML document using options taken from the StanfordCoreNLP pipeline
   */
  public static Document annotationToDoc(Annotation annotation, StanfordCoreNLP pipeline) {
<span class="nc" id="L86">    Options options = getOptions(pipeline);</span>
<span class="nc" id="L87">    return annotationToDoc(annotation, options);</span>
  }

  /**
   * Converts the given annotation to an XML document using the specified options
   */
  public static Document annotationToDoc(Annotation annotation, Options options) {
    //
    // create the XML document with the root node pointing to the namespace URL
    //
<span class="nc" id="L97">    Element root = new Element(&quot;root&quot;, NAMESPACE_URI);</span>
<span class="nc" id="L98">    Document xmlDoc = new Document(root);</span>
<span class="nc" id="L99">    ProcessingInstruction pi = new ProcessingInstruction(&quot;xml-stylesheet&quot;,</span>
            &quot;href=\&quot;&quot; + STYLESHEET_NAME + &quot;\&quot; type=\&quot;text/xsl\&quot;&quot;);
<span class="nc" id="L101">    xmlDoc.insertChild(pi, 0);</span>
<span class="nc" id="L102">    Element docElem = new Element(&quot;document&quot;, NAMESPACE_URI);</span>
<span class="nc" id="L103">    root.appendChild(docElem);</span>

<span class="nc" id="L105">    setSingleElement(docElem, &quot;docId&quot;, NAMESPACE_URI, annotation.get(CoreAnnotations.DocIDAnnotation.class));</span>
<span class="nc" id="L106">    setSingleElement(docElem, &quot;docDate&quot;, NAMESPACE_URI, annotation.get(CoreAnnotations.DocDateAnnotation.class));</span>
<span class="nc" id="L107">    setSingleElement(docElem, &quot;docSourceType&quot;, NAMESPACE_URI, annotation.get(CoreAnnotations.DocSourceTypeAnnotation.class));</span>
<span class="nc" id="L108">    setSingleElement(docElem, &quot;docType&quot;, NAMESPACE_URI, annotation.get(CoreAnnotations.DocTypeAnnotation.class));</span>
<span class="nc" id="L109">    setSingleElement(docElem, &quot;author&quot;, NAMESPACE_URI, annotation.get(CoreAnnotations.AuthorAnnotation.class));</span>
<span class="nc" id="L110">    setSingleElement(docElem, &quot;location&quot;, NAMESPACE_URI, annotation.get(CoreAnnotations.LocationAnnotation.class));</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">    if (options.includeText) {</span>
<span class="nc" id="L113">      setSingleElement(docElem, &quot;text&quot;, NAMESPACE_URI, annotation.get(CoreAnnotations.TextAnnotation.class));</span>
    }

<span class="nc" id="L116">    Element sentencesElem = new Element(&quot;sentences&quot;, NAMESPACE_URI);</span>
<span class="nc" id="L117">    docElem.appendChild(sentencesElem);</span>

    //
    // save the info for each sentence in this doc
    //
<span class="nc bnc" id="L122" title="All 2 branches missed.">    if(annotation.get(CoreAnnotations.SentencesAnnotation.class) != null){</span>
<span class="nc" id="L123">      int sentCount = 1;</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">      for (CoreMap sentence: annotation.get(CoreAnnotations.SentencesAnnotation.class)) {</span>
<span class="nc" id="L125">        Element sentElem = new Element(&quot;sentence&quot;, NAMESPACE_URI);</span>
<span class="nc" id="L126">        sentElem.addAttribute(new Attribute(&quot;id&quot;, Integer.toString(sentCount)));</span>
<span class="nc" id="L127">        Integer lineNumber = sentence.get(CoreAnnotations.LineNumberAnnotation.class);</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (lineNumber != null) {</span>
<span class="nc" id="L129">          sentElem.addAttribute(new Attribute(&quot;line&quot;, Integer.toString(lineNumber)));</span>
        }
<span class="nc" id="L131">        sentCount ++;</span>

        // add the word table with all token-level annotations
<span class="nc" id="L134">        Element wordTable = new Element(&quot;tokens&quot;, NAMESPACE_URI);</span>
<span class="nc" id="L135">        List&lt;CoreLabel&gt; tokens = sentence.get(CoreAnnotations.TokensAnnotation.class);</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">        for(int j = 0; j &lt; tokens.size(); j ++){</span>
<span class="nc" id="L137">          Element wordInfo = new Element(&quot;token&quot;, NAMESPACE_URI);</span>
<span class="nc" id="L138">          addWordInfo(wordInfo, tokens.get(j), j + 1, NAMESPACE_URI);</span>
<span class="nc" id="L139">          wordTable.appendChild(wordInfo);</span>
        }
<span class="nc" id="L141">        sentElem.appendChild(wordTable);</span>

        // add tree info
<span class="nc" id="L144">        Tree tree = sentence.get(TreeCoreAnnotations.TreeAnnotation.class);</span>

<span class="nc bnc" id="L146" title="All 2 branches missed.">        if(tree != null) {</span>
          // add the constituent tree for this sentence
<span class="nc" id="L148">          Element parseInfo = new Element(&quot;parse&quot;, NAMESPACE_URI);</span>
<span class="nc" id="L149">          addConstituentTreeInfo(parseInfo, tree, options.constituentTreePrinter);</span>
<span class="nc" id="L150">          sentElem.appendChild(parseInfo);</span>
        }

<span class="nc" id="L153">        SemanticGraph basicDependencies = sentence.get(SemanticGraphCoreAnnotations.BasicDependenciesAnnotation.class);</span>

<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (basicDependencies != null) {</span>
          // add the dependencies for this sentence
<span class="nc" id="L157">          Element depInfo = buildDependencyTreeInfo(&quot;basic-dependencies&quot;, sentence.get(SemanticGraphCoreAnnotations.BasicDependenciesAnnotation.class), tokens, NAMESPACE_URI);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">          if (depInfo != null) {</span>
<span class="nc" id="L159">            sentElem.appendChild(depInfo);</span>
          }

<span class="nc" id="L162">          depInfo = buildDependencyTreeInfo(&quot;collapsed-dependencies&quot;, sentence.get(SemanticGraphCoreAnnotations.CollapsedDependenciesAnnotation.class), tokens, NAMESPACE_URI);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">          if (depInfo != null) {</span>
<span class="nc" id="L164">            sentElem.appendChild(depInfo);</span>
          }

<span class="nc" id="L167">          depInfo = buildDependencyTreeInfo(&quot;collapsed-ccprocessed-dependencies&quot;, sentence.get(SemanticGraphCoreAnnotations.CollapsedCCProcessedDependenciesAnnotation.class), tokens, NAMESPACE_URI);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">          if (depInfo != null) {</span>
<span class="nc" id="L169">            sentElem.appendChild(depInfo);</span>
          }

<span class="nc" id="L172">          depInfo = buildDependencyTreeInfo(&quot;enhanced-dependencies&quot;, sentence.get(SemanticGraphCoreAnnotations.EnhancedDependenciesAnnotation.class), tokens, NAMESPACE_URI);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">          if (depInfo != null) {</span>
<span class="nc" id="L174">            sentElem.appendChild(depInfo);</span>
          }

<span class="nc" id="L177">          depInfo = buildDependencyTreeInfo(&quot;enhanced-plus-plus-dependencies&quot;, sentence.get(SemanticGraphCoreAnnotations.EnhancedPlusPlusDependenciesAnnotation.class), tokens, NAMESPACE_URI);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">          if (depInfo != null) {</span>
<span class="nc" id="L179">            sentElem.appendChild(depInfo);</span>
          }
        }

        // add Open IE triples
<span class="nc" id="L184">        Collection&lt;RelationTriple&gt; openieTriples = sentence.get(NaturalLogicAnnotations.RelationTriplesAnnotation.class);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (openieTriples != null) {</span>
<span class="nc" id="L186">          Element openieElem = new Element(&quot;openie&quot;, NAMESPACE_URI);</span>
<span class="nc" id="L187">          addTriples(openieTriples, openieElem, NAMESPACE_URI);</span>
<span class="nc" id="L188">          sentElem.appendChild(openieElem);</span>
        }

        // add KBP triples
<span class="nc" id="L192">        Collection&lt;RelationTriple&gt; kbpTriples = sentence.get(CoreAnnotations.KBPTriplesAnnotation.class);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (kbpTriples != null) {</span>
<span class="nc" id="L194">          Element kbpElem = new Element(&quot;kbp&quot;, NAMESPACE_URI);</span>
<span class="nc" id="L195">          addTriples(kbpTriples, kbpElem, NAMESPACE_URI);</span>
<span class="nc" id="L196">          sentElem.appendChild(kbpElem);</span>
        }

        // add the MR entities and relations
<span class="nc" id="L200">        List&lt;EntityMention&gt; entities = sentence.get(MachineReadingAnnotations.EntityMentionsAnnotation.class);</span>
<span class="nc" id="L201">        List&lt;RelationMention&gt; relations = sentence.get(MachineReadingAnnotations.RelationMentionsAnnotation.class);</span>
<span class="nc bnc" id="L202" title="All 4 branches missed.">        if (entities != null &amp;&amp; ! entities.isEmpty()){</span>
<span class="nc" id="L203">          Element mrElem = new Element(&quot;MachineReading&quot;, NAMESPACE_URI);</span>
<span class="nc" id="L204">          Element entElem = new Element(&quot;entities&quot;, NAMESPACE_URI);</span>
<span class="nc" id="L205">          addEntities(entities, entElem, NAMESPACE_URI);</span>
<span class="nc" id="L206">          mrElem.appendChild(entElem);</span>

<span class="nc bnc" id="L208" title="All 2 branches missed.">          if(relations != null){</span>
<span class="nc" id="L209">            Element relElem = new Element(&quot;relations&quot;, NAMESPACE_URI);</span>
<span class="nc" id="L210">            addRelations(relations, relElem, NAMESPACE_URI, options.relationsBeam);</span>
<span class="nc" id="L211">            mrElem.appendChild(relElem);</span>
          }

<span class="nc" id="L214">          sentElem.appendChild(mrElem);</span>
        }

        /**
         * Adds sentiment as an attribute of this sentence.
         */
<span class="nc" id="L220">        Tree sentimentTree = sentence.get(SentimentCoreAnnotations.SentimentAnnotatedTree.class);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (sentimentTree != null) {</span>
<span class="nc" id="L222">          int sentiment = RNNCoreAnnotations.getPredictedClass(sentimentTree);</span>
<span class="nc" id="L223">          sentElem.addAttribute(new Attribute(&quot;sentimentValue&quot;, Integer.toString(sentiment)));</span>
<span class="nc" id="L224">          String sentimentClass = sentence.get(SentimentCoreAnnotations.SentimentClass.class);</span>
<span class="nc" id="L225">          sentElem.addAttribute(new Attribute(&quot;sentiment&quot;, sentimentClass.replaceAll(&quot; &quot;, &quot;&quot;)));</span>
        }

        // add the sentence to the root
<span class="nc" id="L229">        sentencesElem.appendChild(sentElem);</span>
<span class="nc" id="L230">      }</span>
    }

    //
    // add the coref graph
    //
<span class="nc" id="L236">    Map&lt;Integer, CorefChain&gt; corefChains =</span>
<span class="nc" id="L237">            annotation.get(CorefCoreAnnotations.CorefChainAnnotation.class);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">    if (corefChains != null) {</span>
<span class="nc" id="L239">      List&lt;CoreMap&gt; sentences = annotation.get(CoreAnnotations.SentencesAnnotation.class);</span>
<span class="nc" id="L240">      Element corefInfo = new Element(&quot;coreference&quot;, NAMESPACE_URI);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">      if (addCorefGraphInfo(options, corefInfo, sentences, corefChains, NAMESPACE_URI))</span>
<span class="nc" id="L242">        docElem.appendChild(corefInfo);</span>
    }

    //
    // save any document-level annotations here
    //

<span class="nc" id="L249">    return xmlDoc;</span>
  }

  /**
   * Generates the XML content for a list of OpenIE triples.
   */
  private static void addTriples(Collection&lt;RelationTriple&gt; openieTriples, Element top, String namespaceUri) {
<span class="nc bnc" id="L256" title="All 2 branches missed.">    for (RelationTriple triple : openieTriples) {</span>
<span class="nc" id="L257">      top.appendChild(toXML(triple, namespaceUri));</span>
<span class="nc" id="L258">    }</span>
<span class="nc" id="L259">  }</span>

  /**
   * Generates the XML content for a constituent tree
   */
  private static void addConstituentTreeInfo(Element treeInfo, Tree tree, TreePrint constituentTreePrinter) {
<span class="nc" id="L265">    StringWriter treeStrWriter = new StringWriter();</span>
<span class="nc" id="L266">    constituentTreePrinter.printTree(tree, new PrintWriter(treeStrWriter, true));</span>
<span class="nc" id="L267">    String temp = treeStrWriter.toString();</span>
    //log.info(temp);
<span class="nc" id="L269">    treeInfo.appendChild(temp);</span>
<span class="nc" id="L270">  }</span>

  private static Element buildDependencyTreeInfo(String dependencyType, SemanticGraph graph, List&lt;CoreLabel&gt; tokens, String curNS) {
<span class="nc bnc" id="L273" title="All 2 branches missed.">    if(graph != null) {</span>
<span class="nc" id="L274">      Element depInfo = new Element(&quot;dependencies&quot;, curNS);</span>
<span class="nc" id="L275">      depInfo.addAttribute(new Attribute(&quot;type&quot;, dependencyType));</span>
      // The SemanticGraph doesn't explicitly encode the ROOT node,
      // so we print that out ourselves
<span class="nc bnc" id="L278" title="All 2 branches missed.">      for (IndexedWord root : graph.getRoots()) {</span>
<span class="nc" id="L279">        String rel = GrammaticalRelation.ROOT.getLongName();</span>
<span class="nc" id="L280">        rel = rel.replaceAll(&quot;\\s+&quot;, &quot;&quot;); // future proofing</span>
<span class="nc" id="L281">        int source = 0;</span>
<span class="nc" id="L282">        int target = root.index();</span>
<span class="nc" id="L283">        String sourceWord = &quot;ROOT&quot;;</span>
<span class="nc" id="L284">        String targetWord = tokens.get(target - 1).word();</span>
<span class="nc" id="L285">        final boolean isExtra = false;</span>

<span class="nc" id="L287">        addDependencyInfo(depInfo, rel, isExtra, source, sourceWord, null, target, targetWord, null, curNS);</span>
<span class="nc" id="L288">      }</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">      for (SemanticGraphEdge edge : graph.edgeListSorted()) {</span>
<span class="nc" id="L290">        String rel = edge.getRelation().toString();</span>
<span class="nc" id="L291">        rel = rel.replaceAll(&quot;\\s+&quot;, &quot;&quot;);</span>
<span class="nc" id="L292">        int source = edge.getSource().index();</span>
<span class="nc" id="L293">        int target = edge.getTarget().index();</span>
<span class="nc" id="L294">        String sourceWord = tokens.get(source - 1).word();</span>
<span class="nc" id="L295">        String targetWord = tokens.get(target - 1).word();</span>
<span class="nc" id="L296">        Integer sourceCopy = edge.getSource().copyCount();</span>
<span class="nc" id="L297">        Integer targetCopy = edge.getTarget().copyCount();</span>
<span class="nc" id="L298">        boolean isExtra = edge.isExtra();</span>

<span class="nc" id="L300">        addDependencyInfo(depInfo, rel, isExtra, source, sourceWord, sourceCopy, target, targetWord, targetCopy, curNS);</span>
<span class="nc" id="L301">      }</span>
<span class="nc" id="L302">      return depInfo;</span>
    }
<span class="nc" id="L304">    return null;</span>
  }

  private static void addDependencyInfo(Element depInfo, String rel, boolean isExtra, int source, String sourceWord, Integer sourceCopy, int target, String targetWord, Integer targetCopy, String curNS) {
<span class="nc" id="L308">    Element depElem = new Element(&quot;dep&quot;, curNS);</span>
<span class="nc" id="L309">    depElem.addAttribute(new Attribute(&quot;type&quot;, rel));</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">    if (isExtra) {</span>
<span class="nc" id="L311">      depElem.addAttribute(new Attribute(&quot;extra&quot;, &quot;true&quot;));</span>
    }

<span class="nc" id="L314">    Element govElem = new Element(&quot;governor&quot;, curNS);</span>
<span class="nc" id="L315">    govElem.addAttribute(new Attribute(&quot;idx&quot;, Integer.toString(source)));</span>
<span class="nc" id="L316">    govElem.appendChild(sourceWord);</span>
<span class="nc bnc" id="L317" title="All 4 branches missed.">    if (sourceCopy != null &amp;&amp; sourceCopy &gt; 0) {</span>
<span class="nc" id="L318">      govElem.addAttribute(new Attribute(&quot;copy&quot;, Integer.toString(sourceCopy)));</span>
    }
<span class="nc" id="L320">    depElem.appendChild(govElem);</span>

<span class="nc" id="L322">    Element dependElem = new Element(&quot;dependent&quot;, curNS);</span>
<span class="nc" id="L323">    dependElem.addAttribute(new Attribute(&quot;idx&quot;, Integer.toString(target)));</span>
<span class="nc" id="L324">    dependElem.appendChild(targetWord);</span>
<span class="nc bnc" id="L325" title="All 4 branches missed.">    if (targetCopy != null &amp;&amp; targetCopy &gt; 0) {</span>
<span class="nc" id="L326">      dependElem.addAttribute(new Attribute(&quot;copy&quot;, Integer.toString(targetCopy)));</span>
    }
<span class="nc" id="L328">    depElem.appendChild(dependElem);</span>

<span class="nc" id="L330">    depInfo.appendChild(depElem);</span>
<span class="nc" id="L331">  }</span>

  /**
   * Generates the XML content for MachineReading entities.
   */
  private static void addEntities(List&lt;EntityMention&gt; entities, Element top, String curNS) {
<span class="nc bnc" id="L337" title="All 2 branches missed.">    for (EntityMention e: entities) {</span>
<span class="nc" id="L338">      Element ee = toXML(e, curNS);</span>
<span class="nc" id="L339">      top.appendChild(ee);</span>
<span class="nc" id="L340">    }</span>
<span class="nc" id="L341">  }</span>

  /**
   * Generates the XML content for MachineReading relations.
   */
  private static void addRelations(List&lt;RelationMention&gt; relations, Element top, String curNS, double beam){
<span class="nc bnc" id="L347" title="All 2 branches missed.">    for (RelationMention r: relations){</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">      if (r.printableObject(beam)) {</span>
<span class="nc" id="L349">        Element re = toXML(r, curNS);</span>
<span class="nc" id="L350">        top.appendChild(re);</span>
      }
<span class="nc" id="L352">    }</span>
<span class="nc" id="L353">  }</span>

  /**
   * Generates the XML content for the coreference chain object.
   */
  private static boolean addCorefGraphInfo
    (Options options, Element corefInfo, List&lt;CoreMap&gt; sentences, Map&lt;Integer, CorefChain&gt; corefChains, String curNS)
  {
<span class="nc" id="L361">    boolean foundCoref = false;</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">    for (CorefChain chain : corefChains.values()) {</span>
<span class="nc bnc" id="L363" title="All 4 branches missed.">      if (!options.printSingletons &amp;&amp; chain.getMentionsInTextualOrder().size() &lt;= 1)</span>
<span class="nc" id="L364">        continue;</span>
<span class="nc" id="L365">      foundCoref = true;</span>
<span class="nc" id="L366">      Element chainElem = new Element(&quot;coreference&quot;, curNS);</span>
<span class="nc" id="L367">      CorefChain.CorefMention source = chain.getRepresentativeMention();</span>
<span class="nc" id="L368">      addCorefMention(options, chainElem, curNS, sentences, source, true);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">      for (CorefChain.CorefMention mention : chain.getMentionsInTextualOrder()) {</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">        if (mention == source)</span>
<span class="nc" id="L371">          continue;</span>
<span class="nc" id="L372">        addCorefMention(options, chainElem, curNS, sentences, mention, false);</span>
<span class="nc" id="L373">      }</span>
<span class="nc" id="L374">      corefInfo.appendChild(chainElem);</span>
<span class="nc" id="L375">    }</span>
<span class="nc" id="L376">    return foundCoref;</span>
  }

  private static void addCorefMention(Options options,
                                      Element chainElem, String curNS,
                                      List&lt;CoreMap&gt; sentences,
                                      CorefChain.CorefMention mention,
                                      boolean representative) {
<span class="nc" id="L384">    Element mentionElem = new Element(&quot;mention&quot;, curNS);</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">    if (representative) {</span>
<span class="nc" id="L386">      mentionElem.addAttribute(new Attribute(&quot;representative&quot;, &quot;true&quot;));</span>
    }

<span class="nc" id="L389">    setSingleElement(mentionElem, &quot;sentence&quot;, curNS,</span>
<span class="nc" id="L390">                     Integer.toString(mention.sentNum));</span>
<span class="nc" id="L391">    setSingleElement(mentionElem, &quot;start&quot;, curNS,</span>
<span class="nc" id="L392">                     Integer.toString(mention.startIndex));</span>
<span class="nc" id="L393">    setSingleElement(mentionElem, &quot;end&quot;, curNS,</span>
<span class="nc" id="L394">                     Integer.toString(mention.endIndex));</span>
<span class="nc" id="L395">    setSingleElement(mentionElem, &quot;head&quot;, curNS,</span>
<span class="nc" id="L396">                     Integer.toString(mention.headIndex));</span>

<span class="nc" id="L398">    String text = mention.mentionSpan;</span>
<span class="nc" id="L399">    setSingleElement(mentionElem, &quot;text&quot;, curNS, text);</span>
    // Do you want context with your coreference?
<span class="nc bnc" id="L401" title="All 4 branches missed.">    if (sentences != null &amp;&amp; options.coreferenceContextSize &gt; 0) {</span>
      // If so use sentences to get so context from sentences

<span class="nc" id="L404">      List&lt;CoreLabel&gt; tokens = sentences.get(mention.sentNum - 1).get(CoreAnnotations.TokensAnnotation.class);</span>
<span class="nc" id="L405">      int contextStart = Math.max(mention.startIndex - 1 - 5, 0);</span>
<span class="nc" id="L406">      int contextEnd = Math.min(mention.endIndex - 1 + 5, tokens.size());</span>
<span class="nc" id="L407">      String leftContext = StringUtils.joinWords(tokens, &quot; &quot;, contextStart, mention.startIndex - 1);</span>
<span class="nc" id="L408">      String rightContext = StringUtils.joinWords(tokens, &quot; &quot;, mention.endIndex - 1, contextEnd);</span>
<span class="nc" id="L409">      setSingleElement(mentionElem, &quot;leftContext&quot;, curNS, leftContext);</span>
<span class="nc" id="L410">      setSingleElement(mentionElem, &quot;rightContext&quot;, curNS, rightContext);</span>
    }

<span class="nc" id="L413">    chainElem.appendChild(mentionElem);</span>
<span class="nc" id="L414">  }</span>

  private static void addWordInfo(Element wordInfo, CoreMap token, int id, String curNS) {
    // store the position of this word in the sentence
<span class="nc" id="L418">    wordInfo.addAttribute(new Attribute(&quot;id&quot;, Integer.toString(id)));</span>

<span class="nc" id="L420">    setSingleElement(wordInfo, &quot;word&quot;, curNS, token.get(CoreAnnotations.TextAnnotation.class));</span>
<span class="nc" id="L421">    setSingleElement(wordInfo, &quot;lemma&quot;, curNS, token.get(CoreAnnotations.LemmaAnnotation.class));</span>

<span class="nc bnc" id="L423" title="All 4 branches missed.">    if (token.containsKey(CoreAnnotations.CharacterOffsetBeginAnnotation.class) &amp;&amp; token.containsKey(CoreAnnotations.CharacterOffsetEndAnnotation.class)) {</span>
<span class="nc" id="L424">      setSingleElement(wordInfo, &quot;CharacterOffsetBegin&quot;, curNS, Integer.toString(token.get(CoreAnnotations.CharacterOffsetBeginAnnotation.class)));</span>
<span class="nc" id="L425">      setSingleElement(wordInfo, &quot;CharacterOffsetEnd&quot;, curNS, Integer.toString(token.get(CoreAnnotations.CharacterOffsetEndAnnotation.class)));</span>
    }

<span class="nc bnc" id="L428" title="All 2 branches missed.">    if (token.containsKey(CoreAnnotations.PartOfSpeechAnnotation.class)) {</span>
<span class="nc" id="L429">      setSingleElement(wordInfo, &quot;POS&quot;, curNS, token.get(CoreAnnotations.PartOfSpeechAnnotation.class));</span>
    }

<span class="nc bnc" id="L432" title="All 2 branches missed.">    if (token.containsKey(CoreAnnotations.NamedEntityTagAnnotation.class)) {</span>
<span class="nc" id="L433">      setSingleElement(wordInfo, &quot;NER&quot;, curNS, token.get(CoreAnnotations.NamedEntityTagAnnotation.class));</span>
    }

<span class="nc bnc" id="L436" title="All 2 branches missed.">    if (token.containsKey(CoreAnnotations.NormalizedNamedEntityTagAnnotation.class)) {</span>
<span class="nc" id="L437">      setSingleElement(wordInfo, &quot;NormalizedNER&quot;, curNS, token.get(CoreAnnotations.NormalizedNamedEntityTagAnnotation.class));</span>
    }

<span class="nc bnc" id="L440" title="All 2 branches missed.">    if (token.containsKey(CoreAnnotations.SpeakerAnnotation.class)) {</span>
<span class="nc" id="L441">      setSingleElement(wordInfo, &quot;Speaker&quot;, curNS, token.get(CoreAnnotations.SpeakerAnnotation.class));</span>
    }

<span class="nc bnc" id="L444" title="All 2 branches missed.">    if (token.containsKey(TimeAnnotations.TimexAnnotation.class)) {</span>
<span class="nc" id="L445">      Timex timex = token.get(TimeAnnotations.TimexAnnotation.class);</span>
<span class="nc" id="L446">      Element timexElem = new Element(&quot;Timex&quot;, curNS);</span>
<span class="nc" id="L447">      timexElem.addAttribute(new Attribute(&quot;tid&quot;, timex.tid()));</span>
<span class="nc" id="L448">      timexElem.addAttribute(new Attribute(&quot;type&quot;, timex.timexType()));</span>
<span class="nc" id="L449">      timexElem.appendChild(timex.value());</span>
<span class="nc" id="L450">      wordInfo.appendChild(timexElem);</span>
    }

<span class="nc bnc" id="L453" title="All 2 branches missed.">    if (token.containsKey(CoreAnnotations.TrueCaseAnnotation.class)) {</span>
<span class="nc" id="L454">      Element cur = new Element(&quot;TrueCase&quot;, curNS);</span>
<span class="nc" id="L455">      cur.appendChild(token.get(CoreAnnotations.TrueCaseAnnotation.class));</span>
<span class="nc" id="L456">      wordInfo.appendChild(cur);</span>
    }
<span class="nc bnc" id="L458" title="All 2 branches missed.">    if (token.containsKey(CoreAnnotations.TrueCaseTextAnnotation.class)) {</span>
<span class="nc" id="L459">      Element cur = new Element(&quot;TrueCaseText&quot;, curNS);</span>
<span class="nc" id="L460">      cur.appendChild(token.get(CoreAnnotations.TrueCaseTextAnnotation.class));</span>
<span class="nc" id="L461">      wordInfo.appendChild(cur);</span>
    }

<span class="nc bnc" id="L464" title="All 2 branches missed.">    if (token.containsKey(SentimentCoreAnnotations.SentimentClass.class)) {</span>
<span class="nc" id="L465">      Element cur = new Element(&quot;sentiment&quot;, curNS);</span>
<span class="nc" id="L466">      cur.appendChild(token.get(SentimentCoreAnnotations.SentimentClass.class));</span>
<span class="nc" id="L467">      wordInfo.appendChild(cur);</span>
    }

<span class="nc bnc" id="L470" title="All 2 branches missed.">    if (token.containsKey(CoreAnnotations.WikipediaEntityAnnotation.class)) {</span>
<span class="nc" id="L471">      Element cur = new Element(&quot;entitylink&quot;, curNS);</span>
<span class="nc" id="L472">      cur.appendChild(token.get(CoreAnnotations.WikipediaEntityAnnotation.class));</span>
<span class="nc" id="L473">      wordInfo.appendChild(cur);</span>
    }

//    IntTuple corefDest;
//    if((corefDest = label.get(CorefDestAnnotation.class)) != null){
//      Element cur = new Element(&quot;coref&quot;, curNS);
//      String value = Integer.toString(corefDest.get(0)) + &quot;.&quot; + Integer.toString(corefDest.get(1));
//      cur.setText(value);
//      wordInfo.addContent(cur);
//    }
<span class="nc" id="L483">  }</span>

  /**
   * Helper method for addWordInfo().  If the value is not null,
   * creates an element of the given name and namespace and adds it to the
   * tokenElement.
   *
   * @param tokenElement This is the element to which the newly created element will be added
   * @param elemName This is the name for the new XML element
   * @param curNS    The current namespace
   * @param value    This is its value
   */
  private static void setSingleElement(Element tokenElement, String elemName, String curNS, String value) {
<span class="nc bnc" id="L496" title="All 2 branches missed.">    if (value != null) {</span>
<span class="nc" id="L497">      Element cur = new Element(elemName, curNS);</span>
<span class="nc" id="L498">      cur.appendChild(value);</span>
<span class="nc" id="L499">      tokenElement.appendChild(cur);</span>
    }
<span class="nc" id="L501">  }</span>

  private static Element toXML(RelationTriple triple, String curNS) {
<span class="nc" id="L504">    Element top = new Element(&quot;triple&quot;, curNS);</span>
<span class="nc" id="L505">    top.addAttribute(new Attribute(&quot;confidence&quot;, triple.confidenceGloss()));</span>

    // Create the subject
<span class="nc" id="L508">    Element subject = new Element(&quot;subject&quot;, curNS);</span>
<span class="nc" id="L509">    subject.addAttribute(new Attribute(&quot;begin&quot;, Integer.toString(triple.subjectTokenSpan().first)));</span>
<span class="nc" id="L510">    subject.addAttribute(new Attribute(&quot;end&quot;, Integer.toString(triple.subjectTokenSpan().second)));</span>
<span class="nc" id="L511">    Element text = new Element(&quot;text&quot;, curNS);</span>
<span class="nc" id="L512">    text.appendChild(triple.subjectGloss());</span>
<span class="nc" id="L513">    Element lemma = new Element(&quot;lemma&quot;, curNS);</span>
<span class="nc" id="L514">    lemma.appendChild(triple.subjectLemmaGloss());</span>
<span class="nc" id="L515">    subject.appendChild(text);</span>
<span class="nc" id="L516">    subject.appendChild(lemma);</span>
<span class="nc" id="L517">    top.appendChild(subject);</span>

    // Create the relation
<span class="nc" id="L520">    Element relation = new Element(&quot;relation&quot;, curNS);</span>
<span class="nc" id="L521">    relation.addAttribute(new Attribute(&quot;begin&quot;, Integer.toString(triple.relationTokenSpan().first)));</span>
<span class="nc" id="L522">    relation.addAttribute(new Attribute(&quot;end&quot;, Integer.toString(triple.relationTokenSpan().second)));</span>
<span class="nc" id="L523">    text = new Element(&quot;text&quot;, curNS);</span>
<span class="nc" id="L524">    text.appendChild(triple.relationGloss());</span>
<span class="nc" id="L525">    lemma = new Element(&quot;lemma&quot;, curNS);</span>
<span class="nc" id="L526">    lemma.appendChild(triple.relationLemmaGloss());</span>
<span class="nc" id="L527">    relation.appendChild(text);</span>
<span class="nc" id="L528">    relation.appendChild(lemma);</span>
<span class="nc" id="L529">    top.appendChild(relation);</span>

    // Create the object
<span class="nc" id="L532">    Element object = new Element(&quot;object&quot;, curNS);</span>
<span class="nc" id="L533">    object.addAttribute(new Attribute(&quot;begin&quot;, Integer.toString(triple.objectTokenSpan().first)));</span>
<span class="nc" id="L534">    object.addAttribute(new Attribute(&quot;end&quot;, Integer.toString(triple.objectTokenSpan().second)));</span>
<span class="nc" id="L535">    text = new Element(&quot;text&quot;, curNS);</span>
<span class="nc" id="L536">    text.appendChild(triple.objectGloss());</span>
<span class="nc" id="L537">    lemma = new Element(&quot;lemma&quot;, curNS);</span>
<span class="nc" id="L538">    lemma.appendChild(triple.objectLemmaGloss());</span>
<span class="nc" id="L539">    object.appendChild(text);</span>
<span class="nc" id="L540">    object.appendChild(lemma);</span>
<span class="nc" id="L541">    top.appendChild(object);</span>

<span class="nc" id="L543">    return top;</span>
  }

  private static Element toXML(EntityMention entity, String curNS) {
<span class="nc" id="L547">    Element top = new Element(&quot;entity&quot;, curNS);</span>
<span class="nc" id="L548">    top.addAttribute(new Attribute(&quot;id&quot;, entity.getObjectId()));</span>
<span class="nc" id="L549">    Element type = new Element(&quot;type&quot;, curNS);</span>
<span class="nc" id="L550">    type.appendChild(entity.getType());</span>
<span class="nc" id="L551">    top.appendChild(entity.getType());</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">    if (entity.getNormalizedName() != null){</span>
<span class="nc" id="L553">      Element nm = new Element(&quot;normalized&quot;, curNS);</span>
<span class="nc" id="L554">      nm.appendChild(entity.getNormalizedName());</span>
<span class="nc" id="L555">      top.appendChild(nm);</span>
    }

<span class="nc bnc" id="L558" title="All 2 branches missed.">    if (entity.getSubType() != null){</span>
<span class="nc" id="L559">      Element subtype = new Element(&quot;subtype&quot;, curNS);</span>
<span class="nc" id="L560">      subtype.appendChild(entity.getSubType());</span>
<span class="nc" id="L561">      top.appendChild(subtype);</span>
    }
<span class="nc" id="L563">    Element span = new Element(&quot;span&quot;, curNS);</span>
<span class="nc" id="L564">    span.addAttribute(new Attribute(&quot;start&quot;, Integer.toString(entity.getHeadTokenStart())));</span>
<span class="nc" id="L565">    span.addAttribute(new Attribute(&quot;end&quot;, Integer.toString(entity.getHeadTokenEnd())));</span>
<span class="nc" id="L566">    top.appendChild(span);</span>

<span class="nc" id="L568">    top.appendChild(makeProbabilitiesElement(entity, curNS));</span>
<span class="nc" id="L569">    return top;</span>
  }


  private static Element toXML(RelationMention relation, String curNS) {
<span class="nc" id="L574">    Element top = new Element(&quot;relation&quot;, curNS);</span>
<span class="nc" id="L575">    top.addAttribute(new Attribute(&quot;id&quot;, relation.getObjectId()));</span>
<span class="nc" id="L576">    Element type = new Element(&quot;type&quot;, curNS);</span>
<span class="nc" id="L577">    type.appendChild(relation.getType());</span>
<span class="nc" id="L578">    top.appendChild(relation.getType());</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">    if (relation.getSubType() != null){</span>
<span class="nc" id="L580">      Element subtype = new Element(&quot;subtype&quot;, curNS);</span>
<span class="nc" id="L581">      subtype.appendChild(relation.getSubType());</span>
<span class="nc" id="L582">      top.appendChild(relation.getSubType());</span>
    }

<span class="nc" id="L585">    List&lt;EntityMention&gt; mentions = relation.getEntityMentionArgs();</span>
<span class="nc" id="L586">    Element args = new Element(&quot;arguments&quot;, curNS);</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">    for (EntityMention e : mentions) {</span>
<span class="nc" id="L588">      args.appendChild(toXML(e, curNS));</span>
<span class="nc" id="L589">    }</span>
<span class="nc" id="L590">    top.appendChild(args);</span>

<span class="nc" id="L592">    top.appendChild(makeProbabilitiesElement(relation, curNS));</span>
<span class="nc" id="L593">    return top;</span>
  }

  private static Element makeProbabilitiesElement(ExtractionObject object, String curNS) {
<span class="nc" id="L597">    Element probs = new Element(&quot;probabilities&quot;, curNS);</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">    if (object.getTypeProbabilities() != null){</span>
<span class="nc" id="L599">      List&lt;Pair&lt;String, Double&gt;&gt; sorted = Counters.toDescendingMagnitudeSortedListWithCounts(object.getTypeProbabilities());</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">      for(Pair&lt;String, Double&gt; lv: sorted) {</span>
<span class="nc" id="L601">        Element prob = new Element(&quot;probability&quot;, curNS);</span>
<span class="nc" id="L602">        Element label = new Element(&quot;label&quot;, curNS);</span>
<span class="nc" id="L603">        label.appendChild(lv.first);</span>
<span class="nc" id="L604">        Element value = new Element(&quot;value&quot;, curNS);</span>
<span class="nc" id="L605">        value.appendChild(lv.second.toString());</span>
<span class="nc" id="L606">        prob.appendChild(label);</span>
<span class="nc" id="L607">        prob.appendChild(value);</span>
<span class="nc" id="L608">        probs.appendChild(prob);</span>
<span class="nc" id="L609">      }</span>
    }
<span class="nc" id="L611">    return probs;</span>
  }

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>