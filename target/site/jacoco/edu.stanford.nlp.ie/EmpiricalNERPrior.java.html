<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmpiricalNERPrior.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Stanford CoreNLP</a> &gt; <a href="index.source.html" class="el_package">edu.stanford.nlp.ie</a> &gt; <span class="el_source">EmpiricalNERPrior.java</span></div><h1>EmpiricalNERPrior.java</h1><pre class="source lang-java linenums">package edu.stanford.nlp.ie; 
import edu.stanford.nlp.util.logging.Redwood;

import edu.stanford.nlp.util.CoreMap;
import edu.stanford.nlp.util.Index;

import java.util.List;


/** This was the empirical NER prior used for long distance consistency
 *  in the Finkel et al. ACL 2005 paper.
 *
 *  @author Jenny Finkel
 */

public class EmpiricalNERPrior&lt;IN extends CoreMap&gt; extends EntityCachingAbstractSequencePrior&lt;IN&gt;  {

  /** A logger for this class */
<span class="nc" id="L19">  private static Redwood.RedwoodChannels log = Redwood.channels(EmpiricalNERPrior.class);</span>

  protected static final String ORG = &quot;ORGANIZATION&quot;;
  protected static final String PER = &quot;PERSON&quot;;
  protected static final String LOC = &quot;LOCATION&quot;;
  protected static final String MISC = &quot;MISC&quot;;

  public EmpiricalNERPrior(String backgroundSymbol, Index&lt;String&gt; classIndex, List&lt;IN&gt; doc) {
<span class="nc" id="L27">    super(backgroundSymbol, classIndex, doc);</span>
<span class="nc" id="L28">  }</span>

<span class="nc" id="L30">  protected double p1 = -Math.log(0.01);</span>

<span class="nc" id="L32">  protected double dem1 = 6631.0;</span>
<span class="nc" id="L33">  protected double p2 = -Math.log(6436.0 / dem1)/2.0;</span>
<span class="nc" id="L34">  protected double p3 = -Math.log(188 / dem1)/2.0;</span>
<span class="nc" id="L35">  protected double p4 = -Math.log(4 / dem1)/2.0;</span>
<span class="nc" id="L36">  protected double p5 = -Math.log(3 / dem1)/2.0;</span>

<span class="nc" id="L38">  protected double dem2 = 3169.0;</span>
<span class="nc" id="L39">  protected double p6 = -Math.log(188.0 / dem2)/2.0;</span>
<span class="nc" id="L40">  protected double p7 = -Math.log(2975 / dem2)/2.0;</span>
<span class="nc" id="L41">  protected double p8 = -Math.log(5 / dem2)/2.0;</span>
<span class="nc" id="L42">  protected double p9 = -Math.log(1 / dem2)/2.0;</span>

<span class="nc" id="L44">  protected double dem3 = 3151.0;</span>
<span class="nc" id="L45">  protected double p10 = -Math.log(4.0 / dem3)/2.0;</span>
<span class="nc" id="L46">  protected double p11 = -Math.log(5 / dem3)/2.0;</span>
<span class="nc" id="L47">  protected double p12 = -Math.log(3141 / dem3)/2.0;</span>
<span class="nc" id="L48">  protected double p13 = -Math.log(1 / dem3)/2.0;</span>

<span class="nc" id="L50">  protected double dem4 = 2035.0;</span>
<span class="nc" id="L51">  protected double p14 = -Math.log(3.0 / dem4)/2.0;</span>
<span class="nc" id="L52">  protected double p15 = -Math.log(1 / dem4)/2.0;</span>
<span class="nc" id="L53">  protected double p16 = -Math.log(1 / dem4)/2.0;</span>
<span class="nc" id="L54">  protected double p17 = -Math.log(2030 / dem4)/2.0;</span>

<span class="nc" id="L56">  protected double dem5 = 724.0;</span>
<span class="nc" id="L57">  protected double p18 = -Math.log(167.0 / dem5);</span>
<span class="nc" id="L58">  protected double p19 = -Math.log(328.0 / dem5);</span>
<span class="nc" id="L59">  protected double p20 = -Math.log(5.0 / dem5);</span>
<span class="nc" id="L60">  protected double p21 = -Math.log(224.0 / dem5);</span>

<span class="nc" id="L62">  protected double dem6 = 834.0;</span>
<span class="nc" id="L63">  protected double p22 = -Math.log(6.0 / dem6);</span>
<span class="nc" id="L64">  protected double p23 = -Math.log(819.0 / dem6);</span>
<span class="nc" id="L65">  protected double p24 = -Math.log(2.0 / dem6);</span>
<span class="nc" id="L66">  protected double p25 = -Math.log(7.0 / dem6);</span>

<span class="nc" id="L68">  protected double dem7 = 1978.0;</span>
<span class="nc" id="L69">  protected double p26 = -Math.log(1.0 / dem7);</span>
<span class="nc" id="L70">  protected double p27 = -Math.log(22.0 / dem7);</span>
<span class="nc" id="L71">  protected double p28 = -Math.log(1941.0 / dem7);</span>
<span class="nc" id="L72">  protected double p29 = -Math.log(14.0 / dem7);</span>

<span class="nc" id="L74">  protected double dem8 = 622.0;</span>
<span class="nc" id="L75">  protected double p30 = -Math.log(63.0 / dem8);</span>
<span class="nc" id="L76">  protected double p31 = -Math.log(191.0 / dem8);</span>
<span class="nc" id="L77">  protected double p32 = -Math.log(3.0 / dem8);</span>
<span class="nc" id="L78">  protected double p33 = -Math.log(365.0 / dem8);</span>

  @SuppressWarnings(&quot;StringEquality&quot;)
  @Override
  public double scoreOf(int[] sequence) {
<span class="nc" id="L83">    double p = 0.0;</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">    for (int i = 0; i &lt; entities.length; i++) {</span>
<span class="nc" id="L85">      Entity entity = entities[i];</span>
      //log.info(entity);
<span class="nc bnc" id="L87" title="All 6 branches missed.">      if ((i == 0 || entities[i-1] != entity) &amp;&amp; entity != null) {</span>
        //log.info(1);
<span class="nc" id="L89">        int length = entity.words.size();</span>
<span class="nc" id="L90">        String tag1 = classIndex.get(entity.type);</span>

        // Use canonical String values, so we can henceforth just use ==
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (tag1.equals(LOC)) { tag1 = LOC; }</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        else if (tag1.equals(ORG)) { tag1 = ORG; }</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        else if (tag1.equals(PER)) { tag1 = PER; }</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        else if (tag1.equals(MISC)) { tag1 = MISC; }</span>

<span class="nc" id="L98">        int[] other = entities[i].otherOccurrences;</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        for (int otherOccurrence : other) {</span>

<span class="nc" id="L101">          Entity otherEntity = null;</span>
<span class="nc bnc" id="L102" title="All 4 branches missed.">          for (int k = otherOccurrence; k &lt; otherOccurrence + length &amp;&amp; k &lt; entities.length; k++) {</span>
<span class="nc" id="L103">            otherEntity = entities[k];</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (otherEntity != null) {</span>
//               if (k &gt; other[j]) {
//                 log.info(entity.words+&quot; &quot;+otherEntity.words);
//               }
<span class="nc" id="L108">              break;</span>
            }
          }
          // singleton + other instance null?
<span class="nc bnc" id="L112" title="All 2 branches missed.">          if (otherEntity == null) {</span>
            //p -= length * Math.log(0.1);
            //if (entity.words.size() == 1) {
            //p -= length * p1;
            //}
<span class="nc" id="L117">            continue;</span>
          }

<span class="nc" id="L120">          int oLength = otherEntity.words.size();</span>
<span class="nc" id="L121">          String tag2 = classIndex.get(otherEntity.type);</span>

          // Use canonical String values, so we can henceforth just use ==
<span class="nc bnc" id="L124" title="All 2 branches missed.">          if (tag2.equals(LOC)) {</span>
<span class="nc" id="L125">            tag2 = LOC;</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">          } else if (tag2.equals(ORG)) {</span>
<span class="nc" id="L127">            tag2 = ORG;</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">          } else if (tag2.equals(PER)) {</span>
<span class="nc" id="L129">            tag2 = PER;</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">          } else if (tag2.equals(MISC)) {</span>
<span class="nc" id="L131">            tag2 = MISC;</span>
          }

          // exact match??
<span class="nc" id="L135">          boolean exact = false;</span>
<span class="nc" id="L136">          int[] oOther = otherEntity.otherOccurrences;</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">          for (int index : oOther) {</span>
<span class="nc bnc" id="L138" title="All 4 branches missed.">            if (index &gt;= i &amp;&amp; index &lt;= i + length - 1) {</span>
<span class="nc" id="L139">              exact = true;</span>
<span class="nc" id="L140">              break;</span>
            }
          }

<span class="nc bnc" id="L144" title="All 2 branches missed.">          if (exact) {</span>
            // entity not complete
<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (length != oLength) {</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">              if (tag1 == (tag2)) {// || ((tag1 == LOC &amp;&amp; tag2 == ORG) || (tag1 == ORG &amp;&amp; tag2 == LOC))) { // ||</span>
                //p -= Math.abs(oLength - length) * Math.log(0.1);
<span class="nc" id="L149">                p -= Math.abs(oLength - length) * p1;</span>
<span class="nc bnc" id="L150" title="All 4 branches missed.">              } else if (!(tag1.equals(ORG) &amp;&amp; tag2.equals(LOC)) &amp;&amp;</span>
<span class="nc bnc" id="L151" title="All 4 branches missed.">                      !(tag2.equals(LOC) &amp;&amp; tag1.equals(ORG))) {</span>
                // shorter
<span class="nc" id="L153">                p -= (oLength + length) * p1;</span>
              }
            }
<span class="nc bnc" id="L156" title="All 2 branches missed.">            if (tag1 == (LOC)) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">              if (tag2 == (LOC)) {</span>
                //p -= length * Math.log(6436.0 / dem);
                //p -= length * p2;
<span class="nc bnc" id="L160" title="All 2 branches missed.">              } else if (tag2 == (ORG)) {</span>
                //p -= length * Math.log(188 / dem);
<span class="nc" id="L162">                p -= length * p3;</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">              } else if (tag2 == (PER)) {</span>
                //p -= length * Math.log(4 / dem);
<span class="nc" id="L165">                p -= length * p4;</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">              } else if (tag2 == (MISC)) {</span>
                //p -= length * Math.log(3 / dem);
<span class="nc" id="L168">                p -= length * p5;</span>
              }
<span class="nc bnc" id="L170" title="All 2 branches missed.">            } else if (tag1 == (ORG)) {</span>
              //double dem = 3169.0;
<span class="nc bnc" id="L172" title="All 2 branches missed.">              if (tag2 == (LOC)) {</span>
                //p -= length * Math.log(188.0 / dem);
<span class="nc" id="L174">                p -= length * p6;</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">              } else if (tag2 == (ORG)) {</span>
                //p -= length * Math.log(2975 / dem);
                //p -= length * p7;
<span class="nc bnc" id="L178" title="All 2 branches missed.">              } else if (tag2 == (PER)) {</span>
                //p -= length * Math.log(5 / dem);
<span class="nc" id="L180">                p -= length * p8;</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">              } else if (tag2 == (MISC)) {</span>
                //p -= length * Math.log(1 / dem);
<span class="nc" id="L183">                p -= length * p9;</span>
              }
<span class="nc bnc" id="L185" title="All 2 branches missed.">            } else if (tag1 == (PER)) {</span>
              //double dem = 3151.0;
<span class="nc bnc" id="L187" title="All 2 branches missed.">              if (tag2 == (LOC)) {</span>
                //p -= length * Math.log(4.0 / dem);
<span class="nc" id="L189">                p -= length * p10;</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">              } else if (tag2 == (ORG)) {</span>
                //p -= length * Math.log(5 / dem);
<span class="nc" id="L192">                p -= length * p11;</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">              } else if (tag2 == (PER)) {</span>
                //p -= length * Math.log(3141 / dem);
                //p -= length * p12;
<span class="nc bnc" id="L196" title="All 2 branches missed.">              } else if (tag2 == (MISC)) {</span>
                //p -= length * Math.log(1 / dem);
<span class="nc" id="L198">                p -= length * p13;</span>
              }
<span class="nc bnc" id="L200" title="All 2 branches missed.">            } else if (tag1 == (MISC)) {</span>
              //double dem = 2035.0;
<span class="nc bnc" id="L202" title="All 2 branches missed.">              if (tag2 == (LOC)) {</span>
                //p -= length * Math.log(3.0 / dem);
<span class="nc" id="L204">                p -= length * p14;</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">              } else if (tag2 == (ORG)) {</span>
                //p -= length * Math.log(1 / dem);
<span class="nc" id="L207">                p -= length * p15;</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">              } else if (tag2 == (PER)) {</span>
                //p -= length * Math.log(1 / dem);
<span class="nc" id="L210">                p -= length * p16;</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">              } else if (tag2 == (MISC)) {</span>
                //p -= length * Math.log(2030 / dem);
                //p -= length * p17;
              }
            }
          } else {
<span class="nc bnc" id="L217" title="All 2 branches missed.">            if (tag1 == (LOC)) {</span>
              //double dem = 724.0;
<span class="nc bnc" id="L219" title="All 2 branches missed.">              if (tag2 == (LOC)) {</span>
                //p -= length * Math.log(167.0 / dem);
                //p -= length * p18;
<span class="nc bnc" id="L222" title="All 2 branches missed.">              } else if (tag2 == (ORG)) {</span>
                //p -= length * Math.log(328.0 / dem);
                //p -= length * p19;
<span class="nc bnc" id="L225" title="All 2 branches missed.">              } else if (tag2 == (PER)) {</span>
                //p -= length * Math.log(5.0 / dem);
<span class="nc" id="L227">                p -= length * p20;</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">              } else if (tag2 == (MISC)) {</span>
                //p -= length * Math.log(224.0 / dem);
<span class="nc" id="L230">                p -= length * p21;</span>
              }
<span class="nc bnc" id="L232" title="All 2 branches missed.">            } else if (tag1 == (ORG)) {</span>
              //double dem = 834.0;
<span class="nc bnc" id="L234" title="All 2 branches missed.">              if (tag2 == (LOC)) {</span>
                //p -= length * Math.log(6.0 / dem);
<span class="nc" id="L236">                p -= length * p22;</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">              } else if (tag2 == (ORG)) {</span>
                //p -= length * Math.log(819.0 / dem);
                //p -= length * p23;
<span class="nc bnc" id="L240" title="All 2 branches missed.">              } else if (tag2 == (PER)) {</span>
                //p -= length * Math.log(2.0 / dem);
<span class="nc" id="L242">                p -= length * p24;</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">              } else if (tag2 == (MISC)) {</span>
                //p -= length * Math.log(7.0 / dem);
<span class="nc" id="L245">                p -= length * p25;</span>
              }
<span class="nc bnc" id="L247" title="All 2 branches missed.">            } else if (tag1 == (PER)) {</span>
              //double dem = 1978.0;
<span class="nc bnc" id="L249" title="All 2 branches missed.">              if (tag2 == (LOC)) {</span>
                //p -= length * Math.log(1.0 / dem);
<span class="nc" id="L251">                p -= length * p26;</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">              } else if (tag2 == (ORG)) {</span>
                //p -= length * Math.log(22.0 / dem);
<span class="nc" id="L254">                p -= length * p27;</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">              } else if (tag2 == (PER)) {</span>
                //p -= length * Math.log(1941.0 / dem);
                //p -= length * p28;
<span class="nc bnc" id="L258" title="All 2 branches missed.">              } else if (tag2 == (MISC)) {</span>
                //p -= length * Math.log(14.0 / dem);
<span class="nc" id="L260">                p -= length * p29;</span>
              }
<span class="nc bnc" id="L262" title="All 2 branches missed.">            } else if (tag1 == (MISC)) {</span>
              //double dem = 622.0;
<span class="nc bnc" id="L264" title="All 2 branches missed.">              if (tag2 == (LOC)) {</span>
                //p -= length * Math.log(63.0 / dem);
<span class="nc" id="L266">                p -= length * p30;</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">              } else if (tag2 == (ORG)) {</span>
                //p -= length * Math.log(191.0 / dem);
<span class="nc" id="L269">                p -= length * p31;</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">              } else if (tag2 == (PER)) {</span>
                //p -= length * Math.log(3.0 / dem);
<span class="nc" id="L272">                p -= length * p32;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">              } else if (tag2 == (MISC)) {</span>
                //p -= length * Math.log(365.0 / dem);
<span class="nc" id="L275">                p -= length * p33;</span>
              }
            }
          }

//           if (tag1 == PER) {
//             int personIndex = classIndex.indexOf(PER);
//             String lastName = entity.words.get(entity.words.size()-1);
//             for (int k = 0; k &lt; doc.size(); k++) {
//               String w = doc.get(k).word();
//               if (w.equalsIgnoreCase(lastName)) {
//                 if (sequence[k] != personIndex) {
//                   p -= p1;
//                 }
//               }
//             }
//           }
        }
      }
    }
<span class="nc" id="L295">    return p;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>