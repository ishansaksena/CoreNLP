<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JodaTimeUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Stanford CoreNLP</a> &gt; <a href="index.source.html" class="el_package">edu.stanford.nlp.time</a> &gt; <span class="el_source">JodaTimeUtils.java</span></div><h1>JodaTimeUtils.java</h1><pre class="source lang-java linenums">package edu.stanford.nlp.time;

import org.joda.time.*;
import org.joda.time.chrono.ISOChronology;
import org.joda.time.field.DividedDateTimeField;
import org.joda.time.field.OffsetDateTimeField;
import org.joda.time.field.RemainderDateTimeField;
import org.joda.time.field.ScaledDurationField;

import java.util.Set;

import static org.joda.time.DateTimeFieldType.*;
import static org.joda.time.DurationFieldType.*;

import edu.stanford.nlp.util.Generics;

/**
 * Extensions to Joda time.
 *
 * @author Angel Chang
 * @author Gabor Angeli
 */
<span class="pc bpc" id="L23" title="1 of 2 branches missed.">public class JodaTimeUtils {</span>

<span class="nc" id="L25">  private JodaTimeUtils() {} // static methods only</span>

  // Standard ISO fields
<span class="fc" id="L28">  protected static final Chronology isoUTCChronology = ISOChronology.getInstanceUTC();</span>
<span class="fc" id="L29">  protected static final DateTimeFieldType[] standardISOFields = {</span>
<span class="fc" id="L30">          DateTimeFieldType.year(),</span>
<span class="fc" id="L31">          DateTimeFieldType.monthOfYear(),</span>
<span class="fc" id="L32">          DateTimeFieldType.dayOfMonth(),</span>
<span class="fc" id="L33">          DateTimeFieldType.hourOfDay(),</span>
<span class="fc" id="L34">          DateTimeFieldType.minuteOfHour(),</span>
<span class="fc" id="L35">          DateTimeFieldType.secondOfMinute(),</span>
<span class="fc" id="L36">          DateTimeFieldType.millisOfSecond()</span>
  };
<span class="fc" id="L38">  protected static final DateTimeFieldType[] standardISOWeekFields = {</span>
<span class="fc" id="L39">          DateTimeFieldType.year(),  // should this be weekyear()?</span>
<span class="fc" id="L40">          DateTimeFieldType.weekOfWeekyear(),</span>
<span class="fc" id="L41">          DateTimeFieldType.dayOfWeek(),</span>
<span class="fc" id="L42">          DateTimeFieldType.hourOfDay(),</span>
<span class="fc" id="L43">          DateTimeFieldType.minuteOfHour(),</span>
<span class="fc" id="L44">          DateTimeFieldType.secondOfMinute(),</span>
<span class="fc" id="L45">          DateTimeFieldType.millisOfSecond()</span>
  };
<span class="fc" id="L47">  protected static final DateTimeFieldType[] standardISODateFields = {</span>
<span class="fc" id="L48">          DateTimeFieldType.year(),</span>
<span class="fc" id="L49">          DateTimeFieldType.monthOfYear(),</span>
<span class="fc" id="L50">          DateTimeFieldType.dayOfMonth(),</span>
  };
<span class="fc" id="L52">  protected static final DateTimeFieldType[] standardISOTimeFields = {</span>
<span class="fc" id="L53">          DateTimeFieldType.hourOfDay(),</span>
<span class="fc" id="L54">          DateTimeFieldType.minuteOfHour(),</span>
<span class="fc" id="L55">          DateTimeFieldType.secondOfMinute(),</span>
<span class="fc" id="L56">          DateTimeFieldType.millisOfSecond()</span>
  };
<span class="fc" id="L58">  public static final Partial EMPTY_ISO_PARTIAL = new Partial(standardISOFields, new int[]{0,1,1,0,0,0,0});</span>
<span class="fc" id="L59">  public static final Partial EMPTY_ISO_WEEK_PARTIAL = new Partial(standardISOWeekFields, new int[]{0,1,1,0,0,0,0});</span>
<span class="fc" id="L60">  public static final Partial EMPTY_ISO_DATE_PARTIAL = new Partial(standardISODateFields, new int[]{0,1,1});</span>
<span class="fc" id="L61">  public static final Partial EMPTY_ISO_TIME_PARTIAL = new Partial(standardISOTimeFields, new int[]{0,0,0,0});</span>
<span class="fc" id="L62">  public static final Instant INSTANT_ZERO = new Instant(0);</span>


  // Extensions to Joda time fields
  // Duration Fields
<span class="fc" id="L67">  public static final DurationFieldType Quarters = new DurationFieldType(&quot;quarters&quot;) {</span>
    private static final long serialVersionUID = -8167713675442491871L;

    public DurationField getField(Chronology chronology) {
<span class="fc" id="L71">      return new ScaledDurationField(chronology.months(), Quarters, 3);</span>
    }
  };

<span class="fc" id="L75">  public static final DurationFieldType HalfYears = new DurationFieldType(&quot;halfyear&quot;) {</span>
    private static final long serialVersionUID = -8167713675442491872L;

    public DurationField getField(Chronology chronology) {
<span class="nc" id="L79">      return new ScaledDurationField(chronology.months(), HalfYears, 6);</span>
    }
  };

<span class="fc" id="L83">  public static final DurationFieldType Decades = new DurationFieldType(&quot;decades&quot;) {</span>
    private static final long serialVersionUID = -4594189766036833410L;

    public DurationField getField(Chronology chronology) {
<span class="nc" id="L87">      return new ScaledDurationField(chronology.years(), Decades, 10);</span>
    }
  };

<span class="fc" id="L91">  public static final DurationFieldType Centuries = new DurationFieldType(&quot;centuries&quot;) {</span>
    private static final long serialVersionUID = -7268694266711862790L;

    public DurationField getField(Chronology chronology) {
<span class="nc" id="L95">      return new ScaledDurationField(chronology.years(), Centuries, 100);</span>
    }
  };

  // DateTimeFields
<span class="fc" id="L100">  public static final DateTimeFieldType QuarterOfYear = new DateTimeFieldType(&quot;quarterOfYear&quot;) {</span>
    private static final long serialVersionUID = -5677872459807379123L;

    public DurationFieldType getDurationType() {
<span class="fc" id="L104">      return Quarters;</span>
    }

    public DurationFieldType getRangeDurationType() {
<span class="fc" id="L108">      return DurationFieldType.years();</span>
    }

    public DateTimeField getField(Chronology chronology) {
<span class="fc" id="L112">      return new OffsetDateTimeField(new DividedDateTimeField(new OffsetDateTimeField(chronology.monthOfYear(), -1), QuarterOfYear, 3), 1);</span>
    }
  };

<span class="fc" id="L116">  public static final DateTimeFieldType HalfYearOfYear = new DateTimeFieldType(&quot;halfYearOfYear&quot;) {</span>
    private static final long serialVersionUID = -5677872459807379123L;

    public DurationFieldType getDurationType() {
<span class="nc" id="L120">      return HalfYears;</span>
    }

    public DurationFieldType getRangeDurationType() {
<span class="nc" id="L124">      return DurationFieldType.years();</span>
    }

    public DateTimeField getField(Chronology chronology) {
<span class="nc" id="L128">      return new OffsetDateTimeField(new DividedDateTimeField(new OffsetDateTimeField(chronology.monthOfYear(), -1), HalfYearOfYear, 6), 1);</span>
    }
  };

<span class="fc" id="L132">  public static final DateTimeFieldType MonthOfQuarter = new DateTimeFieldType(&quot;monthOfQuarter&quot;) {</span>
    private static final long serialVersionUID = -5677872459807379123L;

    public DurationFieldType getDurationType() {
<span class="nc" id="L136">      return DurationFieldType.months();</span>
    }

    public DurationFieldType getRangeDurationType() {
<span class="nc" id="L140">      return Quarters;</span>
    }

    public DateTimeField getField(Chronology chronology) {
<span class="nc" id="L144">      return new OffsetDateTimeField(new RemainderDateTimeField(new OffsetDateTimeField(chronology.monthOfYear(), -1), MonthOfQuarter, 3), 1);</span>
    }
  };

<span class="fc" id="L148">  public static final DateTimeFieldType MonthOfHalfYear = new DateTimeFieldType(&quot;monthOfHalfYear&quot;) {</span>
    private static final long serialVersionUID = -5677872459807379123L;

    public DurationFieldType getDurationType() {
<span class="nc" id="L152">      return DurationFieldType.months();</span>
    }

    public DurationFieldType getRangeDurationType() {
<span class="nc" id="L156">      return HalfYears;</span>
    }

    public DateTimeField getField(Chronology chronology) {
<span class="nc" id="L160">      return new OffsetDateTimeField(new RemainderDateTimeField(new OffsetDateTimeField(chronology.monthOfYear(), -1), MonthOfHalfYear, 6), 1);</span>
    }
  };

<span class="fc" id="L164">  public static final DateTimeFieldType WeekOfMonth = new DateTimeFieldType(&quot;weekOfMonth&quot;) {</span>
    private static final long serialVersionUID = 8676056306203579438L;

    public DurationFieldType getDurationType() {
<span class="nc" id="L168">      return DurationFieldType.weeks();</span>
    }

    public DurationFieldType getRangeDurationType() {
<span class="nc" id="L172">      return DurationFieldType.months();</span>
    }

    public DateTimeField getField(Chronology chronology) {
<span class="nc" id="L176">      return new OffsetDateTimeField(new RemainderDateTimeField(new OffsetDateTimeField(chronology.weekOfWeekyear(), -1), WeekOfMonth, 4), 1);</span>
    }
  };

<span class="fc" id="L180">  public static final DateTimeFieldType DecadeOfCentury = new DateTimeFieldType(&quot;decadeOfCentury&quot;) {</span>
    private static final long serialVersionUID = 4301444712229535664L;

    public DurationFieldType getDurationType() {
<span class="nc" id="L184">      return Decades;</span>
    }

    public DurationFieldType getRangeDurationType() {
<span class="nc" id="L188">      return DurationFieldType.centuries();</span>
    }

    public DateTimeField getField(Chronology chronology) {
<span class="nc" id="L192">      return new DividedDateTimeField(chronology.yearOfCentury(), DecadeOfCentury, 10);</span>
    }
  };

<span class="fc" id="L196">  public static final DateTimeFieldType YearOfDecade = new DateTimeFieldType(&quot;yearOfDecade&quot;) {</span>
    private static final long serialVersionUID = 4301444712229535664L;

    public DurationFieldType getDurationType() {
<span class="nc" id="L200">      return DurationFieldType.years();</span>
    }

    public DurationFieldType getRangeDurationType() {
<span class="nc" id="L204">      return Decades;</span>
    }

    public DateTimeField getField(Chronology chronology) {
<span class="nc" id="L208">      return new DividedDateTimeField(chronology.yearOfCentury(), YearOfDecade, 10);</span>
    }
  };

  // Helper functions for working with joda time type
  protected static boolean hasField(ReadablePartial base, DateTimeFieldType field)
  {
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">    if (base == null) {</span>
<span class="nc" id="L216">      return false;</span>
    } else {
<span class="fc" id="L218">      return base.isSupported(field);</span>
    }
  }

  protected static boolean hasYYYYMMDD(ReadablePartial base)
  {
<span class="nc bnc" id="L224" title="All 2 branches missed.">    if (base == null) {</span>
<span class="nc" id="L225">      return false;</span>
    } else {
<span class="nc bnc" id="L227" title="All 2 branches missed.">      return base.isSupported(DateTimeFieldType.year()) &amp;&amp;</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">             base.isSupported(DateTimeFieldType.monthOfYear()) &amp;&amp;</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">             base.isSupported(DateTimeFieldType.dayOfMonth());</span>
    }
  }

  protected static boolean hasYYMMDD(ReadablePartial base)
  {
<span class="nc bnc" id="L235" title="All 2 branches missed.">    if (base == null) {</span>
<span class="nc" id="L236">      return false;</span>
    } else {
<span class="nc bnc" id="L238" title="All 2 branches missed.">      return base.isSupported(DateTimeFieldType.yearOfCentury()) &amp;&amp;</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">             base.isSupported(DateTimeFieldType.monthOfYear()) &amp;&amp;</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">             base.isSupported(DateTimeFieldType.dayOfMonth());</span>
    }
  }

  protected static boolean hasField(ReadablePeriod base, DurationFieldType field)
  {
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">    if (base == null) {</span>
<span class="nc" id="L247">      return false;</span>
    } else {
<span class="fc" id="L249">      return base.isSupported(field);</span>
    }
  }

  protected static Partial setField(Partial base, DateTimeFieldType field, int value) {
<span class="fc bfc" id="L254" title="All 2 branches covered.">    if (base == null) {</span>
<span class="fc" id="L255">      return new Partial(field, value);</span>
    } else {
<span class="fc" id="L257">      return base.with(field, value);</span>
    }
  }

  public static Set&lt;DurationFieldType&gt; getSupportedDurationFields(Partial p)
  {
<span class="fc" id="L263">    Set&lt;DurationFieldType&gt; supportedDurations = Generics.newHashSet();</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">    for (int i = 0; i &lt; p.size(); i++) {</span>
<span class="fc" id="L265">      supportedDurations.add(p.getFieldType(i).getDurationType());</span>
    }
<span class="fc" id="L267">    return supportedDurations;</span>
  }
  public static Period getUnsupportedDurationPeriod(Partial p, Period offset)
  {
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">    if (offset == null) { return null; }</span>
<span class="fc" id="L272">    Set&lt;DurationFieldType&gt; supported = getSupportedDurationFields(p);</span>
<span class="fc" id="L273">    Period res = null;</span>
<span class="fc bfc" id="L274" title="All 2 branches covered.">    for (int i = 0; i &lt; offset.size(); i++) {</span>
<span class="fc bfc" id="L275" title="All 2 branches covered.">      if (!supported.contains(offset.getFieldType(i))) {</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">        if (offset.getValue(i) != 0) {</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">          if (res == null) { res = new Period(); }</span>
<span class="fc" id="L278">          res = res.withField(offset.getFieldType(i), offset.getValue(i));</span>
        }
      }
    }
<span class="fc" id="L282">    return res;</span>
  }
  public static Partial combine(Partial p1, Partial p2) {
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">    if (p1 == null) return p2;</span>
<span class="pc bpc" id="L286" title="1 of 2 branches missed.">    if (p2 == null) return p1;</span>
<span class="fc" id="L287">    Partial p = p1;</span>
<span class="fc bfc" id="L288" title="All 2 branches covered.">    for (int i = 0; i &lt; p2.size(); i++) {</span>
<span class="fc" id="L289">      DateTimeFieldType fieldType = p2.getFieldType(i);</span>
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">      if (fieldType == DateTimeFieldType.year()) {</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (p.isSupported(DateTimeFieldType.yearOfCentury())) {</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">          if (!p.isSupported(DateTimeFieldType.centuryOfEra())) {</span>
<span class="nc" id="L293">            int yoc = p.get(DateTimeFieldType.yearOfCentury());</span>
<span class="nc" id="L294">            int refYear = p2.getValue(i);</span>
<span class="nc" id="L295">            int century = refYear / 100;</span>
<span class="nc" id="L296">            int y2 = yoc + century*100;</span>
            // TODO: Figure out which way to go
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (refYear &lt; y2) {</span>
<span class="nc" id="L299">              y2 -= 100;</span>
            }
<span class="nc" id="L301">            p = p.without(DateTimeFieldType.yearOfCentury());</span>
<span class="nc" id="L302">            p = p.with(DateTimeFieldType.year(), y2);</span>
<span class="nc" id="L303">          }</span>
          continue;
<span class="nc bnc" id="L305" title="All 2 branches missed.">        } else if (p.isSupported(DateTimeFieldType.centuryOfEra())) {</span>
<span class="nc" id="L306">          continue;</span>
        }
<span class="pc bpc" id="L308" title="1 of 2 branches missed.">      } else if (fieldType == DateTimeFieldType.yearOfCentury()) {</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (p.isSupported(DateTimeFieldType.year())) {</span>
<span class="nc" id="L310">          continue;</span>
        }
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">      } else if (fieldType == DateTimeFieldType.centuryOfEra()) {</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">        if (p.isSupported(DateTimeFieldType.year())) {</span>
<span class="nc" id="L314">          continue;</span>
        }
      }
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">      if (!p.isSupported(fieldType)) {</span>
<span class="fc" id="L318">        p = p.with(fieldType, p2.getValue(i));</span>
      }
    }
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">    if (!p.isSupported(DateTimeFieldType.year())) {</span>
<span class="nc bnc" id="L322" title="All 4 branches missed.">      if (p.isSupported(DateTimeFieldType.yearOfCentury()) &amp;&amp; p.isSupported(DateTimeFieldType.centuryOfEra())) {</span>
<span class="nc" id="L323">        int year = p.get(DateTimeFieldType.yearOfCentury()) + p.get(DateTimeFieldType.centuryOfEra())*100;</span>
<span class="nc" id="L324">        p = p.with(DateTimeFieldType.year(), year);</span>
<span class="nc" id="L325">        p = p.without(DateTimeFieldType.yearOfCentury());</span>
<span class="nc" id="L326">        p = p.without(DateTimeFieldType.centuryOfEra());</span>
      }
    }
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">    if (p.isSupported(DateTimeFieldType.halfdayOfDay())) {</span>
<span class="nc" id="L330">      int hour = -1;</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">      if (p.isSupported(DateTimeFieldType.hourOfHalfday())) {</span>
<span class="nc" id="L332">        hour = p.get(DateTimeFieldType.hourOfHalfday());</span>
<span class="nc" id="L333">        p = p.without(DateTimeFieldType.hourOfHalfday());</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">      } else if (p.isSupported(DateTimeFieldType.clockhourOfHalfday())) {</span>
<span class="nc" id="L335">        hour = p.get(DateTimeFieldType.clockhourOfHalfday())-1;</span>
<span class="nc" id="L336">        p = p.without(DateTimeFieldType.clockhourOfHalfday());</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">      } else if (p.isSupported(DateTimeFieldType.clockhourOfDay())) {</span>
<span class="nc" id="L338">        hour = p.get(DateTimeFieldType.clockhourOfDay())-1;</span>
<span class="nc" id="L339">        p = p.without(DateTimeFieldType.clockhourOfDay());</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">      } else if (p.isSupported(DateTimeFieldType.hourOfDay())) {</span>
<span class="nc" id="L341">        hour = p.get(DateTimeFieldType.hourOfDay());</span>
<span class="nc" id="L342">        p = p.without(DateTimeFieldType.hourOfDay());</span>
      }
<span class="nc bnc" id="L344" title="All 2 branches missed.">      if (hour &gt;= 0) {</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (p.get(DateTimeFieldType.halfdayOfDay()) == SUTime.HALFDAY_PM) {</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">          if (hour &lt; 12) {</span>
<span class="nc" id="L347">            hour = hour+12;</span>
          }
<span class="nc bnc" id="L349" title="All 2 branches missed.">        } else if (hour == 12) {</span>
<span class="nc" id="L350">          hour = 0;</span>
        }
<span class="nc bnc" id="L352" title="All 2 branches missed.">        if (hour &lt; 24) {</span>
<span class="nc" id="L353">          p = p.with(DateTimeFieldType.hourOfDay(), hour);</span>
        } else {
<span class="nc" id="L355">          p = p.with(DateTimeFieldType.clockhourOfDay(), hour);</span>
        }
      }
    }
<span class="fc" id="L359">    return p;</span>
  }
  protected static DateTimeFieldType getMostGeneral(Partial p)
  {
<span class="nc bnc" id="L363" title="All 2 branches missed.">    if (p.size() &gt; 0) { return p.getFieldType(0); }</span>
<span class="nc" id="L364">    return null;</span>
  }
  protected static DateTimeFieldType getMostSpecific(Partial p)
  {
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">    if (p.size() &gt; 0) { return p.getFieldType(p.size()-1); }</span>
<span class="nc" id="L369">    return null;</span>
  }
  protected static DurationFieldType getMostGeneral(Period p)
  {
<span class="nc bnc" id="L373" title="All 2 branches missed.">    for (int i = 0; i &lt; p.size(); i++) {</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">      if (p.getValue(i) != 0) {</span>
<span class="nc" id="L375">        return p.getFieldType(i);</span>
      }
    }
<span class="nc" id="L378">    return null;</span>
  }
  protected static DurationFieldType getMostSpecific(Period p)
  {
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">    for (int i = p.size()-1; i &gt;= 0; i--) {</span>
<span class="fc bfc" id="L383" title="All 2 branches covered.">      if (p.getValue(i) != 0) {</span>
<span class="fc" id="L384">        return p.getFieldType(i);</span>
      }
    }
<span class="nc" id="L387">    return null;</span>
  }
  protected static Period getJodaTimePeriod(Partial p)
  {
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">    if (p.size() &gt; 0) {</span>
<span class="fc" id="L392">      DateTimeFieldType dtType = p.getFieldType(p.size()-1);</span>
<span class="fc" id="L393">      DurationFieldType dType = dtType.getDurationType();</span>
<span class="fc" id="L394">      Period period = new Period();</span>
<span class="fc bfc" id="L395" title="All 2 branches covered.">      if (period.isSupported(dType)) {</span>
<span class="fc" id="L396">       return period.withField(dType, 1);</span>
      } else {
<span class="fc" id="L398">        DurationField df = dType.getField(p.getChronology());</span>
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">        if (df instanceof ScaledDurationField) {</span>
<span class="fc" id="L400">          ScaledDurationField sdf = (ScaledDurationField) df;</span>
<span class="fc" id="L401">          return period.withField(sdf.getWrappedField().getType(), sdf.getScalar());</span>
        }
       // PeriodType.forFields(new DurationFieldType[]{dType});
       // return new Period(df.getUnitMillis(), PeriodType.forFields(new DurationFieldType[]{dType}));

      }
    }
<span class="nc" id="L408">    return null;</span>
  }
  public static Partial combineMoreGeneralFields(Partial p1, Partial p2) {
<span class="fc" id="L411">    return combineMoreGeneralFields(p1, p2, null);</span>
  }

  // Combines more general fields from p2 to p1
  public static Partial combineMoreGeneralFields(Partial p1, Partial p2, DateTimeFieldType mgf) {
<span class="fc" id="L416">    Partial p = p1;</span>
<span class="fc" id="L417">    Chronology c1 = p1.getChronology();</span>
<span class="fc" id="L418">    Chronology c2 = p2.getChronology();</span>
<span class="pc bpc" id="L419" title="1 of 2 branches missed.">    if (!c1.equals(c2)) {</span>
<span class="nc" id="L420">      throw new RuntimeException(&quot;Different chronology: c1=&quot; + c1 + &quot;, c2=&quot; + c2);</span>
    }
<span class="fc" id="L422">    DateTimeFieldType p1MostGeneralField = null;</span>
<span class="fc bfc" id="L423" title="All 2 branches covered.">    if (p1.size() &gt; 0) {</span>
<span class="fc" id="L424">      p1MostGeneralField = p1.getFieldType(0);    // Assume fields ordered from most general to least....</span>
    }
<span class="pc bpc" id="L426" title="3 of 6 branches missed.">    if (mgf == null || (p1MostGeneralField != null &amp;&amp; isMoreGeneral(p1MostGeneralField, mgf, c1))) {</span>
<span class="fc" id="L427">      mgf = p1MostGeneralField;</span>
    }
<span class="fc bfc" id="L429" title="All 2 branches covered.">    for (int i = 0; i &lt; p2.size(); i++) {</span>
<span class="fc" id="L430">      DateTimeFieldType fieldType = p2.getFieldType(i);</span>
<span class="fc bfc" id="L431" title="All 2 branches covered.">      if (fieldType == DateTimeFieldType.year()) {</span>
<span class="pc bpc" id="L432" title="1 of 2 branches missed.">        if (p.isSupported(DateTimeFieldType.yearOfCentury())) {</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">          if (!p.isSupported(DateTimeFieldType.centuryOfEra())) {</span>
<span class="nc" id="L434">            int yoc = p.get(DateTimeFieldType.yearOfCentury());</span>
<span class="nc" id="L435">            int refYear = p2.getValue(i);</span>
<span class="nc" id="L436">            int century = refYear / 100;</span>
<span class="nc" id="L437">            int y2 = yoc + century*100;</span>
            // TODO: Figure out which way to go
<span class="nc bnc" id="L439" title="All 2 branches missed.">            if (refYear &lt; y2) {</span>
<span class="nc" id="L440">              y2 -= 100;</span>
            }
<span class="nc" id="L442">            p = p.without(DateTimeFieldType.yearOfCentury());</span>
<span class="nc" id="L443">            p = p.with(DateTimeFieldType.year(), y2);</span>
<span class="nc" id="L444">          }</span>
          continue;
<span class="pc bpc" id="L446" title="1 of 2 branches missed.">        } else if (p.isSupported(JodaTimeUtils.DecadeOfCentury)) {</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">          if (!p.isSupported(DateTimeFieldType.centuryOfEra())) {</span>
<span class="nc" id="L448">            int decade = p.get(JodaTimeUtils.DecadeOfCentury);</span>
<span class="nc" id="L449">            int refYear = p2.getValue(i);</span>
<span class="nc" id="L450">            int century = refYear / 100;</span>
<span class="nc" id="L451">            int y2 = decade*10 + century*100;</span>
            // TODO: Figure out which way to go
<span class="nc bnc" id="L453" title="All 2 branches missed.">            if (refYear &lt; y2) {</span>
<span class="nc" id="L454">              century--;</span>
            }
<span class="nc" id="L456">            p = p.with(DateTimeFieldType.centuryOfEra(), century);</span>
<span class="nc" id="L457">          }</span>
          continue;
        }
      }
<span class="pc bpc" id="L461" title="1 of 4 branches missed.">      if (mgf == null || isMoreGeneral(fieldType, mgf, c1)) {</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">        if (!p.isSupported(fieldType)) {</span>
<span class="fc" id="L463">          p = p.with(fieldType, p2.getValue(i));</span>
        }
      } else {
        break;
      }
    }
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">    if (!p.isSupported(DateTimeFieldType.year())) {</span>
<span class="nc bnc" id="L470" title="All 4 branches missed.">      if (p.isSupported(DateTimeFieldType.yearOfCentury()) &amp;&amp; p.isSupported(DateTimeFieldType.centuryOfEra())) {</span>
<span class="nc" id="L471">        int year = p.get(DateTimeFieldType.yearOfCentury()) + p.get(DateTimeFieldType.centuryOfEra())*100;</span>
<span class="nc" id="L472">        p = p.with(DateTimeFieldType.year(), year);</span>
<span class="nc" id="L473">        p = p.without(DateTimeFieldType.yearOfCentury());</span>
<span class="nc" id="L474">        p = p.without(DateTimeFieldType.centuryOfEra());</span>
      }
    }
<span class="fc" id="L477">    return p;</span>
  }

  public static Partial discardMoreSpecificFields(Partial p, DateTimeFieldType d)
  {
<span class="fc" id="L482">    Partial res = new Partial();</span>
<span class="fc bfc" id="L483" title="All 2 branches covered.">    for (int i = 0; i &lt; p.size(); i++) {</span>
<span class="fc" id="L484">      DateTimeFieldType fieldType = p.getFieldType(i);</span>
<span class="fc bfc" id="L485" title="All 4 branches covered.">      if (fieldType.equals(d) || isMoreGeneral(fieldType, d, p.getChronology())) {</span>
<span class="fc" id="L486">        res = res.with(fieldType, p.getValue(i));</span>
      }
    }
<span class="pc bpc" id="L489" title="3 of 4 branches missed.">    if (res.isSupported(JodaTimeUtils.DecadeOfCentury) &amp;&amp; !res.isSupported(DateTimeFieldType.centuryOfEra())) {</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">      if (p.isSupported(DateTimeFieldType.year())) {</span>
<span class="nc" id="L491">        res = res.with(DateTimeFieldType.centuryOfEra(), p.get(DateTimeFieldType.year()) / 100);</span>
      }
    }
<span class="fc" id="L494">    return res;</span>
  }

  public static Partial discardMoreSpecificFields(Partial p, DurationFieldType dft)
  {
<span class="fc" id="L499">    DurationField df = dft.getField(p.getChronology());</span>
<span class="fc" id="L500">    Partial res = new Partial();</span>
<span class="fc bfc" id="L501" title="All 2 branches covered.">    for (int i = 0; i &lt; p.size(); i++) {</span>
<span class="fc" id="L502">      DateTimeFieldType fieldType = p.getFieldType(i);</span>
<span class="fc" id="L503">      DurationField f = fieldType.getDurationType().getField(p.getChronology());</span>
<span class="fc" id="L504">      int cmp = df.compareTo(f);</span>
<span class="fc bfc" id="L505" title="All 2 branches covered.">      if (cmp &lt;= 0) {</span>
<span class="fc" id="L506">        res = res.with(fieldType, p.getValue(i));</span>
      }
    }
<span class="fc" id="L509">    return res;</span>
  }

  public static Period discardMoreSpecificFields(Period p, DurationFieldType dft, Chronology chronology)
  {
<span class="fc" id="L514">    DurationField df = dft.getField(chronology);</span>
<span class="fc" id="L515">    Period res = new Period();</span>
<span class="fc bfc" id="L516" title="All 2 branches covered.">    for (int i = 0; i &lt; p.size(); i++) {</span>
<span class="fc" id="L517">      DurationFieldType fieldType = p.getFieldType(i);</span>
<span class="fc" id="L518">      DurationField f = fieldType.getField(chronology);</span>
<span class="fc" id="L519">      int cmp = df.compareTo(f);</span>
<span class="pc bpc" id="L520" title="1 of 2 branches missed.">      if (cmp &lt;= 0) {</span>
<span class="fc" id="L521">        res = res.withField(fieldType, p.getValue(i));</span>
      }
    }
<span class="fc" id="L524">    return res;</span>
  }

  public static Partial padMoreSpecificFields(Partial p, Period granularity)
  {
<span class="fc" id="L529">    DateTimeFieldType msf = getMostSpecific(p);</span>
<span class="pc bpc" id="L530" title="1 of 2 branches missed.">    if (isMoreGeneral(msf, DateTimeFieldType.year(), p.getChronology()) ||</span>
<span class="pc bpc" id="L531" title="1 of 2 branches missed.">            isMoreGeneral(msf, DateTimeFieldType.yearOfCentury(), p.getChronology())) {</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">      if (p.isSupported(DateTimeFieldType.yearOfCentury())) {</span>
        // OKAY
      } else {
<span class="nc bnc" id="L535" title="All 2 branches missed.">        if (p.isSupported(JodaTimeUtils.DecadeOfCentury)) {</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">          if (p.isSupported(DateTimeFieldType.centuryOfEra())) {</span>
<span class="nc" id="L537">            int year = p.get(DateTimeFieldType.centuryOfEra()) * 100 + p.get(JodaTimeUtils.DecadeOfCentury)*10;</span>
<span class="nc" id="L538">            p = p.without(JodaTimeUtils.DecadeOfCentury);</span>
<span class="nc" id="L539">            p = p.without(DateTimeFieldType.centuryOfEra());</span>
<span class="nc" id="L540">            p = p.with(DateTimeFieldType.year(), year);</span>
<span class="nc" id="L541">          } else {</span>
<span class="nc" id="L542">            int year = p.get(JodaTimeUtils.DecadeOfCentury)*10;</span>
<span class="nc" id="L543">            p = p.without(JodaTimeUtils.DecadeOfCentury);</span>
<span class="nc" id="L544">            p = p.with(DateTimeFieldType.yearOfCentury(), year);</span>
<span class="nc" id="L545">          }</span>
        } else {
<span class="nc bnc" id="L547" title="All 2 branches missed.">          if (p.isSupported(DateTimeFieldType.centuryOfEra())) {</span>
<span class="nc" id="L548">            int year = p.get(DateTimeFieldType.centuryOfEra()) * 100;</span>
<span class="nc" id="L549">            p = p.without(DateTimeFieldType.centuryOfEra());</span>
<span class="nc" id="L550">            p = p.with(DateTimeFieldType.year(), year);</span>
          }
        }
      }
    }
<span class="fc" id="L555">    boolean useWeek = false;</span>
<span class="fc bfc" id="L556" title="All 2 branches covered.">    if (p.isSupported(DateTimeFieldType.weekOfWeekyear())) {</span>
<span class="pc bpc" id="L557" title="2 of 4 branches missed.">      if (!p.isSupported(DateTimeFieldType.dayOfMonth()) &amp;&amp; !p.isSupported(DateTimeFieldType.dayOfWeek())) {</span>
<span class="fc" id="L558">        p = p.with(DateTimeFieldType.dayOfWeek(), 1);</span>
<span class="pc bpc" id="L559" title="1 of 2 branches missed.">        if (p.isSupported(DateTimeFieldType.monthOfYear())) {</span>
<span class="fc" id="L560">          p = p.without(DateTimeFieldType.monthOfYear());</span>
        }
      }
<span class="fc" id="L563">      useWeek = true;</span>
    }
<span class="fc bfc" id="L565" title="All 2 branches covered.">    Partial p2 = useWeek? EMPTY_ISO_WEEK_PARTIAL:EMPTY_ISO_PARTIAL;</span>
<span class="fc bfc" id="L566" title="All 2 branches covered.">    for (int i = 0; i &lt; p2.size(); i++) {</span>
<span class="fc" id="L567">      DateTimeFieldType fieldType = p2.getFieldType(i);</span>
<span class="pc bpc" id="L568" title="1 of 4 branches missed.">      if (msf == null || isMoreSpecific(fieldType, msf, p.getChronology())) {</span>
<span class="fc bfc" id="L569" title="All 2 branches covered.">        if (!p.isSupported(fieldType)) {</span>
<span class="fc bfc" id="L570" title="All 2 branches covered.">          if (fieldType == DateTimeFieldType.monthOfYear()) {</span>
<span class="fc bfc" id="L571" title="All 2 branches covered.">            if (p.isSupported(QuarterOfYear)) {</span>
<span class="fc" id="L572">              p = p.with(DateTimeFieldType.monthOfYear(), (p.get(QuarterOfYear)-1)*3+1);</span>
<span class="fc" id="L573">              continue;</span>
<span class="pc bpc" id="L574" title="1 of 2 branches missed.">            } else if (p.isSupported(HalfYearOfYear)) {</span>
<span class="nc" id="L575">              p = p.with(DateTimeFieldType.monthOfYear(), (p.get(HalfYearOfYear)-1)*6+1);</span>
<span class="nc" id="L576">              continue;</span>
            }
          }
<span class="fc" id="L579">          p = p.with(fieldType, p2.getValue(i));</span>
        }
      }
    }
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">    if (granularity != null) {</span>
<span class="fc" id="L584">      DurationFieldType mostSpecific = getMostSpecific(granularity);</span>
<span class="fc" id="L585">      p = discardMoreSpecificFields(p, mostSpecific);</span>
    }
<span class="fc" id="L587">    return p;</span>
  }

  public static boolean isCompatible(Partial p1, Partial p2) {
<span class="pc bpc" id="L591" title="1 of 2 branches missed.">    if (p1 == null) return true;</span>
<span class="pc bpc" id="L592" title="1 of 2 branches missed.">    if (p2 == null) return true;</span>
<span class="fc bfc" id="L593" title="All 2 branches covered.">    for (int i = 0; i &lt; p1.size(); i++) {</span>
<span class="fc" id="L594">      DateTimeFieldType type = p1.getFieldType(i);</span>
<span class="fc" id="L595">      int v = p1.getValue(i);</span>
<span class="fc bfc" id="L596" title="All 2 branches covered.">      if (JodaTimeUtils.hasField(p2,type)) {</span>
<span class="pc bpc" id="L597" title="1 of 2 branches missed.">        if (v != p2.get(type)) {</span>
<span class="nc" id="L598">          return false;</span>
        }
      }
    }
<span class="fc" id="L602">    return true;</span>
  }
  // Uses p2 to resolve dow for p1
  public static Partial resolveDowToDay(Partial p1, Partial p2)
  {
    // Discard anything that's more specific than dayOfMonth for p2
<span class="fc" id="L608">    p2 = JodaTimeUtils.discardMoreSpecificFields(p2, DateTimeFieldType.dayOfMonth());</span>
<span class="pc bpc" id="L609" title="1 of 2 branches missed.">    if (isCompatible(p1,p2)) {</span>
<span class="pc bpc" id="L610" title="1 of 2 branches missed.">      if (p1.isSupported(DateTimeFieldType.dayOfWeek())) {</span>
<span class="pc bpc" id="L611" title="1 of 2 branches missed.">        if (!p1.isSupported(DateTimeFieldType.dayOfMonth())) {</span>
<span class="pc bpc" id="L612" title="3 of 6 branches missed.">          if (p2.isSupported(DateTimeFieldType.dayOfMonth()) &amp;&amp; p2.isSupported(DateTimeFieldType.monthOfYear()) &amp;&amp; p2.isSupported(DateTimeFieldType.year())) {</span>
<span class="fc" id="L613">            Instant t2 = getInstant(p2);</span>
<span class="fc" id="L614">            DateTime t1 = p1.toDateTime(t2);</span>
<span class="fc" id="L615">            return getPartial(t1.toInstant(), p1.with(DateTimeFieldType.dayOfMonth(), 1)/*.with(DateTimeFieldType.weekOfWeekyear(), 1) */);</span>
          }
        }
      }
    }
<span class="nc" id="L620">    return p1;</span>
  }

  public static Partial withWeekYear(Partial p)
  {
<span class="fc" id="L625">    Partial res = new Partial();</span>
<span class="fc bfc" id="L626" title="All 2 branches covered.">    for (int i = 0; i &lt; p.size(); i++) {</span>
<span class="fc" id="L627">      DateTimeFieldType fieldType = p.getFieldType(i);</span>
<span class="fc bfc" id="L628" title="All 2 branches covered.">      if (fieldType == DateTimeFieldType.year()) {</span>
<span class="fc" id="L629">        res = res.with(DateTimeFieldType.weekyear(), p.getValue(i));</span>
      } else {
<span class="fc" id="L631">        res = res.with(fieldType, p.getValue(i));</span>
      }
    }
<span class="fc" id="L634">    return res;</span>
  }

  // Resolve dow for p1
  public static Partial resolveDowToDay(Partial p)
  {
<span class="pc bpc" id="L640" title="1 of 2 branches missed.">    if (p.isSupported(DateTimeFieldType.dayOfWeek())) {</span>
<span class="fc bfc" id="L641" title="All 2 branches covered.">      if (!p.isSupported(DateTimeFieldType.dayOfMonth())) {</span>
<span class="pc bpc" id="L642" title="2 of 4 branches missed.">        if (p.isSupported(DateTimeFieldType.weekOfWeekyear()) &amp;&amp; (p.isSupported(DateTimeFieldType.year()))) {</span>
          // Convert from year to weekyear (to avoid weirdness when the weekyear and year don't match at the beginning of the year)
<span class="fc" id="L644">          Partial pwy = withWeekYear(p);</span>
<span class="fc" id="L645">          Instant t2 = getInstant(pwy);</span>
<span class="fc" id="L646">          DateTime t1 = pwy.toDateTime(t2);</span>
<span class="fc" id="L647">          Partial res = getPartial(t1.toInstant(), EMPTY_ISO_PARTIAL);</span>
<span class="fc" id="L648">          DateTimeFieldType mostSpecific = getMostSpecific(p);</span>
<span class="fc" id="L649">          res = discardMoreSpecificFields(res, mostSpecific.getDurationType());</span>
<span class="fc" id="L650">          return res;</span>
        }
      }
    }
<span class="fc" id="L654">    return p;</span>
  }

  // Uses p2 to resolve week for p1
  public static Partial resolveWeek(Partial p1, Partial p2)
  {
<span class="nc bnc" id="L660" title="All 2 branches missed.">    if (isCompatible(p1,p2)) {</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">        if (!p1.isSupported(DateTimeFieldType.dayOfMonth())) {</span>
<span class="nc bnc" id="L662" title="All 6 branches missed.">          if (p2.isSupported(DateTimeFieldType.dayOfMonth()) &amp;&amp; p2.isSupported(DateTimeFieldType.monthOfYear()) &amp;&amp; p2.isSupported(DateTimeFieldType.year())) {</span>
<span class="nc" id="L663">            Instant t2 = getInstant(p2);</span>
<span class="nc" id="L664">            DateTime t1 = p1.toDateTime(t2);</span>
<span class="nc" id="L665">            return getPartial(t1.toInstant(), p1.without(DateTimeFieldType.dayOfMonth()).without(DateTimeFieldType.monthOfYear()).with(DateTimeFieldType.weekOfWeekyear(), 1));</span>
          }
      }
    }
<span class="nc" id="L669">    return p1;</span>
  }
  public static Partial resolveWeek(Partial p)
  {
    // Figure out week
<span class="nc bnc" id="L674" title="All 6 branches missed.">    if (p.isSupported(DateTimeFieldType.dayOfMonth()) &amp;&amp; p.isSupported(DateTimeFieldType.monthOfYear()) &amp;&amp; p.isSupported(DateTimeFieldType.year())) {</span>
<span class="nc" id="L675">      Instant t = getInstant(p);</span>
//      return getPartial(t.toInstant(), p.without(DateTimeFieldType.dayOfMonth()).without(DateTimeFieldType.monthOfYear()).with(DateTimeFieldType.weekOfWeekyear(), 1));
<span class="nc" id="L677">      return getPartial(t.toInstant(), p.with(DateTimeFieldType.weekOfWeekyear(), 1));</span>
<span class="nc" id="L678">    } else return p;</span>
  }

  public static Instant getInstant(Partial p)
  {
<span class="fc bfc" id="L683" title="All 2 branches covered.">    if (p == null) return null;</span>
<span class="fc bfc" id="L684" title="All 2 branches covered.">    int year = p.isSupported(DateTimeFieldType.year())? p.get(DateTimeFieldType.year()):0;</span>
<span class="fc bfc" id="L685" title="All 2 branches covered.">    if (!p.isSupported(DateTimeFieldType.year())) {</span>
<span class="pc bpc" id="L686" title="1 of 2 branches missed.">      if (p.isSupported(DateTimeFieldType.centuryOfEra())) {</span>
<span class="nc" id="L687">        year += 100*p.get(DateTimeFieldType.centuryOfEra());</span>
      }
<span class="pc bpc" id="L689" title="1 of 2 branches missed.">      if (p.isSupported(DateTimeFieldType.yearOfCentury())) {</span>
<span class="nc" id="L690">        year += p.get(DateTimeFieldType.yearOfCentury());</span>
<span class="pc bpc" id="L691" title="1 of 2 branches missed.">      } else if (p.isSupported(DecadeOfCentury)) {</span>
<span class="nc" id="L692">        year += 10*p.get(DecadeOfCentury);</span>
      }
    }
<span class="fc bfc" id="L695" title="All 2 branches covered.">    int moy = p.isSupported(DateTimeFieldType.monthOfYear())? p.get(DateTimeFieldType.monthOfYear()):1;</span>
<span class="fc bfc" id="L696" title="All 2 branches covered.">    if (!p.isSupported(DateTimeFieldType.monthOfYear())) {</span>
<span class="pc bpc" id="L697" title="1 of 2 branches missed.">      if (p.isSupported(QuarterOfYear)) {</span>
<span class="nc" id="L698">        moy += 3*(p.get(QuarterOfYear)-1);</span>
      }
    }
<span class="fc bfc" id="L701" title="All 2 branches covered.">    int dom = p.isSupported(DateTimeFieldType.dayOfMonth())? p.get(DateTimeFieldType.dayOfMonth()):1;</span>
<span class="fc bfc" id="L702" title="All 2 branches covered.">    int hod = p.isSupported(DateTimeFieldType.hourOfDay())? p.get(DateTimeFieldType.hourOfDay()):0;</span>
<span class="fc bfc" id="L703" title="All 2 branches covered.">    int moh = p.isSupported(DateTimeFieldType.minuteOfHour())? p.get(DateTimeFieldType.minuteOfHour()):0;</span>
<span class="fc bfc" id="L704" title="All 2 branches covered.">    int som = p.isSupported(DateTimeFieldType.secondOfMinute())? p.get(DateTimeFieldType.secondOfMinute()):0;</span>
<span class="fc bfc" id="L705" title="All 2 branches covered.">    int msos = p.isSupported(DateTimeFieldType.millisOfSecond())? p.get(DateTimeFieldType.millisOfSecond()):0;</span>
<span class="fc" id="L706">    return new DateTime(year, moy, dom, hod, moh, som, msos, isoUTCChronology).toInstant();</span>
  }

  public static Partial getPartial(Instant t, Partial p)
  {
<span class="fc" id="L711">    Partial res = new Partial(p);</span>
<span class="fc bfc" id="L712" title="All 2 branches covered.">    for (int i = 0; i &lt; p.size(); i++) {</span>
<span class="fc" id="L713">      res = res.withField(p.getFieldType(i), t.get(p.getFieldType(i)));</span>
    }
<span class="fc" id="L715">    return res;</span>
  }

  // Add duration to partial
  public static Partial addForce(Partial p, Period d, int scalar)
  {
<span class="fc" id="L721">    Instant t = getInstant(p);</span>
<span class="fc" id="L722">    t = t.withDurationAdded(d.toDurationFrom(INSTANT_ZERO), scalar);</span>
<span class="fc" id="L723">    return getPartial(t, p);</span>
  }

  // Returns if df1 is more general than df2
  public static boolean isMoreGeneral(DateTimeFieldType df1, DateTimeFieldType df2, Chronology chronology)
  {
<span class="fc" id="L729">    DurationFieldType df1DurationFieldType = df1.getDurationType();</span>
<span class="fc" id="L730">    DurationFieldType df2DurationFieldType = df2.getDurationType();</span>
<span class="fc bfc" id="L731" title="All 2 branches covered.">    if (!df2DurationFieldType.equals(df1DurationFieldType)) {</span>
<span class="fc" id="L732">      DurationField df1Unit = df1DurationFieldType.getField(chronology);</span>
<span class="fc" id="L733">      DurationFieldType p = df2.getRangeDurationType();</span>
<span class="fc bfc" id="L734" title="All 2 branches covered.">      if (p != null) {</span>
<span class="fc" id="L735">        DurationField df2Unit = df2DurationFieldType.getField(chronology);</span>
<span class="fc" id="L736">        int cmp = df1Unit.compareTo(df2Unit);</span>
<span class="fc bfc" id="L737" title="All 2 branches covered.">        if (cmp &gt; 0) {</span>
<span class="fc" id="L738">          return true;</span>
        }
      }
    }
<span class="fc" id="L742">    return false;</span>
  }

  // Returns if df1 is more specific than df2
  public static boolean isMoreSpecific(DateTimeFieldType df1, DateTimeFieldType df2, Chronology chronology)
  {
<span class="fc" id="L748">    DurationFieldType df1DurationFieldType = df1.getDurationType();</span>
<span class="fc" id="L749">    DurationFieldType df2DurationFieldType = df2.getDurationType();</span>
<span class="fc bfc" id="L750" title="All 2 branches covered.">    if (!df2DurationFieldType.equals(df1DurationFieldType)) {</span>
<span class="fc" id="L751">      DurationField df2Unit = df2DurationFieldType.getField(chronology);</span>
<span class="fc" id="L752">      DurationFieldType p = df1.getRangeDurationType();</span>
<span class="fc bfc" id="L753" title="All 2 branches covered.">      if (p != null) {</span>
<span class="fc" id="L754">        DurationField df1Unit = df1DurationFieldType.getField(chronology);</span>
<span class="fc" id="L755">        int cmp = df1Unit.compareTo(df2Unit);</span>
<span class="fc bfc" id="L756" title="All 2 branches covered.">        if (cmp &lt; 0) {</span>
<span class="fc" id="L757">          return true;</span>
        }
      }
    }
<span class="fc" id="L761">    return false;</span>
  }

  private static String zeroPad(int value, int padding){
<span class="nc" id="L765">    StringBuilder b = new StringBuilder();</span>
<span class="nc" id="L766">    b.append(value);</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">    while(b.length() &lt; padding){</span>
<span class="nc" id="L768">      b.insert(0,&quot;0&quot;);</span>
    }
<span class="nc" id="L770">    return b.toString();</span>
  }

  private static boolean noFurtherFields(DateTimeFieldType smallestFieldSet, ReadableDateTime begin, ReadableDateTime end){
    //--Get Indices
    //(standard fields)
<span class="nc" id="L776">    int indexInStandard = -1;</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">    for(int i=0; i&lt;standardISOFields.length; i++){</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">      if(standardISOFields[i] == smallestFieldSet){</span>
<span class="nc" id="L779">        indexInStandard = i+1;</span>
      }
    }
    //(week-based fields)
<span class="nc" id="L783">    int indexInWeek = -1;</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">    for(int i=0; i&lt;standardISOWeekFields.length; i++){</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">      if(standardISOWeekFields[i] == smallestFieldSet){</span>
<span class="nc" id="L786">        indexInWeek = i+1;</span>
      }
    }
    //(special fields)
<span class="nc bnc" id="L790" title="All 2 branches missed.">    if(smallestFieldSet == QuarterOfYear){</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">      for(int i=0; i&lt;standardISOFields.length; i++){</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">        if(standardISOFields[i] == monthOfYear()){</span>
<span class="nc" id="L793">          indexInStandard = i;</span>
        }
      }
    }
    //(get data)
<span class="nc" id="L798">    int index = -1;</span>
<span class="nc" id="L799">    DateTimeFieldType[] toCheck = null;</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">    if(indexInStandard &gt;= 0){</span>
<span class="nc" id="L801">      index = indexInStandard;</span>
<span class="nc" id="L802">      toCheck = standardISOFields;</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">    } else if(indexInWeek &gt;= 0){</span>
<span class="nc" id="L804">        index = indexInWeek;</span>
<span class="nc" id="L805">        toCheck = standardISOWeekFields;</span>
    } else {
<span class="nc" id="L807">      throw new IllegalArgumentException(&quot;Field is not in my list of fields: &quot; + smallestFieldSet);</span>
    }
    //--Perform Check
<span class="nc bnc" id="L810" title="All 2 branches missed.">    for(int i=index; i&lt;toCheck.length; i++){</span>
<span class="nc" id="L811">      int minValue = minimumValue(toCheck[i], begin) ;</span>
<span class="nc bnc" id="L812" title="All 4 branches missed.">      if(begin.get(toCheck[i]) != minValue || end.get(toCheck[i]) != minValue){</span>
<span class="nc" id="L813">        return false;</span>
      }
    }
<span class="nc" id="L816">    return true;</span>
  }

  /**
   * Return the minimum value of a field, closest to the reference time
   */
  public static int minimumValue(DateTimeFieldType type, ReadableDateTime reference){
<span class="nc" id="L823">    return reference.toDateTime().property(type).getMinimumValue();</span>
  }
  /**
   * Return the maximum value of a field, closest to the reference time
   */
  public static int maximumValue(DateTimeFieldType type, ReadableDateTime reference){
<span class="nc" id="L829">    return reference.toDateTime().property(type).getMaximumValue();</span>
  }

  /**
   * Return the TIMEX string for the time given
   */
  public static String timexTimeValue(ReadableDateTime time){
<span class="nc" id="L836">    return String.valueOf(time.getYear()) + '-' + zeroPad(time.getMonthOfYear(), 2) + '-' + zeroPad(time.getDayOfMonth(), 2) + 'T' + zeroPad(time.getHourOfDay(), 2) + ':' + zeroPad(time.getMinuteOfHour(), 2);</span>
  }

<span class="nc" id="L839">  public static class ConversionOptions{</span>
    /**
     * If true, give a &quot;best guess&quot; of the right date; if false, backoff to giving a duration
     * for malformed dates.
     */
<span class="nc" id="L844">    public boolean forceDate = false;</span>
    /**
     * Force particular units -- e.g., force 20Y to be 20Y (20 years) rather than 2E (2 decades)
     */
<span class="nc" id="L848">    public String[] forceUnits = new String[0];</span>
    /**
     * Treat durations as approximate
     */
<span class="nc" id="L852">    public boolean approximate = false;</span>
  }

  public static String timexDateValue(ReadableDateTime begin, ReadableDateTime end){
<span class="nc" id="L856">    return timexDateValue(begin,end,new ConversionOptions());</span>
  }

  /**
   * Return the TIMEX string for the range of dates given.
   * For example, (2011-12-3:00:00,000 to 2011-12-4:00:00.000) would give 2011-12-3.
   * @param begin The begin time for the timex
   * @param end The end time for the timex
   * @param opts Tweaks in the heuristic conversion
   * @return The string representation of a DATE type Timex3 expression
   */
  public static String timexDateValue(ReadableDateTime begin, ReadableDateTime end, ConversionOptions opts){
    //--Special Cases
<span class="nc bnc" id="L869" title="All 2 branches missed.">    if( begin.getYear() &lt; -100000){</span>
<span class="nc" id="L870">      return &quot;PAST_REF&quot;;</span>
<span class="nc bnc" id="L871" title="All 2 branches missed.">    } else if(end.getYear() &gt; 100000){</span>
<span class="nc" id="L872">      return &quot;FUTURE_REF&quot;;</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">    } else if(begin.equals(end)){</span>
<span class="nc" id="L874">      return timexTimeValue(begin);</span>
    }
<span class="nc" id="L876">    StringBuilder value = new StringBuilder();</span>
<span class="nc" id="L877">    boolean shouldBeDone = false;</span>
    //--Differences
<span class="nc" id="L879">    int monthDiff = (end.getMonthOfYear() - begin.getMonthOfYear()) + (end.getYear()-begin.getYear())*12;</span>
<span class="nc" id="L880">    int weekDiff = end.getWeekOfWeekyear()-begin.getWeekOfWeekyear() + (end.getYear()-begin.getYear())*maximumValue(weekOfWeekyear(),begin);</span>
<span class="nc" id="L881">    int dayDiff = end.getDayOfMonth()-begin.getDayOfMonth() + monthDiff*maximumValue(dayOfMonth(),begin);</span>
<span class="nc" id="L882">    int hrDiff = end.getHourOfDay()-begin.getHourOfDay() + dayDiff*24;</span>
<span class="nc" id="L883">    int minDiff = end.getMinuteOfHour()-begin.getMinuteOfHour() + hrDiff*60;</span>
<span class="nc" id="L884">    int secDiff = end.getSecondOfMinute()-begin.getSecondOfMinute() + minDiff*60;</span>
    //--Years
<span class="nc bnc" id="L886" title="All 2 branches missed.">    if(noFurtherFields(year(), begin, end)){</span>
<span class="nc" id="L887">      int diff = end.getYear()-begin.getYear();</span>
<span class="nc bnc" id="L888" title="All 6 branches missed.">      if(diff == 100 &amp;&amp; (opts.forceDate || begin.getYear() % 100 == 0)){</span>
        //(case: century)
<span class="nc" id="L890">        value.append(( begin.getYear() / 100)).append(&quot;XX&quot;);</span>
<span class="nc bnc" id="L891" title="All 6 branches missed.">      } else if(diff == 10 &amp;&amp; (opts.forceDate || begin.getYear() % 10 == 0)){</span>
        //(case: decade)
<span class="nc" id="L893">        value.append(( begin.getYear() / 10));</span>
<span class="nc bnc" id="L894" title="All 4 branches missed.">      } else if(diff == 1 || opts.forceDate){</span>
        //(case: year)
<span class="nc" id="L896">        value.append(begin.getYear());</span>
      } else {
        //(case: duration)
<span class="nc" id="L899">        return timexDurationValue(begin,end);</span>
      }
<span class="nc" id="L901">      return value.toString();</span>
<span class="nc bnc" id="L902" title="All 4 branches missed.">    } else if(monthDiff &lt; 12 || opts.forceDate) {</span>
      //(case: year and more)
<span class="nc" id="L904">      value.append(begin.getYear());</span>
    } else {
      //(case: treat as duration)
<span class="nc" id="L907">      return timexDurationValue(begin, end);</span>
    }
    //--Week/Month/Quarters
<span class="nc" id="L910">    value.append(&quot;-&quot;);</span>
<span class="nc bnc" id="L911" title="All 4 branches missed.">    if(noFurtherFields(monthOfYear(), begin, end) || noFurtherFields(weekOfWeekyear(), begin, end)){</span>
<span class="nc" id="L912">      boolean monthTerminal = noFurtherFields(monthOfYear(), begin, end);</span>
<span class="nc" id="L913">      boolean weekTerminal = noFurtherFields(weekOfWeekyear(), begin, end);</span>
      //(Month/Quarter)
<span class="nc bnc" id="L915" title="All 6 branches missed.">      if(monthTerminal &amp;&amp; monthDiff == 6 &amp;&amp; (begin.getMonthOfYear()-1) % 6 == 0){</span>
        //(case: half of year)
<span class="nc" id="L917">        value.append(&quot;H&quot;).append(( begin.getMonthOfYear()-1) / 6 + 1);</span>
<span class="nc bnc" id="L918" title="All 6 branches missed.">      } else if(monthTerminal &amp;&amp; monthDiff == 3 &amp;&amp; (begin.getMonthOfYear()-1) % 3 == 0){</span>
        //(case: quarter of year)
<span class="nc" id="L920">        value.append(&quot;Q&quot;).append(( begin.getMonthOfYear()-1) / 3 + 1);</span>
<span class="nc bnc" id="L921" title="All 6 branches missed.">      } else if(monthTerminal &amp;&amp; monthDiff == 3 &amp;&amp; begin.getMonthOfYear() % 3 == 0){</span>
        //(case: season)
<span class="nc bnc" id="L923" title="All 5 branches missed.">        switch( begin.getMonthOfYear() ){</span>
          case 12:
<span class="nc" id="L925">            value.append(&quot;WI&quot;);</span>
<span class="nc" id="L926">            break;</span>
          case 3:
<span class="nc" id="L928">            value.append(&quot;SP&quot;);</span>
<span class="nc" id="L929">            break;</span>
          case 6:
<span class="nc" id="L931">            value.append(&quot;SU&quot;);</span>
<span class="nc" id="L932">            break;</span>
          case 9:
<span class="nc" id="L934">            value.append(&quot;FA&quot;);</span>
<span class="nc" id="L935">            break;</span>
          default:
<span class="nc" id="L937">            throw new IllegalStateException(&quot;Season start month is unknown&quot;);</span>
        }
<span class="nc bnc" id="L939" title="All 4 branches missed.">      } else if(weekTerminal &amp;&amp; weekDiff == 1) {</span>
        //(case: a week)
<span class="nc" id="L941">        value.append(&quot;W&quot;).append(zeroPad(begin.getWeekOfWeekyear(), 2));</span>
<span class="nc bnc" id="L942" title="All 8 branches missed.">      } else if(monthTerminal &amp;&amp; monthDiff == 1 &amp;&amp; weekDiff != 1 || opts.forceDate) {</span>
        //(case: a month)
<span class="nc" id="L944">        value.append( zeroPad(begin.getMonthOfYear(),2) );</span>
      } else {
        //(case: treat as duration)
<span class="nc" id="L947">        return timexDurationValue(begin, end);</span>
      }
<span class="nc" id="L949">      return value.toString();</span>
<span class="nc bnc" id="L950" title="All 6 branches missed.">    } else if(noFurtherFields(dayOfWeek(), begin, end) &amp;&amp; dayDiff == 2 &amp;&amp; begin.getDayOfWeek() == 6){</span>
      //(case: a weekend)
<span class="nc" id="L952">      value.append(&quot;W&quot;).append(zeroPad(begin.getWeekOfWeekyear(),2)).append(&quot;-WE&quot;);</span>
<span class="nc" id="L953">      return value.toString();</span>
<span class="nc bnc" id="L954" title="All 4 branches missed.">    } else if(dayDiff &lt; maximumValue(dayOfMonth(),begin) || opts.forceDate) {</span>
      //(case: month and more)
<span class="nc" id="L956">      value.append(zeroPad(begin.getMonthOfYear(),2));</span>
    } else {
      //(case: treat as duration)
<span class="nc" id="L959">      return timexDurationValue(begin, end);</span>
    }
    //--Weekday/Day
<span class="nc" id="L962">    value.append(&quot;-&quot;);</span>
<span class="nc bnc" id="L963" title="All 2 branches missed.">    if(noFurtherFields(dayOfMonth(), begin, end)){</span>
<span class="nc bnc" id="L964" title="All 4 branches missed.">      if(dayDiff == 1 || opts.forceDate){</span>
        //(case: a day)
<span class="nc" id="L966">        value.append(zeroPad(begin.getDayOfMonth(),2));</span>
      } else {
        //(case: treat as duration)
<span class="nc" id="L969">        return timexDurationValue(begin, end);</span>
      }
<span class="nc" id="L971">      return value.toString();</span>
<span class="nc bnc" id="L972" title="All 4 branches missed.">    } else if(hrDiff &lt; 24 || opts.forceDate){</span>
      //(case: day and more)
<span class="nc" id="L974">      value.append(zeroPad(begin.getDayOfMonth(),2));</span>
    } else {
      //(case: treat as duration)
<span class="nc" id="L977">      return timexDurationValue(begin, end);</span>
    }
    //--Hour/TimeOfDay
<span class="nc" id="L980">    value.append(&quot;T&quot;);</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">    if(noFurtherFields(hourOfDay(),begin,end)){</span>
      //((case: half day)
<span class="nc bnc" id="L983" title="All 4 branches missed.">      if(hrDiff == 12 &amp;&amp; begin.getHourOfDay() == 0){</span>
<span class="nc" id="L984">        value.append(&quot;H1&quot;);</span>
<span class="nc bnc" id="L985" title="All 4 branches missed.">      } else if(hrDiff == 12 &amp;&amp; begin.getHourOfDay() == 12){</span>
<span class="nc" id="L986">        value.append(&quot;H2&quot;);</span>
      //(case: time of day)
<span class="nc bnc" id="L988" title="All 4 branches missed.">      }else if(hrDiff == 4 &amp;&amp; begin.getHourOfDay() == 8){</span>
<span class="nc" id="L989">        value.append(&quot;MO&quot;);</span>
<span class="nc bnc" id="L990" title="All 4 branches missed.">      }else if(hrDiff == 4 &amp;&amp; begin.getHourOfDay() == 12){</span>
<span class="nc" id="L991">        value.append(&quot;AF&quot;);</span>
<span class="nc bnc" id="L992" title="All 4 branches missed.">      }else if(hrDiff == 4 &amp;&amp; begin.getHourOfDay() == 16){</span>
<span class="nc" id="L993">        value.append(&quot;EV&quot;);</span>
<span class="nc bnc" id="L994" title="All 4 branches missed.">      }else if(hrDiff == 4 &amp;&amp; begin.getHourOfDay() == 20){</span>
<span class="nc" id="L995">        value.append(&quot;NI&quot;);</span>
<span class="nc bnc" id="L996" title="All 4 branches missed.">      } else if(hrDiff == 1 || opts.forceDate){</span>
        //(case: an hour)
<span class="nc" id="L998">        value.append(zeroPad(begin.getHourOfDay()+1,2));</span>
      } else {
        //(case: treat as duration)
<span class="nc" id="L1001">        return timexDurationValue(begin,end);</span>
      }
<span class="nc" id="L1003">      return value.toString();</span>
<span class="nc bnc" id="L1004" title="All 4 branches missed.">    } else if(minDiff &lt;= 60 || opts.forceDate){</span>
      //(case: hour and more)
<span class="nc" id="L1006">      value.append(zeroPad(begin.getHourOfDay(),2));</span>
    } else {
      //(case: treat as duration)
<span class="nc" id="L1009">      return timexDurationValue(begin, end);</span>
    }
    //--Minute/Second
<span class="nc" id="L1012">    value.append(&quot;:&quot;);</span>
<span class="nc" id="L1013">    value.append(zeroPad(begin.getMinuteOfHour(),2));</span>
<span class="nc" id="L1014">    return value.toString();</span>
  }

  private static boolean consistentWithForced(String cand, String[] forcedList){
    //--Check If Forced
<span class="nc bnc" id="L1019" title="All 2 branches missed.">    for(String forced : forcedList){</span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">      if(forced.equals(cand)){ return true; }</span>
    }
    //--Get Ordering
<span class="nc" id="L1023">    String[] ordering = {&quot;L&quot;,&quot;C&quot;,&quot;E&quot;,&quot;Y&quot;,&quot;Q&quot;,&quot;M&quot;,&quot;W&quot;,&quot;D&quot;,&quot;H&quot;,&quot;m&quot;,&quot;S&quot;};</span>
<span class="nc" id="L1024">    int candIndex = -1;</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">    for(int i=0; i&lt;ordering.length; i++){</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">      if(ordering[i].equals(cand)){</span>
<span class="nc" id="L1027">        candIndex = i;</span>
<span class="nc" id="L1028">        break;</span>
      }
    }
<span class="nc bnc" id="L1031" title="All 4 branches missed.">    assert candIndex &gt;= 0;</span>
    //--Check If Lower Priority Forced
<span class="nc bnc" id="L1033" title="All 2 branches missed.">    for(int candI=candIndex+1; candI &lt; ordering.length; candI++){</span>
<span class="nc bnc" id="L1034" title="All 2 branches missed.">      for(String forced : forcedList){</span>
<span class="nc bnc" id="L1035" title="All 2 branches missed.">        if(ordering[candI].equals(forced)){</span>
<span class="nc" id="L1036">          return false;</span>
        }
      }
    }
    //--OK
<span class="nc" id="L1041">    return true;</span>
  }

  /**
   * Return the TIMEX string for the duration represented by the given period; approximately if
   * approximate is set to true.
   * @param duration The JodaTime period representing this duration
   * @param opts Options for the conversion (e.g., mark duration as approximates)
   * @return The string representation of a DURATION type Timex3 expression
   */
  public static String timexDurationValue(ReadablePeriod duration, ConversionOptions opts){
<span class="nc" id="L1052">    StringBuilder b = new StringBuilder().append(&quot;P&quot;);</span>
<span class="nc" id="L1053">    boolean seenTime = false;</span>
<span class="nc" id="L1054">    int years = duration.get(years());</span>
    //(millenia)
<span class="nc bnc" id="L1056" title="All 4 branches missed.">    if(years &gt;= 1000 &amp;&amp; consistentWithForced(&quot;L&quot;,opts.forceUnits)){</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">      b.append(opts.approximate ? &quot;X&quot; : years / 1000).append(&quot;L&quot;);</span>
<span class="nc" id="L1058">      years = years % 1000;</span>
    }
    //(centuries)
<span class="nc bnc" id="L1061" title="All 4 branches missed.">    if(years &gt;= 100 &amp;&amp; consistentWithForced(&quot;C&quot;, opts.forceUnits)){</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">      b.append(opts.approximate ? &quot;X&quot; : years / 100).append(&quot;C&quot;);</span>
<span class="nc" id="L1063">      years = years % 100;</span>
    }
    //(decades)
<span class="nc bnc" id="L1066" title="All 4 branches missed.">    if(years &gt;= 10 &amp;&amp; consistentWithForced(&quot;E&quot;, opts.forceUnits)){</span>
<span class="nc bnc" id="L1067" title="All 2 branches missed.">      b.append(opts.approximate ? &quot;X&quot; : years / 10).append(&quot;E&quot;);</span>
<span class="nc" id="L1068">      years = years % 10;</span>
    }
    //(years)
<span class="nc bnc" id="L1071" title="All 4 branches missed.">    if(years != 0 &amp;&amp; consistentWithForced(&quot;Y&quot;, opts.forceUnits)){</span>
<span class="nc bnc" id="L1072" title="All 2 branches missed.">      b.append(opts.approximate ? &quot;X&quot; : years).append(&quot;Y&quot;);</span>
    }
    //(months)
<span class="nc" id="L1075">    int months = duration.get(months());</span>
<span class="nc bnc" id="L1076" title="All 2 branches missed.">    if(months != 0){</span>
<span class="nc bnc" id="L1077" title="All 4 branches missed.">      if(months % 3 == 0 &amp;&amp; consistentWithForced(&quot;Q&quot;, opts.forceUnits)){</span>
<span class="nc bnc" id="L1078" title="All 2 branches missed.">        b.append(opts.approximate ? &quot;X&quot; : months / 3).append(&quot;Q&quot;);</span>
<span class="nc" id="L1079">        months = months % 3;</span>
      } else {
<span class="nc bnc" id="L1081" title="All 2 branches missed.">        b.append(opts.approximate ? &quot;X&quot; : months).append(&quot;M&quot;);</span>
      }
    }
    //(weeks)
<span class="nc bnc" id="L1085" title="All 2 branches missed.">    if(duration.get(weeks()) != 0){</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">      b.append(opts.approximate ? &quot;X&quot; : duration.get(weeks())).append(&quot;W&quot;);</span>
    }
    //(days)
<span class="nc bnc" id="L1089" title="All 2 branches missed.">    if(duration.get(days()) != 0){</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">      b.append(opts.approximate ? &quot;X&quot; : duration.get(days())).append(&quot;D&quot;);</span>
    }
    //(hours)
<span class="nc bnc" id="L1093" title="All 2 branches missed.">    if(duration.get(hours()) != 0){</span>
<span class="nc bnc" id="L1094" title="All 2 branches missed.">      if(!seenTime){ b.append(&quot;T&quot;); seenTime = true; }</span>
<span class="nc bnc" id="L1095" title="All 2 branches missed.">      b.append(opts.approximate ? &quot;X&quot; : duration.get(hours())).append(&quot;H&quot;);</span>
    }
    //(minutes)
<span class="nc bnc" id="L1098" title="All 2 branches missed.">    if(duration.get(minutes()) != 0){</span>
<span class="nc bnc" id="L1099" title="All 2 branches missed.">      if(!seenTime){ b.append(&quot;T&quot;); seenTime = true; }</span>
<span class="nc bnc" id="L1100" title="All 2 branches missed.">      b.append(opts.approximate ? &quot;X&quot; : duration.get(minutes())).append(&quot;M&quot;);</span>
    }
    //(seconds)
<span class="nc bnc" id="L1103" title="All 2 branches missed.">    if(duration.get(seconds()) != 0){</span>
<span class="nc bnc" id="L1104" title="All 2 branches missed.">      if(!seenTime){ b.append(&quot;T&quot;); seenTime = true; }</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">      b.append(opts.approximate ? &quot;X&quot; : duration.get(seconds())).append(&quot;S&quot;);</span>
    }
<span class="nc" id="L1107">    return b.toString();</span>
  }
<span class="nc" id="L1109">  public static String timexDurationValue(ReadablePeriod duration){ return timexDurationValue(duration, new ConversionOptions()); }</span>

  /**
   * Return the TIMEX string for the difference between two dates
   * TODO not really sure if this works...
   */
  public static String timexDurationValue(ReadableDateTime begin, ReadableDateTime end){
<span class="nc" id="L1116">    return timexDurationValue( new Period(end.getMillis()-begin.getMillis()) );</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>